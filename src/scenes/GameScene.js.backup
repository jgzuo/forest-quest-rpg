/**
 * GameScene - ä¸»æ¸¸æˆåœºæ™¯
 * åŒ…å«æ¸¸æˆçš„æ ¸å¿ƒé€»è¾‘ï¼šç©å®¶æ§åˆ¶ã€åœºæ™¯ç®¡ç†ã€æˆ˜æ–—ç³»ç»Ÿç­‰
 * @version 2.1 - ä¿®å¤åœºæ™¯åˆ‡æ¢é¢‘é—ª + æ·»åŠ æ¸²æŸ“ç¼“å­˜æ›´æ–°
 */
class GameScene extends Phaser.Scene {
    constructor() {
        super({ key: 'GameScene' });
    }

    create() {
        console.log('ğŸ® GameScene åˆå§‹åŒ– v2.2 (æ”¯æŒç²¾çµåŠ¨ç”»)');

        // ============ æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜DOMå…ƒç´  ============
        this.cachedDOMElements = {
            levelText: null,
            goldText: null,
            hpBar: null,
            hpBarFill: null,
            xpBar: null,
            xpBarFill: null
        };

        // ============ åˆå§‹åŒ–ç»Ÿè®¡è¿½è¸ª ============
        // è®°å½•æœ¬æ¬¡ä¼šè¯å¼€å§‹æ—¶é—´
        if (window.gameData && window.gameData.progress) {
            window.gameData.progress.sessionStartTime = Date.now();
            window.gameData.progress.lastPlaytimeUpdate = Date.now(); // ç”¨äºèŠ‚æµ
            console.log('â±ï¸ ç»Ÿè®¡è¿½è¸ªå·²å¯åŠ¨');
        }

        // ============ åˆå§‹åŒ–å­˜æ¡£ç®¡ç†å™¨ ============
        this.saveManager = new SaveManager(this);

        // ============ åˆå§‹åŒ–å¯¹è±¡æ±  - Milestone 6 Iteration 5+ ============
        this.objectPool = new ObjectPool(this);
        console.log('ğŸ± å¯¹è±¡æ± å·²åˆå§‹åŒ–');

        // ============ åˆå§‹åŒ–æˆ˜æ–—ç³»ç»Ÿ - Code Refactoring ============
        this.combatSystem = new CombatSystem(this);
        console.log('âš”ï¸ æˆ˜æ–—ç³»ç»Ÿå·²åˆå§‹åŒ–');

        // ============ åˆå§‹åŒ–å•†åº—ç®¡ç†å™¨ ============
        this.shopManager = new ShopManager(this);

        // ============ åˆå§‹åŒ–ç‰©å“æ ç³»ç»Ÿ - Milestone 6.6 ============
        this.inventory = new Inventory(this);

        // ============ Milestone 7 Sprint 5: åˆå§‹åŒ–äºŒå‘¨ç›®ç³»ç»Ÿ ============
        this.newGamePlusManager = new NewGamePlusManager(this);
        this.newGamePlusManager.loadNewGamePlusStatus();

        // ============ åˆå§‹åŒ–ä»»åŠ¡ç®¡ç†å™¨ ============
        this.questManager = new QuestManager(this);

        // è®¾ç½®ä»»åŠ¡äº‹ä»¶ç›‘å¬
        this.setupQuestEvents();

        // ============ åˆå§‹åŒ–éŸ³é¢‘ç®¡ç†å™¨ ============
        this.audioManager = new AudioManager(this);

        // ============ åˆå§‹åŒ–æˆå°±ç®¡ç†å™¨ ============
        this.achievementManager = new AchievementManager(this);
        this.achievementManager.loadAchievements();

        // ============ åˆå§‹åŒ–æ•…äº‹ç®¡ç†å™¨ - Milestone 7 ============
        this.storyManager = new StoryManager(this);
        this.storyManager.loadSaveData(window.gameData?.storyData);

        // ============ åˆå§‹åŒ–å¯¹è¯ç®¡ç†å™¨ - Milestone 7 ============
        this.dialogueManager = new DialogueManager(this);
        this.dialogueManager.loadSaveData(window.gameData?.dialogueData);

        // ============ æ£€æŸ¥æ˜¯å¦å­˜åœ¨å­˜æ¡£ ============
        this.checkSaveData();

        // ============ åˆå§‹åŒ–åœºæ™¯ç®¡ç†å™¨ ============
        this.sceneManager = new SceneManager(this);

        // ============ åˆ›å»ºç©å®¶åŠ¨ç”» ============
        this.createPlayerAnimations();

        // ============ åˆ›å»ºç©å®¶ ============
        this.createPlayer();

        // ============ åˆå§‹åŒ–èµ„æºç®¡ç†å™¨ (HP/MP) - Milestone 6 ============
        this.resourceManager = new ResourceManager(this);

        // ============ åˆå§‹åŒ–æŠ€èƒ½ç³»ç»Ÿ - Milestone 6 ============
        this.skillSystem = new SkillSystem(this);

        // ============ Milestone 6.5: åˆå§‹åŒ–è¿å‡»ç³»ç»Ÿ ============
        this.comboSystem = new ComboSystem(this);

        // ============ Milestone 7: åˆå§‹åŒ–æˆ˜æ–—æ·±åº¦ç³»ç»Ÿ ============
        this.damageTypeManager = new DamageTypeManager(this);
        this.statusEffectSystem = new StatusEffectSystem(this);

        // ============ Milestone 7 Sprint 3: åˆå§‹åŒ–è£…å¤‡å’ŒæŠ€èƒ½æ ‘ç³»ç»Ÿ ============
        this.equipmentManager = new EquipmentManager(this);
        this.skillTreeManager = new SkillTreeManager(this);

        // ============ Milestone 7 Sprint 5: åˆå§‹åŒ–ç»ˆå±€å†…å®¹ç³»ç»Ÿ ============
        this.bossRushManager = new BossRushManager(this);
        this.bossRushManager.loadRecords();

        this.infiniteDungeonManager = new InfiniteDungeonManager(this);
        this.infiniteDungeonManager.loadRecords();

        this.arenaManager = new ArenaManager(this);
        this.arenaManager.loadRecords();

        // ============ Milestone 7 Sprint 6: åˆå§‹åŒ–UI/UXç³»ç»Ÿ ============
        this.tutorialManager = new TutorialManager(this);
        this.tutorialManager.loadProgress();

        // ============ åŠ è½½åˆå§‹åœºæ™¯ï¼ˆå°é•‡ï¼‰============
        this.sceneManager.loadScene('town');

        // ============ è®¾ç½®é”®ç›˜è¾“å…¥ ============
        this.setupControls();

        // ============ åˆå§‹åŒ–UI ============
        this.initUI();

        // ============ æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯ ============
        this.showWelcomeMessage();

        console.log('âœ… GameScene åˆ›å»ºå®Œæˆ v2.2');
    }

    createPlayerAnimations() {
        // å‘å‰èµ°åŠ¨ç”»
        this.anims.create({
            key: 'walk-front',
            frames: this.anims.generateFrameNumbers('hero-walk-front', { start: 0, end: 5 }),
            frameRate: 10,
            repeat: -1
        });

        // å‘åèµ°åŠ¨ç”»
        this.anims.create({
            key: 'walk-back',
            frames: this.anims.generateFrameNumbers('hero-walk-back', { start: 0, end: 5 }),
            frameRate: 10,
            repeat: -1
        });

        // ä¾§é¢èµ°åŠ¨ç”»
        this.anims.create({
            key: 'walk-side',
            frames: this.anims.generateFrameNumbers('hero-walk-side', { start: 0, end: 5 }),
            frameRate: 10,
            repeat: -1
        });

        // å‘å‰æ”»å‡»åŠ¨ç”»
        this.anims.create({
            key: 'attack-front',
            frames: this.anims.generateFrameNumbers('hero-attack-front', { start: 0, end: 2 }),
            frameRate: 15,  // æ”»å‡»åŠ¨ç”»ç¨å¿«
            repeat: 0       // åªæ’­æ”¾ä¸€æ¬¡
        });

        // å‘åæ”»å‡»åŠ¨ç”»
        this.anims.create({
            key: 'attack-back',
            frames: this.anims.generateFrameNumbers('hero-attack-back', { start: 0, end: 2 }),
            frameRate: 15,
            repeat: 0
        });

        // ä¾§é¢æ”»å‡»åŠ¨ç”»
        this.anims.create({
            key: 'attack-side',
            frames: this.anims.generateFrameNumbers('hero-attack-side', { start: 0, end: 2 }),
            frameRate: 15,
            repeat: 0
        });
    }

    createPlayer() {
        // åˆ›å»ºç©å®¶ç²¾çµ
        this.player = this.physics.add.sprite(400, 300, 'hero-idle-front');
        this.player.setScale(3);
        this.player.setCollideWorldBounds(true);

        // ç©å®¶å±æ€§ï¼ˆå¢å¼ºç‰ˆ - æå‡ç”Ÿå­˜èƒ½åŠ›ï¼‰
        this.player.hp = 200;          // ä»100å¢åŠ åˆ°200ï¼ˆç¿»å€ï¼‰
        this.player.maxHp = 200;       // ä»100å¢åŠ åˆ°200ï¼ˆç¿»å€ï¼‰
        this.player.xp = 0;
        this.player.level = 1;
        this.player.xpToNextLevel = 100;
        this.player.attack = 30;       // ä»20å¢åŠ åˆ°30ï¼ˆæå‡50%ï¼‰
        this.player.speed = 150;
        this.player.gold = 100;

        // ============ v1.9.3: æˆ˜æ–—å±æ€§åˆå§‹åŒ– ============
        this.player.critChance = 0.1;      // åŸºç¡€æš´å‡»ç‡ 10%
        this.player.critDamage = 0;        // åŸºç¡€æš´å‡»ä¼¤å®³åŠ æˆ 0%
        this.player.defense = 0;           // åŸºç¡€é˜²å¾¡åŠ›

        // ç©å®¶çŠ¶æ€
        this.player.isAttacking = false;
        this.player.facing = 'front';
        this.player.lastDirection = 'down';
        this.player.currentAnimation = null;

        console.log('ğŸ‘¤ ç©å®¶åˆ›å»ºå®Œæˆ v2.4 (v1.9.3 - æ·»åŠ æˆ˜æ–—å±æ€§)');
    }

    // ============ ğŸ¾ å® ç‰©ç³»ç»Ÿæ–¹æ³• ============

    /**
     * åˆ›å»ºå® ç‰©ç³»ç»Ÿ
     */
    createPetSystem() {
        // åˆ›å»ºå® ç‰©å®ä½“ï¼ˆä½¿ç”¨é¢„åŠ è½½çš„petçº¹ç†ï¼‰
        this.pet = new Pet(this, this.player.x + 60, this.player.y, this.player);

        // åˆ›å»ºå® ç‰©UI
        this.petUI = new PetUI(this);

        // åˆå§‹åŒ–å® ç‰©UIæ˜¾ç¤º
        if (this.petUI) {
            this.petUI.updatePetStats(this.pet);
        }

        // åˆ›å»ºæ”¶é›†ç‰©ç»„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if (!this.collectibles) {
            this.collectibles = this.physics.add.group();
        }

        console.log('ğŸ¾ å® ç‰©ç³»ç»Ÿå·²å¯åŠ¨');
    }

    /**
     * åˆ‡æ¢å® ç‰©UIæ˜¾ç¤º
     */
    togglePetUI() {
        if (this.petUI) {
            this.petUI.toggle();
        }
    }

    // ============ ğŸ¾ å® ç‰©ç³»ç»Ÿæ–¹æ³•ç»“æŸ ============

    setupControls() {
        // åˆ›å»ºå…‰æ ‡é”®
        this.cursors = this.input.keyboard.createCursorKeys();

        // åˆ›å»ºWASDé”®
        this.wasd = this.input.keyboard.addKeys({
            up: Phaser.Input.Keyboard.KeyCodes.W,
            down: Phaser.Input.Keyboard.KeyCodes.S,
            left: Phaser.Input.Keyboard.KeyCodes.A,
            right: Phaser.Input.Keyboard.KeyCodes.D,
            space: Phaser.Input.Keyboard.KeyCodes.SPACE,
            interact: Phaser.Input.Keyboard.KeyCodes.E
        });

        // æ”»å‡»é”®
        this.wasd.space.on('down', () => {
            this.combatSystem.playerAttack();
        });

        // äº¤äº’é”®
        this.wasd.interact.on('down', () => {
            this.handleInteraction();
        });

        // å¿«é€Ÿä¿å­˜é”® (F5)
        this.input.keyboard.on('keydown-F5', () => {
            this.quickSave();
        });

        // å¿«é€ŸåŠ è½½é”® (F9)
        this.input.keyboard.on('keydown-F9', () => {
            this.quickLoad();
        });

        // ============ Milestone 7 Sprint 5: ç»ˆå±€å†…å®¹å¿«æ·é”® ============
        // Boss Rushæ¨¡å¼ (Bé”®)
        this.input.keyboard.on('keydown-B', () => {
            this.startBossRush();
        });

        // Boss Rushè®°å½•æŸ¥çœ‹ (Ré”®)
        this.input.keyboard.on('keydown-R', () => {
            if (this.bossRushManager) {
                this.bossRushManager.showRecords();
            }
        });

        // ============ v1.9.4: ä¿®å¤å¿«æ·é”®å†²çª ============
        // ç§»é™¤æ— å°½åœ°ç‰¢çš„Ié”®ç»‘å®šï¼Œå› ä¸ºIé”®ç”¨äºç‰©å“æ 
        // æ— å°½åœ°ç‰¢æ¨¡å¼æ”¹ç”¨å…¶ä»–æ–¹å¼è®¿é—®ï¼ˆå¦‚é€šè¿‡NPCå¯¹è¯ï¼‰

        // æ— å°½åœ°ç‰¢è®°å½•æŸ¥çœ‹ (Ué”®)
        this.input.keyboard.on('keydown-U', () => {
            if (this.infiniteDungeonManager) {
                this.infiniteDungeonManager.showRecords();
            }
        });

        // ç”Ÿå­˜ç«æŠ€åœº (Aé”®)
        this.input.keyboard.on('keydown-A', () => {
            this.startSurvivalArena();
        });

        // é™æ—¶æŒ‘æˆ˜ (Té”®)
        this.input.keyboard.on('keydown-T', () => {
            this.startTimeAttackArena();
        });

        // ç«æŠ€åœºè®°å½•æŸ¥çœ‹ (Yé”®)
        this.input.keyboard.on('keydown-Y', () => {
            if (this.arenaManager) {
                this.arenaManager.showRecords();
            }
        });

        // New Game+ (Né”®)
        this.input.keyboard.on('keydown-N', () => {
            this.startNewGamePlus();
        });

        // æŸ¥çœ‹å½“å‰å‘¨ç›® (Mé”®)
        this.input.keyboard.on('keydown-M', () => {
            if (this.newGamePlusManager) {
                this.newGamePlusManager.showCurrentCycle();
            }
        });

        // ============ Milestone 7 Sprint 6: æ•™ç¨‹ç³»ç»Ÿå¿«æ·é”® ============
        // æ–°æ‰‹æ•™ç¨‹ (Hé”® - Help)
        this.input.keyboard.on('keydown-H', () => {
            if (this.tutorialManager) {
                this.tutorialManager.startNewPlayerTutorial();
            }
        });

        // æ•™ç¨‹çŠ¶æ€ (Jé”® - Journal)
        this.input.keyboard.on('keydown-J', () => {
            if (this.tutorialManager) {
                this.tutorialManager.showTutorialStatus();
            }
        });

        // ============ ğŸ¾ å® ç‰©ç³»ç»Ÿå¿«æ·é”® ============
        // åˆ‡æ¢å® ç‰©UI (Oé”®)
        this.input.keyboard.on('keydown-O', () => {
            this.togglePetUI();
        });

        // ============ ğŸŒ¤ï¸ ç¯å¢ƒç‰¹æ•ˆå¿«æ·é”® ============
        // åˆ‡æ¢å¤©æ°” (Té”® + Shiftï¼Œé¿å…å†²çª)
        this.input.keyboard.on('keydown-SHIFT+T', () => {
            this.cycleWeather();
        });

        // æ—¶é—´å¿«è¿›1å°æ—¶ (Hé”® + Shift)
        this.input.keyboard.on('keydown-SHIFT+H', () => {
            this.fastForwardTime(1);
        });

        // æ—¶é—´å¿«è¿›3å°æ—¶ (Hé”® + Shift + Shift)
        this.input.keyboard.on('keydown-SHIFT+H', () => {
            this.fastForwardTime(3);
        });

        // ============ æŠ€èƒ½å¿«æ·é”® - Milestone 6 ============
        // 1: æ—‹é£æ–©
        this.input.keyboard.on('keydown-ONE', () => {
            if (this.skillSystem) {
                this.skillSystem.castSkill('whirlwind_slash');
            }
        });

        // 2: å†²é”‹
        this.input.keyboard.on('keydown-TWO', () => {
            if (this.skillSystem) {
                this.skillSystem.castSkill('charge');
            }
        });

        // 3: æ²»ç–—ä¹‹å…‰
        this.input.keyboard.on('keydown-THREE', () => {
            if (this.skillSystem) {
                this.skillSystem.castSkill('healing_light');
            }
        });

        // 4: ç»ˆææŠ€èƒ½
        this.input.keyboard.on('keydown-FOUR', () => {
            if (this.skillSystem) {
                this.skillSystem.castSkill('ultimate');
            }
        });

        // ============ Milestone 6.3: è®¾ç½®å¿«æ·é”® ============
        // ESCé”®æ‰“å¼€è®¾ç½®
        this.input.keyboard.on('keydown-ESC', () => {
            this.openSettings();
        });

        console.log('âŒ¨ï¸ é”®ç›˜æ§åˆ¶è®¾ç½®å®Œæˆ');
    }

    setupQuestEvents() {
        // ç›‘å¬ä»»åŠ¡å¼€å§‹äº‹ä»¶
        this.events.on('questStarted', (quest) => {
            console.log(`ğŸ“œ ä»»åŠ¡å¼€å§‹: ${quest.name}`);
            this.showFloatingText(
                this.player.x,
                this.player.y - 60,
                `æ–°ä»»åŠ¡: ${quest.name}`,
                '#68d391'
            );
            // åˆ·æ–°ä»»åŠ¡UI
            this.refreshQuestUI();
        });

        // ç›‘å¬ä»»åŠ¡æ›´æ–°äº‹ä»¶
        this.events.on('questUpdated', (quest) => {
            const objective = quest.getCurrentObjective();
            if (objective) {
                console.log(`ğŸ“Š ${quest.name}: ${objective.description} (${objective.current}/${objective.required})`);
            }
            // åˆ·æ–°ä»»åŠ¡è¿½è¸ªå™¨
            this.refreshQuestTracker();
        });

        // ç›‘å¬ä»»åŠ¡ç›®æ ‡å®Œæˆäº‹ä»¶
        this.events.on('questObjectiveCompleted', (quest) => {
            console.log(`âœ¨ ä»»åŠ¡ç›®æ ‡å®Œæˆ: ${quest.name}`);
            this.showFloatingText(
                this.player.x,
                this.player.y - 60,
                `ç›®æ ‡å®Œæˆ!`,
                '#ffd700'
            );
            // åˆ·æ–°ä»»åŠ¡UI
            this.refreshQuestUI();
        });

        // ç›‘å¬ä»»åŠ¡å®Œæˆäº‹ä»¶
        this.events.on('questCompleted', (quest) => {
            console.log(`ğŸ‰ ä»»åŠ¡å®Œæˆ: ${quest.name}`);
            this.showFloatingText(
                400,
                300,
                `ä»»åŠ¡å®Œæˆ: ${quest.name}!`,
                '#ffd700',
                3000
            );
            // åˆ·æ–°ä»»åŠ¡UI
            this.refreshQuestUI();

            // ============ Milestone 7: æ•…äº‹è¿›åº¦è§¦å‘ ============
            if (this.storyManager) {
                // ä»»åŠ¡1å®Œæˆ â†’ æ£®æ—æ¢ç´¢ç« 
                if (quest.id === 'quest_1_moles') {
                    this.storyManager.setStoryFlag('quest1_completed');
                    this.time.delayedCall(2000, () => {
                        this.storyManager.advanceChapter(); // æ˜¾ç¤ºç¬¬ä¸€ç« æ ‡é¢˜
                    });
                }
                // ä»»åŠ¡2å®Œæˆ â†’ æ´ç©´æ·±å…¥ç« 
                if (quest.id === 'quest_2_gems') {
                    this.storyManager.setStoryFlag('quest2_completed');
                    this.time.delayedCall(2000, () => {
                        this.storyManager.advanceChapter(); // æ˜¾ç¤ºç¬¬äºŒç« æ ‡é¢˜
                    });
                }
                // Bossä»»åŠ¡å®Œæˆ â†’ è§¦å‘èƒœåˆ©åŠ¨ç”»
                if (quest.id === 'quest_3_boss') {
                    this.storyManager.setStoryFlag('boss_defeated');
                    this.time.delayedCall(2000, () => {
                        this.storyManager.showBossVictory('æ ‘å¦–ç‹');
                    });
                }
            }

            // å¦‚æœä»»åŠ¡æ—¥å¿—æ‰“å¼€ï¼Œåˆ·æ–°å®ƒ
            if (this.questLogPanel && this.questLogPanel.isOpen) {
                this.questLogPanel.refresh();
            }
        });

        // ç›‘å¬Bosså‡»è´¥äº‹ä»¶
        this.events.on('bossDefeated', (bossType) => {
            console.log(`ğŸ‘‘ Bossè¢«å‡»è´¥: ${bossType}`);

            // æ›´æ–°ä»»åŠ¡ç›®æ ‡
            if (this.questManager && bossType) {
                this.questManager.onBossDefeated(bossType);
            }
        });

        console.log('ğŸ“œ ä»»åŠ¡äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
    }

    refreshQuestUI() {
        // åˆ·æ–°ä»»åŠ¡è¿½è¸ªå™¨
        this.refreshQuestTracker();

        // å¦‚æœä»»åŠ¡æ—¥å¿—æ‰“å¼€ï¼Œåˆ·æ–°å®ƒ
        if (this.questLogPanel && this.questLogPanel.isOpen) {
            this.questLogPanel.refresh();
        }
    }

    refreshQuestTracker() {
        if (this.questTracker && this.questManager) {
            const activeQuests = this.questManager.getActiveQuests();
            this.questTracker.update(activeQuests);
        }
    }

    handleInteraction() {
        console.log('ğŸ”‘ Eé”®æŒ‰ä¸‹ï¼Œå¼€å§‹æ£€æŸ¥äº¤äº’å¯¹è±¡...');

        const playerX = this.player.x;
        const playerY = this.player.y;
        console.log(`ğŸ“ ç©å®¶ä½ç½®: (${Math.round(playerX)}, ${Math.round(playerY)})`);

        // æ‰¾åˆ°è·ç¦»ç©å®¶æœ€è¿‘çš„NPC
        let closestNPC = null;
        let closestDistance = Infinity;

        // ä½¿ç”¨SceneManagerçš„NPCæ•°ç»„ï¼ˆæ›´å¯é ï¼‰
        if (this.sceneManager && this.sceneManager.npcs) {
            const allNPCs = this.sceneManager.npcs;
            console.log(`ğŸ” NPCç®¡ç†å™¨ä¸­å…±æœ‰ ${allNPCs.length} ä¸ªNPC`);

            for (const npc of allNPCs) {
                if (!npc.active) continue; // è·³è¿‡å·²é”€æ¯çš„NPC

                const distance = Phaser.Math.Distance.Between(
                    playerX, playerY,
                    npc.x, npc.y
                );

                const npcName = npc.getData('name');
                console.log(`ğŸ‘¤ å‘ç°NPC: ${npcName} at (${npc.x}, ${npc.y}), è·ç¦»: ${Math.round(distance)}px`);

                // å¢åŠ äº¤äº’è·ç¦»åˆ°100åƒç´ ï¼Œæ›´å®¹æ˜“è§¦å‘
                if (distance < 100 && distance < closestDistance) {
                    closestDistance = distance;
                    closestNPC = npc;
                }
            }
        } else {
            console.warn('âš ï¸ SceneManageræˆ–NPCç®¡ç†å™¨æœªåˆå§‹åŒ–');
        }

        // åªä¸æœ€è¿‘çš„NPCå¯¹è¯
        if (closestNPC) {
            console.log(`âœ… æ‰¾åˆ°NPC: ${closestNPC.getData('name')}, è·ç¦»: ${Math.round(closestDistance)}px`);
            this.talkToNPC(closestNPC);
        } else {
            console.log(`âŒ æ²¡æœ‰æ‰¾åˆ°é™„è¿‘çš„NPC (ç©å®¶ä½ç½®: ${Math.round(playerX)}, ${Math.round(playerY)})`);
        }

        // æ£€æŸ¥é™„è¿‘çš„å®ç®±ï¼ˆå¦‚æœæœ‰ï¼‰
        if (this.sceneManager && this.sceneManager.chests) {
            const allChests = this.sceneManager.chests;

            for (const chest of allChests) {
                if (!chest.active || chest.getData('opened')) continue; // è·³è¿‡å·²é”€æ¯æˆ–å·²æ‰“å¼€çš„å®ç®±

                const distance = Phaser.Math.Distance.Between(
                    playerX, playerY,
                    chest.x, chest.y
                );

                // å¢åŠ å®ç®±äº¤äº’è·ç¦»åˆ°100åƒç´ 
                if (distance < 100) {
                    console.log(`âœ… æ‰¾åˆ°å®ç®±ï¼Œè·ç¦»: ${Math.round(distance)}px`);
                    this.openChest(chest);
                    break; // åªæ‰“å¼€ä¸€ä¸ªå®ç®±
                }
            }
        }
    }

    talkToNPC(npc) {
        const npcName = npc.getData('name');
        const npcId = npc.getData('id');

        // ============ Milestone 7: ä½¿ç”¨å¯¹è¯ç®¡ç†å™¨ ============
        if (this.dialogueManager && (npcId === 'elder' || npcId === 'merchant')) {
            console.log(`ğŸ’¬ å¯åŠ¨å¯¹è¯ç³»ç»Ÿ: ${npcId}`);
            this.dialogueManager.startDialogue(npcId, {
                name: npcName,
                id: npcId
            });
            return;
        }

        // æ—§å¯¹è¯ç³»ç»Ÿï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
        const currentScene = this.sceneManager.getCurrentScene();
        let message = '';

        if (npcName === 'æ‘é•¿') {
            if (currentScene === 'town') {
                // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
                const quest1 = this.questManager.getQuest('quest_1_moles');
                const quest2 = this.questManager.getQuest('quest_2_gems');
                const quest4 = this.questManager.getQuest('quest_4_slime_hunter');
                const quest5 = this.questManager.getQuest('quest_5_blade_guardian');

                // æ„å»ºå¯¹è¯æ¶ˆæ¯
                message = 'æ‘é•¿ï¼šæ¬¢è¿æ¥åˆ°å°é•‡ï¼Œå¹´è½»çš„å†’é™©è€…ï¼\n\n';

                // ä»»åŠ¡1ä¿¡æ¯
                if (quest1.status === 'not_started') {
                    message += 'ğŸ“œ [å¯æ¥å–] é¼¹é¼ å¨èƒ\n  æ£®æ—é‡Œçš„é¼¹é¼ å¤ªå¤šäº†ï¼Œè¯·å‡»è´¥10åªé¼¹é¼ ï¼\n\n';
                } else if (quest1.status === 'in_progress') {
                    const obj = quest1.getCurrentObjective();
                    message += 'ğŸ“œ [è¿›è¡Œä¸­] é¼¹é¼ å¨èƒ\n  è¿›åº¦: ' + obj.current + '/' + obj.required + '\n\n';
                } else if (quest1.status === 'completed') {
                    message += 'âœ… [å·²å®Œæˆ] é¼¹é¼ å¨èƒ\n\n';
                }

                // ä»»åŠ¡2ä¿¡æ¯
                if (quest2.status === 'not_started') {
                    message += 'ğŸ’ [å¯æ¥å–] å®çŸ³æ”¶é›†\n  æ”¶é›†3é¢—ç¥ç§˜å®çŸ³ï¼Œå¥–åŠ±ä¸°åšï¼\n\n';
                } else if (quest2.status === 'in_progress') {
                    const obj = quest2.getCurrentObjective();
                    message += 'ğŸ’ [è¿›è¡Œä¸­] å®çŸ³æ”¶é›†\n  è¿›åº¦: ' + obj.current + '/' + obj.required + '\n\n';
                } else if (quest2.status === 'completed') {
                    message += 'âœ… [å·²å®Œæˆ] å®çŸ³æ”¶é›†\n\n';
                }

                // Milestone 6 - æ–°ä»»åŠ¡ä¿¡æ¯

                // ä»»åŠ¡4: å²è±å§†ç‹©çŒ (éœ€è¦å®Œæˆä»»åŠ¡1)
                if (quest4) {
                    const prereqMet = quest1.status === 'completed';
                    if (quest4.status === 'not_started') {
                        if (prereqMet) {
                            message += 'ğŸ¦  [å¯æ¥å–] å²è±å§†ç‹©çŒ\n  æ´ç©´é‡Œçš„å²è±å§†å¤ªå¤šäº†ï¼Œå‡»è´¥5åªå²è±å§†ï¼\n  å¥–åŠ±: 50é‡‘å¸, 30XP\n\n';
                        } else {
                            message += 'ğŸ”’ [é”å®š] å²è±å§†ç‹©çŒ\n  éœ€è¦å®Œæˆ: é¼¹é¼ å¨èƒ\n\n';
                        }
                    } else if (quest4.status === 'in_progress') {
                        const obj = quest4.getCurrentObjective();
                        message += 'ğŸ¦  [è¿›è¡Œä¸­] å²è±å§†ç‹©çŒ\n  è¿›åº¦: ' + obj.current + '/' + obj.required + '\n\n';
                    } else if (quest4.status === 'completed') {
                        message += 'âœ… [å·²å®Œæˆ] å²è±å§†ç‹©çŒ\n\n';
                    }
                }

                // ä»»åŠ¡5: å®ˆæŠ¤è€…ä¹‹åˆƒ (éœ€è¦å®Œæˆä»»åŠ¡1)
                if (quest5) {
                    const prereqMet = quest1.status === 'completed';
                    if (quest5.status === 'not_started') {
                        if (prereqMet) {
                            message += 'âš”ï¸ [å¯æ¥å–] å®ˆæŠ¤è€…ä¹‹åˆƒ\n  å¯»æ‰¾3æŠŠå¤ä»£æ­¦å™¨ç¢ç‰‡ï¼Œé‡æ–°é“¸é€ ä¼ å¥‡ä¹‹å‰‘ï¼\n  å¥–åŠ±: å®ˆæŠ¤è€…ä¹‹å‰‘(ATK+5), 75é‡‘å¸, 100XP\n\n';
                        } else {
                            message += 'ğŸ”’ [é”å®š] å®ˆæŠ¤è€…ä¹‹åˆƒ\n  éœ€è¦å®Œæˆ: é¼¹é¼ å¨èƒ\n\n';
                        }
                    } else if (quest5.status === 'in_progress') {
                        const obj = quest5.getCurrentObjective();
                        message += 'âš”ï¸ [è¿›è¡Œä¸­] å®ˆæŠ¤è€…ä¹‹åˆƒ\n  è¿›åº¦: ' + obj.current + '/' + obj.required + '\n\n';
                    } else if (quest5.status === 'completed') {
                        message += 'âœ… [å·²å®Œæˆ] å®ˆæŠ¤è€…ä¹‹åˆƒ\n\n';
                    }
                }

                message += 'æç¤ºï¼šæŒ‰Qé”®æŸ¥çœ‹ä»»åŠ¡æ—¥å¿—\n\næŒ‰Eé”®ç»§ç»­å¯¹è¯æ¥å–ä»»åŠ¡';

                // æ˜¾ç¤ºå¯¹è¯å¹¶æ·»åŠ é€‰é¡¹
                this.showQuestDialog(npcName, message, npcId);
                return;
            }
        } else if (npcName === 'å•†äºº') {
            // æ‰“å¼€å•†åº—å¹¶æ·»åŠ æ–°ä»»åŠ¡
            const quest6 = this.questManager.getQuest('quest_6_lost_cargo');

            let shopMessage = 'å•†äººï¼šæ¬¢è¿å…‰ä¸´ï¼æƒ³ä¹°ç‚¹ä»€ä¹ˆå—ï¼Ÿ\n\n';

            // Milestone 6 - ä»»åŠ¡6: å¤±è½çš„è´§ç‰©
            if (quest6) {
                if (quest6.status === 'not_started') {
                    shopMessage += 'ğŸ“¦ [å¯æ¥å–] å¤±è½çš„è´§ç‰©\n  æˆ‘çš„é©¬è½¦é‡è¢­äº†ï¼è¯·å¸®æˆ‘æ‰¾å›3ä¸ªè´§ç‰©ç®±å­ã€‚\n  å¥–åŠ±: 200é‡‘å¸, å•†äººä¼˜æƒ åˆ¸, 50XP\n\n';
                } else if (quest6.status === 'in_progress') {
                    const obj = quest6.getCurrentObjective();
                    shopMessage += `ğŸ“¦ [è¿›è¡Œä¸­] å¤±è½çš„è´§ç‰©\n  è¿›åº¦: ${obj.current}/${obj.required}\n\n`;
                } else if (quest6.status === 'completed') {
                    shopMessage += 'âœ… [å·²å®Œæˆ] å¤±è½çš„è´§ç‰©\nè°¢è°¢ä½ çš„å¸®åŠ©ï¼\n\n';
                }
            }

            // æ‰“å¼€å•†åº—
            if (this.shopManager) {
                this.shopManager.openShop('å•†äºº');
            }
            return;
        }

        if (message) {
            this.showDialog(npcName, message);
        }
    }

    showDialog(speaker, message) {
        // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
        const dialogBg = this.add.rectangle(400, 500, 700, 150, 0x222222);
        dialogBg.setStrokeStyle(3, 0x667eea);
        dialogBg.setDepth(100);

        // åˆ›å»ºå¯¹è¯æ¡†æ–‡å­—
        const dialogText = this.add.text(100, 420, message, {
            font: '16px Noto Sans SC',
            fill: '#ffffff',
            wordWrap: { width: 650 }
        });
        dialogText.setDepth(101);

        // åˆ›å»ºè¯´è¯è€…åç§°
        const speakerText = this.add.text(100, 400, speaker, {
            font: 'bold 18px Noto Sans SC',
            fill: '#667eea'
        });
        speakerText.setDepth(101);

        // åˆ›å»ºå…³é—­æç¤º
        const closeHint = this.add.text(700, 530, 'æŒ‰ä»»æ„é”®å…³é—­', {
            font: '14px Arial',
            fill: '#888888'
        }).setOrigin(1, 0);
        closeHint.setDepth(101);

        // åˆ›å»ºä¸´æ—¶è¦†ç›–å±‚é˜»æ­¢è¾“å…¥
        const inputBlocker = this.add.rectangle(400, 300, 800, 600, 0x000000, 0);
        inputBlocker.setDepth(99);
        inputBlocker.setInteractive();

        // ç‚¹å‡»æˆ–æŒ‰é”®å…³é—­å¯¹è¯æ¡†
        const closeDialog = () => {
            dialogBg.destroy();
            dialogText.destroy();
            speakerText.destroy();
            closeHint.destroy();
            inputBlocker.destroy();
            inputBlocker.off('pointerdown', closeDialog);
            this.input.keyboard.off('keydown', closeDialog);
        };

        inputBlocker.on('pointerdown', closeDialog);
        this.input.keyboard.once('keydown', closeDialog);

        console.log(`ğŸ’¬ å¯¹è¯: ${speaker}`);
    }

    showQuestDialog(speaker, message, npcId) {
        // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯ï¼ˆæ›´å¤§ä»¥å®¹çº³é€‰é¡¹ï¼‰
        const dialogBg = this.add.rectangle(400, 500, 700, 200, 0x222222);
        dialogBg.setStrokeStyle(3, 0x68d391);
        dialogBg.setDepth(100);

        // åˆ›å»ºå¯¹è¯æ¡†æ–‡å­—
        const dialogText = this.add.text(100, 420, message, {
            font: '15px Noto Sans SC',
            fill: '#ffffff',
            wordWrap: { width: 620 }
        });
        dialogText.setDepth(101);

        // åˆ›å»ºè¯´è¯è€…åç§°
        const speakerText = this.add.text(100, 400, speaker, {
            font: 'bold 18px Noto Sans SC',
            fill: '#68d391'
        });
        speakerText.setDepth(101);

        // åˆ›å»ºé€‰é¡¹æŒ‰é’®
        const quest1 = this.questManager.getQuest('quest_1_moles');
        const quest2 = this.questManager.getQuest('quest_2_gems');
        const quest4 = this.questManager.getQuest('quest_4_slime_hunter');
        const quest5 = this.questManager.getQuest('quest_5_blade_guardian');

        // æ£€æŸ¥å“ªäº›ä»»åŠ¡å¯ä»¥æ¥å–
        const canAccept1 = quest1.status === 'not_started';
        const canAccept2 = quest2.status === 'not_started';
        const canAccept4 = quest4 && quest4.status === 'not_started' && quest1.status === 'completed';
        const canAccept5 = quest5 && quest5.status === 'not_started' && quest1.status === 'completed';

        // æ„å»ºæç¤ºæ–‡æœ¬
        let buttonText = 'æŒ‰ ';
        let shortcutCount = 0;

        if (canAccept1) {
            buttonText += `1 æ¥å–é¼¹é¼ ä»»åŠ¡`;
            shortcutCount++;
        }
        if (canAccept2) {
            if (shortcutCount > 0) buttonText += ' | ';
            buttonText += `2 æ¥å–å®çŸ³ä»»åŠ¡`;
            shortcutCount++;
        }
        if (canAccept4) {
            if (shortcutCount > 0) buttonText += ' | ';
            buttonText += `3 æ¥å–å²è±å§†ä»»åŠ¡`;
            shortcutCount++;
        }
        if (canAccept5) {
            if (shortcutCount > 0) buttonText += ' | ';
            buttonText += `4 æ¥å–å®ˆæŠ¤è€…ä¹‹åˆƒä»»åŠ¡`;
            shortcutCount++;
        }

        buttonText += shortcutCount > 0 ? ' | ' : '';
        buttonText += 'ESC å…³é—­';

        const hintText = this.add.text(400, 570, buttonText, {
            font: '13px Arial',
            fill: '#ffd700'
        }).setOrigin(0.5);
        hintText.setDepth(101);

        // åˆ›å»ºä¸´æ—¶è¦†ç›–å±‚é˜»æ­¢è¾“å…¥
        const inputBlocker = this.add.rectangle(400, 300, 800, 600, 0x000000, 0);
        inputBlocker.setDepth(99);
        inputBlocker.setInteractive();

        // å…³é—­å¯¹è¯æ¡†å‡½æ•°
        const closeDialog = () => {
            dialogBg.destroy();
            dialogText.destroy();
            speakerText.destroy();
            hintText.destroy();
            inputBlocker.destroy();
            inputBlocker.off('pointerdown', closeDialog);
            this.input.keyboard.off('keydown-ESC', closeDialog);
            this.input.keyboard.off('keydown-ONE', acceptQuest1);
            this.input.keyboard.off('keydown-TWO', acceptQuest2);
            this.input.keyboard.off('keydown-THREE', acceptQuest4);
            this.input.keyboard.off('keydown-FOUR', acceptQuest5);
        };

        // æ¥å–ä»»åŠ¡1
        const acceptQuest1 = () => {
            if (quest1.status === 'not_started') {
                const success = this.questManager.startQuest('quest_1_moles');
                if (success) {
                    this.showFloatingText(400, 300, 'ä»»åŠ¡å·²æ¥å—: é¼¹é¼ å¨èƒ!', '#68d391', 2000);
                }
            }
            closeDialog();
        };

        // æ¥å–ä»»åŠ¡2
        const acceptQuest2 = () => {
            if (quest2.status === 'not_started') {
                const success = this.questManager.startQuest('quest_2_gems');
                if (success) {
                    this.showFloatingText(400, 300, 'ä»»åŠ¡å·²æ¥å—: å®çŸ³æ”¶é›†!', '#68d391', 2000);
                }
            }
            closeDialog();
        };

        // Milestone 6: æ¥å–ä»»åŠ¡4 - å²è±å§†ç‹©çŒ
        const acceptQuest4 = () => {
            if (quest4 && quest4.status === 'not_started') {
                const success = this.questManager.startQuest('quest_4_slime_hunter');
                if (success) {
                    this.showFloatingText(400, 300, 'ä»»åŠ¡å·²æ¥å—: å²è±å§†ç‹©çŒ!', '#68d391', 2000);
                }
            } else if (quest4 && quest4.status !== 'not_started') {
                // ä»»åŠ¡å·²é”å®šæˆ–ä¸æ»¡è¶³æ¡ä»¶
                const prereqDesc = quest4.getPrerequisiteDescription();
                this.showFloatingText(400, 300, `ğŸ”’ ${prereqDesc}`, '#ff6b6b', 2000);
                closeDialog();
            } else {
                closeDialog();
            }
        };

        // Milestone 6: æ¥å–ä»»åŠ¡5 - å®ˆæŠ¤è€…ä¹‹åˆƒ
        const acceptQuest5 = () => {
            if (quest5 && quest5.status === 'not_started') {
                const success = this.questManager.startQuest('quest_5_blade_guardian');
                if (success) {
                    this.showFloatingText(400, 300, 'ä»»åŠ¡å·²æ¥å—: å®ˆæŠ¤è€…ä¹‹åˆƒ!', '#68d391', 2000);
                }
            } else if (quest5 && quest5.status !== 'not_started') {
                // ä»»åŠ¡å·²é”å®šæˆ–ä¸æ»¡è¶³æ¡ä»¶
                const prereqDesc = quest5.getPrerequisiteDescription();
                this.showFloatingText(400, 300, `ğŸ”’ ${prereqDesc}`, '#ff6b6b', 2000);
                closeDialog();
            } else {
                closeDialog();
            }
        };

        inputBlocker.on('pointerdown', closeDialog);
        this.input.keyboard.once('keydown-ESC', closeDialog);

        // åªåœ¨ä»»åŠ¡å¯æ¥å–æ—¶æ·»åŠ æŒ‰é”®ç›‘å¬
        if (canAccept1) {
            this.input.keyboard.once('keydown-ONE', acceptQuest1);
        }
        if (canAccept2) {
            this.input.keyboard.once('keydown-TWO', acceptQuest2);
        }
        if (canAccept4) {
            this.input.keyboard.once('keydown-THREE', acceptQuest4);
        }
        if (canAccept5) {
            this.input.keyboard.once('keydown-FOUR', acceptQuest5);
        }

        console.log(`ğŸ’¬ ä»»åŠ¡å¯¹è¯: ${speaker}`);
    }

    openChest(chest) {
        chest.setData('opened', true);

        // æ’­æ”¾å®ç®±æ‰“å¼€éŸ³æ•ˆ
        if (this.audioManager) {
            this.audioManager.playChestOpen();
        }

        // éšæœºæ‰è½ç‰©å“
        const random = Math.random();
        let item;
        let itemName;

        if (random < 0.5) {
            item = 'coin';
            itemName = 'é‡‘å¸';
        } else if (random < 0.8) {
            item = 'gem';
            itemName = 'å®çŸ³';
        } else {
            // æ¢å¤ç”Ÿå‘½å€¼
            this.player.hp = Math.min(this.player.maxHp, this.player.hp + 20);
            itemName = 'ç”Ÿå‘½è¯æ°´';
            this.showFloatingText(chest.x, chest.y, '+20 HP', '#ff6b6b');
            this.updateUI();
        }

        if (item) {
            this.dropItem(chest.x, chest.y, item);
            this.showFloatingText(chest.x, chest.y, `è·å¾— ${itemName}!`, '#ffd700');
        }

        // æ”¹å˜å®ç®±å¤–è§‚ï¼ˆç®€å•å˜æš—ï¼‰
        chest.setAlpha(0.5);

        console.log(`ğŸ æ‰“å¼€å®ç®±: ${itemName}`);
    }

    gainXP(amount) {
        const oldLevel = this.player.level;
        this.player.xp += amount;

        console.log(`âœ¨ è·å¾— ${amount} XP - å½“å‰: ${this.player.xp}/${this.player.xpToNextLevel}`);

        // æ£€æŸ¥æ˜¯å¦å‡çº§
        if (this.player.xp >= this.player.xpToNextLevel) {
            this.levelUp();
        }

        this.updateUI();
    }

    levelUp() {
        const oldLevel = this.player.level;
        const oldMaxHp = this.player.maxHp;
        const oldAttack = this.player.attack;

        this.player.level++;
        this.player.xp -= this.player.xpToNextLevel;
        this.player.xpToNextLevel = Math.floor(this.player.xpToNextLevel * 1.5);

        // å¢åŠ å±æ€§ï¼ˆå¢å¼ºç‰ˆï¼‰
        this.player.maxHp += 15;     // ä»10å¢åŠ åˆ°15ï¼ˆæå‡50%ï¼‰
        this.player.hp = this.player.maxHp;
        this.player.attack += 5;      // ä»3å¢åŠ åˆ°5ï¼ˆæå‡66%ï¼‰

        // ============ å‡çº§åº†ç¥æ•ˆæœ ============

        // 1. å¤§å±å¹•é—ªå…‰
        this.cameras.main.flash(500, 255, 255, 0);

        // 2. å±å¹•éœ‡åŠ¨
        this.cameras.main.shake(300, 0.015);

        // 3. æ˜¾ç¤ºå‡çº§æ ‡é¢˜ï¼ˆå¤§å­—ï¼‰
        const levelUpText = this.add.text(400, 250, 'LEVEL UP!', {
            fontFamily: 'Press Start 2P',
            fontSize: '48px',
            color: '#ffd700',
            stroke: '#000000',
            strokeThickness: 8
        }).setOrigin(0.5).setDepth(300);

        // 4. ç­‰çº§æå‡
        const levelText = this.add.text(400, 320, `${oldLevel} â†’ ${this.player.level}`, {
            fontFamily: 'Arial',
            fontSize: '32px',
            color: '#ffffff',
            stroke: '#000000',
            strokeThickness: 4
        }).setOrigin(0.5).setDepth(300);

        // 5. å±æ€§æå‡æç¤º
        const hpGain = this.player.maxHp - oldMaxHp;
        const atkGain = this.player.attack - oldAttack;
        const statsText = this.add.text(400, 380,
            `HP +${hpGain}  æ”»å‡» +${atkGain}`, {
            fontFamily: 'Arial',
            fontSize: '24px',
            color: '#68d391',
            stroke: '#000000',
            strokeThickness: 3
        }).setOrigin(0.5).setDepth(300);

        // 6. æ–‡å­—åŠ¨ç”»åæ¶ˆå¤±
        this.time.delayedCall(2500, () => {
            this.tweens.add({
                targets: [levelUpText, levelText, statsText],
                alpha: 0,
                y: '-=50',
                duration: 500,
                onComplete: () => {
                    levelUpText.destroy();
                    levelText.destroy();
                    statsText.destroy();
                }
            });
        });

        // ============ Milestone 6: MPç³»ç»Ÿ ============
        // æ›´æ–°MPä¸Šé™å¹¶æ¢å¤æ»¡MP
        if (this.resourceManager) {
            this.resourceManager.onLevelUp();
        }

        // ============ Milestone 7 Sprint 3: æŠ€èƒ½ç‚¹ç³»ç»Ÿ ============
        // æ¯çº§è·å¾—1ä¸ªæŠ€èƒ½ç‚¹
        if (this.skillTreeManager) {
            this.skillTreeManager.addSkillPoints(1);
        }

        // æ£€æŸ¥æŠ€èƒ½è§£é”
        if (this.skillSystem) {
            this.skillSystem.checkUnlockedSkills();
        }

        // æ’­æ”¾å‡çº§éŸ³æ•ˆ
        this.audioManager.playLevelUp();

        // æ£€æŸ¥æˆå°±ï¼šæ»¡çº§è‹±é›„
        if (this.player.level >= 10) {
            this.achievementManager.unlock('max_level');
        }

        // æ£€æŸ¥æˆå°±ï¼šå¯Œæœ‰ä¹‹äºº
        if (this.player.gold >= 1000) {
            this.achievementManager.unlock('wealthy');
        }

        // è‡ªåŠ¨ä¿å­˜æ¸¸æˆ
        if (this.saveManager) {
            console.log('ğŸ’¾ [Level Up] Triggering auto-save...');
            this.saveManager.autoSave();
        }

        console.log(`â¬†ï¸ å‡çº§ï¼${oldLevel} â†’ ${this.player.level}ï¼ŒHPï¼š${this.player.maxHp}ï¼Œæ”»å‡»ï¼š${this.player.attack}`);
    }

    dropItem(x, y, type) {
        let item;
        if (type === 'coin') {
            item = this.add.image(x, y, 'coin').setScale(2);

            // æ’­æ”¾é‡‘å¸æ‹¾å–éŸ³æ•ˆ
            if (this.audioManager) {
                this.audioManager.playCoinPickup();
            }

            // å¢åŠ ç©å®¶é‡‘å¸ï¼ˆä¿®å¤bugï¼‰
            this.player.gold += 10;  // æ¯ä¸ªé‡‘å¸+10
            console.log(`ğŸ’° è·å¾—10é‡‘å¸ï¼Œå½“å‰é‡‘å¸: ${this.player.gold}`);

            // æ›´æ–°é‡‘å¸ç»Ÿè®¡
            if (window.gameData && window.gameData.progress) {
                window.gameData.progress.totalCoins++;
            }

            // æ›´æ–°UIæ˜¾ç¤º
            this.updateUI();
        } else if (type === 'gem') {
            item = this.add.image(x, y, 'gem').setScale(2);

            // æ›´æ–°å®çŸ³è®¡æ•°
            if (window.gameData && window.gameData.progress) {
                window.gameData.progress.gemsCollected++;
            }

            // æ›´æ–°ä»»åŠ¡è¿›åº¦ï¼ˆå®çŸ³æ”¶é›†ï¼‰
            if (this.questManager) {
                this.questManager.onGemCollected();
            }
        }

        if (item) {
            // ç®€å•çš„æ‹¾å–åŠ¨ç”»
            this.tweens.add({
                targets: item,
                y: y - 20,
                alpha: 0,
                duration: 500,
                onComplete: () => item.destroy()
            });
        }
    }

    showFloatingText(x, y, message, color = '#ffffff') {
        // ä½¿ç”¨å¯¹è±¡æ± è·å–æ–‡æœ¬å¯¹è±¡
        const text = this.objectPool.getFloatingText(x, y, message, color);

        this.tweens.add({
            targets: text,
            y: y - 40,
            alpha: 0,
            duration: 1500,
            onComplete: () => {
                // å›æ”¶åˆ°å¯¹è±¡æ± è€Œä¸æ˜¯é”€æ¯
                this.objectPool.recycleFloatingText(text);
            }
        });
    }

    showWelcomeMessage() {
        // ä¿å­˜æ‰€æœ‰å»¶è¿Ÿäº‹ä»¶ï¼Œä»¥ä¾¿è·³è¿‡
        this.welcomeEvents = [];

        // åˆ›å»ºè·³è¿‡æç¤º
        const skipHint = this.add.text(400, 450, 'æŒ‰ SPACE æˆ– ENTER è·³è¿‡ä»‹ç»', {
            fontFamily: 'Noto Sans SC',
            fontSize: '16px',
            fill: '#ffffff',
            backgroundColor: '#000000',
            padding: { x: 10, y: 5 }
        }).setOrigin(0.5).setAlpha(0.7).setScrollFactor(0);

        // è·³è¿‡æ¬¢è¿æ¶ˆæ¯çš„æ–¹æ³•
        const skipWelcome = () => {
            console.log('â­ï¸ è·³è¿‡æ¬¢è¿æ¶ˆæ¯');

            // å–æ¶ˆæ‰€æœ‰å»¶è¿Ÿäº‹ä»¶
            this.welcomeEvents.forEach(event => {
                if (event && event.remove) {
                    event.remove();
                }
            });
            this.welcomeEvents = [];

            // ç§»é™¤è·³è¿‡æç¤º
            if (skipHint) skipHint.destroy();

            // ç§»é™¤é”®ç›˜ç›‘å¬
            this.input.keyboard.off('keydown-SPACE', skipHandler);
            this.input.keyboard.off('keydown-ENTER', skipHandler);

            // å¦‚æœå¼€åœºåŠ¨ç”»è¿˜æ²¡æ’­æ”¾ï¼Œç«‹å³æ’­æ”¾
            if (this.storyManager && !this.storyManager.storyProgress.hasSeenIntro) {
                this.storyManager.showIntro();
            }
        };

        // åˆ›å»ºé”®ç›˜ç›‘å¬å¤„ç†å™¨
        const skipHandler = (e) => {
            if ((e.code === 'Space' || e.code === 'Enter') && !this.isSkippingWelcome) {
                this.isSkippingWelcome = true;
                skipWelcome();
            }
        };

        // æ·»åŠ é”®ç›˜ç›‘å¬
        this.input.keyboard.on('keydown-SPACE', skipHandler);
        this.input.keyboard.on('keydown-ENTER', skipHandler);

        // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯åºåˆ—
        const event1 = this.time.delayedCall(500, () => {
            this.showFloatingText(400, 200, 'æ¬¢è¿æ¥åˆ°æ£®æ—æ¢é™©ï¼', '#68d391');
            const event2 = this.time.delayedCall(2000, () => {
                this.showFloatingText(400, 240, 'ä½¿ç”¨ WASD ç§»åŠ¨ï¼Œç©ºæ ¼é”®æ”»å‡»', '#4facfe');
                const event3 = this.time.delayedCall(2000, () => {
                    this.showFloatingText(400, 280, 'æŒ‰ E é”®ä¸NPCå¯¹è¯', '#ffd700');
                    const event4 = this.time.delayedCall(1500, () => {
                        // ============ Milestone 7: æ’­æ”¾å¼€åœºåŠ¨ç”» ============
                        if (this.storyManager) {
                            this.storyManager.showIntro();
                        }
                        // ç§»é™¤è·³è¿‡æç¤º
                        if (skipHint) skipHint.destroy();
                        // ç§»é™¤é”®ç›˜ç›‘å¬
                        this.input.keyboard.off('keydown-SPACE', skipHandler);
                        this.input.keyboard.off('keydown-ENTER', skipHandler);
                    });
                    this.welcomeEvents.push(event4);
                    // ============ Milestone 7 Sprint 6: æ–°æ‰‹æ•™ç¨‹æç¤º ============
                    const event5 = this.time.delayedCall(3000, () => {
                        // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ•™ç¨‹
                        if (this.tutorialManager && !this.tutorialManager.isTutorialCompleted('movement')) {
                            this.showFloatingText(400, 320, 'ğŸ’¡ æŒ‰ H é”®å¼€å§‹æ–°æ‰‹æ•™ç¨‹', '#68d391', 4000);
                        }
                    });
                    this.welcomeEvents.push(event5);
                });
                this.welcomeEvents.push(event3);
            });
            this.welcomeEvents.push(event2);
        });
        this.welcomeEvents.push(event1);

        // ============ ğŸ¾ å® ç‰©ç³»ç»Ÿåˆå§‹åŒ– ============
        // åˆ›å»ºå® ç‰©ç³»ç»Ÿ
        this.createPetSystem();

        // ============ ğŸŒ¤ï¸ ç¯å¢ƒç‰¹æ•ˆç³»ç»Ÿåˆå§‹åŒ– ============
        // åˆ›å»ºæ˜¼å¤œå¾ªç¯ç³»ç»Ÿ
        this.dayNightManager = new DayNightManager(this);
        this.dayNightManager.createTimeUI();

        // åˆ›å»ºå¤©æ°”ç²’å­ç³»ç»Ÿ
        this.weatherParticles = new WeatherParticles(this);

        // åˆ›å»ºç¯å¢ƒç²’å­ç³»ç»Ÿ
        this.ambientParticles = new AmbientParticles(this);

        // åˆ›å»ºåŠ¨æ€å…‰ç…§ç³»ç»Ÿ
        this.lightingManager = new LightingManager(this);
        this.lightingManager.create();

        // åˆ›å»ºç©å®¶å…‰æºï¼ˆå¦‚ç«æŠŠï¼‰
        if (this.lightingManager) {
            this.playerLightId = this.lightingManager.createPlayerLight();
        }

        // æ ¹æ®å½“å‰æ—¶é—´åˆå§‹åŒ–ç¯å¢ƒç²’å­
        if (this.ambientParticles && this.dayNightManager) {
            const currentPhase = this.dayNightManager.getCurrentPhase();
            this.ambientParticles.changeByContext(currentPhase, 'clear', 'forest');
        }

        console.log('ğŸŒ¤ï¸ ç¯å¢ƒç‰¹æ•ˆç³»ç»Ÿå·²å¯åŠ¨');

        console.log('ğŸ® GameScene åˆå§‹åŒ–å®Œæˆ (v1.9.5 - ç¯å¢ƒç‰¹æ•ˆ)');
    }

    resetPlayerAnimation() {
        // åœæ­¢å½“å‰åŠ¨ç”»
        this.player.anims.stop();

        // åˆ‡æ¢å›idleçº¹ç†ï¼ˆé™æ€å›¾ç‰‡ï¼‰
        const idleTexture = `hero-idle-${this.player.facing}`;
        this.player.setTexture(idleTexture);
    }

    initUI() {
        // æ˜¾ç¤ºUI
        document.getElementById('hp-bar').style.display = 'block';
        document.getElementById('xp-bar').style.display = 'block';
        document.getElementById('level-display').style.display = 'block';
        document.getElementById('gold-display').style.display = 'block';
        // ============ v1.9.2: Critical Hit UI ============
        document.getElementById('crit-display').style.display = 'block';
        // ============ v1.9.3: Attack Power UI ============
        document.getElementById('attack-display').style.display = 'block';
        // ============ v1.9.4: Defense Power UI ============
        document.getElementById('defense-display').style.display = 'block';

        // ============ Milestone 6: MP Bar ============
        document.getElementById('mp-bar').style.display = 'block';

        // æ·»åŠ åœºæ™¯åç§°æ˜¾ç¤º
        this.addSceneIndicator();

        // åˆå§‹åŒ–ä»»åŠ¡UI
        this.initQuestUI();

        // ============ Milestone 6: Skill Bar ============
        // åˆå§‹åŒ–æŠ€èƒ½æ 
        if (typeof SkillBar !== 'undefined') {
            this.skillBar = new SkillBar(this);
        }

        // ============ Milestone 6.6: Inventory Bar ============
        // åˆå§‹åŒ–ç‰©å“æ UI
        if (typeof InventoryUI !== 'undefined') {
            this.inventoryUI = new InventoryUI(this, this.inventory);
        }

        // ============ Milestone 6.7: Equipment UI ============
        // åˆå§‹åŒ–è£…å¤‡UI
        if (typeof EquipmentUI !== 'undefined') {
            this.equipmentUI = new EquipmentUI(this, this.equipmentManager);
        }

        // ============ Milestone 7 Sprint 6: å°åœ°å›¾ ============
        // åˆå§‹åŒ–å°åœ°å›¾
        this.minimapManager = new MinimapManager(this);
        this.minimapManager.create();
        this.minimapManager.addCompass();
        this.minimapManager.addPlayerDirectionIndicator();

        this.updateUI();
    }

    initQuestUI() {
        // åˆ›å»ºä»»åŠ¡è¿½è¸ªå™¨ï¼ˆHUDï¼‰
        this.questTracker = new QuestTracker(this);
        this.questTracker.create();

        // åˆ›å»ºä»»åŠ¡æ—¥å¿—é¢æ¿
        this.questLogPanel = new QuestLogPanel(this);
        this.questLogPanel.create();

        // æ·»åŠ Qé”®ç›‘å¬å™¨ï¼ˆåˆ‡æ¢ä»»åŠ¡æ—¥å¿—ï¼‰
        this.input.keyboard.on('keydown-Q', () => {
            this.questLogPanel.toggle();
        });

        // ============ Milestone 6.6: æ·»åŠ Ié”®ç›‘å¬å™¨ï¼ˆåˆ‡æ¢ç‰©å“æ ï¼‰============
        this.input.keyboard.on('keydown-I', () => {
            this.toggleInventory();
        });

        // ============ Milestone 6.7: æ·»åŠ Cé”®ç›‘å¬å™¨ï¼ˆåˆ‡æ¢è£…å¤‡ç•Œé¢ï¼‰============
        this.input.keyboard.on('keydown-C', () => {
            this.toggleEquipment();
        });

        console.log('âœ… ä»»åŠ¡UIåˆå§‹åŒ–å®Œæˆ');
    }

    addSceneIndicator() {
        // åˆ›å»ºåœºæ™¯åç§°æ˜¾ç¤º
        const indicator = this.add.text(400, 30, 'å°é•‡', {
            font: '18px Press Start 2P',
            fill: '#ffffff',
            stroke: '#000000',
            strokeThickness: 4
        }).setOrigin(0.5).setDepth(90).setScrollFactor(0);

        this.sceneNameText = indicator;
    }

    updateSceneIndicator(sceneName) {
        const sceneNames = {
            'town': 'å°é•‡',
            'forest': 'æ£®æ—',
            'cave': 'æ´ç©´',
            'snow_mountain': 'é›ªå±±',
            'volcanic_cavern': 'ç«å±±'
        };

        if (this.sceneNameText) {
            this.sceneNameText.setText(sceneNames[sceneName] || sceneName);
        }

        // ============ Milestone 7 Sprint 6: æ›´æ–°å°åœ°å›¾åœºæ™¯åç§° ============
        if (this.minimapManager) {
            this.minimapManager.showSceneName(sceneName);
        }
    }

    updateUI() {
        // ============ æ€§èƒ½ä¼˜åŒ–ï¼šåªåœ¨å€¼å˜åŒ–æ—¶æ›´æ–°DOM ============

        // ç¼“å­˜DOMå…ƒç´ ï¼ˆé¦–æ¬¡è°ƒç”¨æ—¶ï¼‰
        if (!this.cachedDOMElements.levelText) {
            this.cachedDOMElements.levelText = document.getElementById('level-text');
            this.cachedDOMElements.goldText = document.getElementById('gold-text');
            this.cachedDOMElements.hpText = document.getElementById('hp-text');
            this.cachedDOMElements.hpBarFill = document.querySelector('#hp-bar .bar-fill');
            this.cachedDOMElements.xpText = document.getElementById('xp-text');
            this.cachedDOMElements.xpBarFill = document.querySelector('#xp-bar .bar-fill');
            // ============ Milestone 6: MP UI ============
            this.cachedDOMElements.mpText = document.getElementById('mp-text');
            this.cachedDOMElements.mpBarFill = document.querySelector('#mp-bar .bar-fill');
            // ============ v1.9.2: Critical Hit UI ============
            this.cachedDOMElements.critText = document.getElementById('crit-text');
            // ============ v1.9.3: Attack Power UI ============
            this.cachedDOMElements.attackText = document.getElementById('attack-text');
            // ============ v1.9.4: Defense Power UI ============
            this.cachedDOMElements.defenseText = document.getElementById('defense-text');
        }

        // å­˜å‚¨ä¸Šæ¬¡å€¼ä»¥æ£€æµ‹å˜åŒ–
        if (!this.lastUIValues) {
            this.lastUIValues = {
                hp: this.player.hp,
                maxHp: this.player.maxHp,
                xp: this.player.xp,
                xpToNextLevel: this.player.xpToNextLevel,
                level: this.player.level,
                gold: this.player.gold,
                // ============ Milestone 6: MP ============
                mp: this.player.mp || 50,
                maxMp: this.player.maxMp || 50,
                // ============ v1.9.2: Critical Hit ============
                critChance: this.player.critChance || 0.1,
                critDamage: this.player.critDamage || 0,
                // ============ v1.9.3: Attack Power ============
                attack: this.player.attack || 30,
                // ============ v1.9.4: Defense Power ============
                defense: this.player.defense || 0
            };
        }

        // åªåœ¨å€¼å˜åŒ–æ—¶æ›´æ–°DOM
        if (this.player.hp !== this.lastUIValues.hp || this.player.maxHp !== this.lastUIValues.maxHp) {
            const hpPercent = (this.player.hp / this.player.maxHp) * 100;
            this.cachedDOMElements.hpText.textContent = `${this.player.hp}/${this.player.maxHp}`;
            this.cachedDOMElements.hpBarFill.style.width = `${hpPercent}%`;
            this.lastUIValues.hp = this.player.hp;
            this.lastUIValues.maxHp = this.player.maxHp;
        }

        if (this.player.xp !== this.lastUIValues.xp || this.player.xpToNextLevel !== this.lastUIValues.xpToNextLevel) {
            const xpPercent = (this.player.xp / this.player.xpToNextLevel) * 100;
            this.cachedDOMElements.xpText.textContent = `${this.player.xp}/${this.player.xpToNextLevel}`;
            this.cachedDOMElements.xpBarFill.style.width = `${xpPercent}%`;
            this.lastUIValues.xp = this.player.xp;
            this.lastUIValues.xpToNextLevel = this.player.xpToNextLevel;
        }

        if (this.player.level !== this.lastUIValues.level) {
            this.cachedDOMElements.levelText.textContent = this.player.level;
            this.lastUIValues.level = this.player.level;
        }

        if (this.player.gold !== this.lastUIValues.gold) {
            this.cachedDOMElements.goldText.textContent = this.player.gold;
            this.lastUIValues.gold = this.player.gold;
        }

        // ============ v1.9.2: Critical Hit Update ============
        const critChance = this.player.critChance || 0.1;
        const critDamage = this.player.critDamage || 0;
        const critMultiplier = (1.5 + critDamage).toFixed(1);

        if (critChance !== this.lastUIValues.critChance || critDamage !== this.lastUIValues.critDamage) {
            this.cachedDOMElements.critText.textContent =
                `${(critChance * 100).toFixed(0)}% (${critMultiplier}x)`;
            this.lastUIValues.critChance = critChance;
            this.lastUIValues.critDamage = critDamage;
        }

        // ============ v1.9.3: Attack Power Update ============
        // è®¡ç®—æ€»æ”»å‡»åŠ› = åŸºç¡€æ”»å‡» + è£…å¤‡åŠ æˆ
        const equipmentAttack = this.equipmentManager ? this.equipmentManager.stats.attack : 0;
        const totalAttack = (this.player.attack || 30) + equipmentAttack;

        if (totalAttack !== this.lastUIValues.attack) {
            this.cachedDOMElements.attackText.textContent = totalAttack;
            this.lastUIValues.attack = totalAttack;
        }

        // ============ v1.9.4: Defense Power Update ============
        // é˜²å¾¡åŠ›å·²é€šè¿‡EquipmentManager.applyStatsToPlayer()åº”ç”¨åˆ°ç©å®¶å¯¹è±¡
        // è¿™é‡Œç›´æ¥æ˜¾ç¤ºplayer.defenseï¼ˆå·²åŒ…å«åŸºç¡€é˜²å¾¡ + è£…å¤‡åŠ æˆï¼‰
        const totalDefense = this.player.defense || 0;

        if (totalDefense !== this.lastUIValues.defense) {
            this.cachedDOMElements.defenseText.textContent = totalDefense;
            this.lastUIValues.defense = totalDefense;
        }

        // ============ Milestone 6: MP Update ============
        const currentMp = this.player.mp || 50;
        const currentMaxMp = this.player.maxMp || 50;
        if (currentMp !== this.lastUIValues.mp || currentMaxMp !== this.lastUIValues.maxMp) {
            const mpPercent = (currentMp / currentMaxMp) * 100;
            this.cachedDOMElements.mpText.textContent = Math.floor(currentMp) + '/' + currentMaxMp;
            this.cachedDOMElements.mpBarFill.style.width = mpPercent + '%';
            this.lastUIValues.mp = currentMp;
            this.lastUIValues.maxMp = currentMaxMp;
        }
    }

    update(time, delta) {
        // ============ Milestone 6: æ›´æ–°èµ„æºç³»ç»Ÿå’ŒæŠ€èƒ½å†·å´ ============
        if (this.resourceManager) {
            this.resourceManager.update(time, delta);
        }
        if (this.skillSystem) {
            this.skillSystem.updateCooldowns(delta);
        }

        // ============ Milestone 6.5: æ›´æ–°è¿å‡»ç³»ç»Ÿ ============
        if (this.comboSystem) {
            this.comboSystem.update(time, delta);
        }

        // ============ Milestone 7: æ›´æ–°çŠ¶æ€æ•ˆæœç³»ç»Ÿ ============
        if (this.statusEffectSystem) {
            this.statusEffectSystem.update(time, delta);
        }

        // ============ æ›´æ–°å¼±ç‚¹æŒ‡ç¤ºå™¨ä½ç½® ============
        if (this.damageTypeManager && this.combatSystem) {
            const enemies = this.combatSystem.getEnemiesGroup();
            if (enemies) {
                enemies.getChildren().forEach(enemy => {
                    // ... ç°æœ‰ä»£ç  ...
                });
            }
        }

        // ============ ğŸ¾ å® ç‰©ç³»ç»Ÿæ›´æ–° ============
        if (this.pet && this.pet.active) {
            this.pet.update(time, delta);
        }

        // ============ ğŸŒ¤ï¸ ç¯å¢ƒç‰¹æ•ˆç³»ç»Ÿæ›´æ–° ============
        // æ›´æ–°æ˜¼å¤œå¾ªç¯
        if (this.dayNightManager) {
            this.dayNightManager.update(delta);
        }

        // æ›´æ–°å¤©æ°”ç²’å­
        if (this.weatherParticles) {
            this.weatherParticles.update(time, delta);
        }

        // æ›´æ–°åŠ¨æ€å…‰ç…§
        if (this.lightingManager) {
            this.lightingManager.update(time, delta);

            // æ›´æ–°ç©å®¶å…‰æºä½ç½®
            if (this.player && this.playerLightId) {
                this.lightingManager.updateLightPosition(
                    this.playerLightId,
                    this.player.x,
                    this.player.y
                );
            }
        }

        // ============ æ›´æ–°å¼±ç‚¹æŒ‡ç¤ºå™¨ä½ç½® ============
        if (this.damageTypeManager && this.combatSystem) {
            const enemies = this.combatSystem.getEnemiesGroup();
            if (enemies) {
                enemies.getChildren().forEach(enemy => {
                // å‘å·¦ç§»åŠ¨æ—¶flipX
                if (!this.player.flipX) {
                    this.player.flipX = true;
                });
            
            } else if (this.cursors.right.isDown || this.wasd.right.isDown) {
                velocityX = this.player.speed;
                this.player.facing = 'side';
                this.player.lastDirection = 'right';
                newAnimation = 'walk-side';
                // å‘å³ç§»åŠ¨æ—¶ä¸flipX
                if (this.player.flipX) {
                    this.player.flipX = false;
                }
            } else if (this.cursors.up.isDown || this.wasd.up.isDown) {
                velocityY = -this.player.speed;
                this.player.facing = 'back';
                this.player.lastDirection = 'up';
                newAnimation = 'walk-back';
                // ä¸Šä¸‹ç§»åŠ¨ä¿æŒä¹‹å‰çš„å·¦å³æœå‘
            } else if (this.cursors.down.isDown || this.wasd.down.isDown) {
                velocityY = this.player.speed;
                this.player.facing = 'front';
                this.player.lastDirection = 'down';
                newAnimation = 'walk-front';
            }

            // æ’­æ”¾æˆ–åœæ­¢åŠ¨ç”»
            if (newAnimation && newAnimation !== this.player.currentAnimation) {
                this.player.anims.play(newAnimation, true);
                this.player.currentAnimation = newAnimation;
            } else if (!newAnimation && this.player.currentAnimation) {
                // åœæ­¢ç§»åŠ¨æ—¶åœæ­¢åŠ¨ç”»ï¼Œæ˜¾ç¤ºidleå¸§
                this.player.anims.stop();
                this.player.currentAnimation = null;

                // è®¾ç½®ä¸ºå¯¹åº”çš„idleçº¹ç†
                const idleTexture = `hero-idle-${this.player.facing}`;
                this.player.setTexture(idleTexture);
            }

            this.player.setVelocity(velocityX, velocityY);
        }

        // ============ æ•ŒäººAI ============
        const enemies = this.combatSystem ? this.combatSystem.getEnemiesGroup() : null;
        if (enemies && enemies.getChildren().length > 0) {
            enemies.getChildren().forEach(enemy => {
                // éªŒè¯æ•Œäººæ˜¯æ´»è·ƒçš„
                if (!enemy.active) return;

                const behavior = enemy.getData('behavior');
                const type = enemy.getData('type');
                let speed = enemy.getData('speed');
                let velocityX = 0;
                let velocityY = 0;

                // æ ¹æ®æ•Œäººç±»å‹åº”ç”¨ä¸åŒAIè¡Œä¸º
                if (behavior === 'flying' && type === 'bat') {
                    // è™è ï¼šé£è¡Œæ•Œäººï¼Œç§»åŠ¨é€Ÿåº¦æ›´å¿«ä¸”éš¾ä»¥é¢„æµ‹
                    const angle = Phaser.Math.Angle.Between(
                        enemy.x,
                        enemy.y,
                        this.player.x,
                        this.player.y
                    );

                    // è™è ä¼šé—´æ­‡æ€§åœ°æ”¹å˜æ–¹å‘ï¼ˆéš¾ä»¥å‘½ä¸­ï¼‰
                    if (!enemy.getData('lastDirectionChange') ||
                        this.time.now - enemy.getData('lastDirectionChange') > 1500) {
                        const randomOffset = (Math.random() - 0.5) * 1.5; // Â±75åº¦éšæœºåç§»
                        enemy.setData('directionOffset', randomOffset);
                        enemy.setData('lastDirectionChange', this.time.now);
                    }

                    const directionOffset = enemy.getData('directionOffset') || 0;
                    velocityX = Math.cos(angle + directionOffset) * speed;
                    velocityY = Math.sin(angle + directionOffset) * speed;

                    // è™è æœ‰æ—¶ä¼šå‘ä¸Šé£è¡Œï¼ˆåˆ©ç”¨å‚ç›´ç©ºé—´ï¼‰
                    if (enemy.getData('verticalMovement') && Math.random() < 0.02) {
                        velocityY -= speed * 0.5; // å‘ä¸Šå†²åˆº
                    }

                } else if (behavior === 'undead' && type === 'skeleton') {
                    // éª·é«…ï¼šç¼“æ…¢ä½†ç¨³å®šï¼Œä¼šç›´å†²å‘ç©å®¶
                    const angle = Phaser.Math.Angle.Between(
                        enemy.x,
                        enemy.y,
                        this.player.x,
                        this.player.y
                    );

                    // éª·é«…ç§»åŠ¨è¾ƒæ…¢ä½†ä¸ä¼šæ”¹å˜æ–¹å‘
                    velocityX = Math.cos(angle) * speed;
                    velocityY = Math.sin(angle) * speed;

                } else if (behavior === 'elite' && enemy.getData('isElite')) {
                    // ç²¾è‹±æ•Œäººï¼šæ ¹æ®ç‰¹æ®Šèƒ½åŠ›æœ‰ä¸åŒçš„è¡Œä¸º
                    const specialAbility = enemy.getData('specialAbility');
                    const angle = Phaser.Math.Angle.Between(
                        enemy.x,
                        enemy.y,
                        this.player.x,
                        this.player.y
                    );

                    if (specialAbility === 'burrow_ambush' && type === 'elite_mole_king') {
                        // å·¨å‹é¼¹é¼ ç‹ï¼šé—´æ­‡æ€§åŠ é€Ÿå†²é”‹
                        if (!enemy.getData('burrowState')) {
                            enemy.setData('burrowState', 'normal');
                            enemy.setData('lastBurrowTime', 0);
                        }

                        const timeSinceLastBurrow = this.time.now - enemy.getData('lastBurrowTime');
                        if (timeSinceLastBurrow > 8000 && enemy.getData('burrowState') === 'normal') {
                            // æ¯8ç§’å°è¯•é’»åœ°å†²é”‹
                            if (Math.random() < 0.3) {
                                enemy.setData('burrowState', 'burrowing');
                                enemy.setData('burrowStartTime', this.time.now);
                                enemy.setData('lastBurrowTime', this.time.now);
                            }
                        }

                        if (enemy.getData('burrowState') === 'burrowing') {
                            // é’»åœ°çŠ¶æ€ï¼šé€Ÿåº¦æå‡50%ï¼ŒæŒç»­2ç§’
                            const burrowDuration = this.time.now - enemy.getData('burrowStartTime');
                            if (burrowDuration < 2000) {
                                const boostSpeed = speed * 1.5;
                                velocityX = Math.cos(angle) * boostSpeed;
                                velocityY = Math.sin(angle) * boostSpeed;
                            } else {
                                enemy.setData('burrowState', 'normal');
                            }
                        } else {
                            // æ­£å¸¸è¿½è¸ª
                            velocityX = Math.cos(angle) * speed;
                            velocityY = Math.sin(angle) * speed;
                        }

                    } else if (specialAbility === 'root_bind_heal' && type === 'elite_ancient_treant') {
                        // è¿œå¤æ ‘å¦–ï¼šç¼“æ…¢ç§»åŠ¨ï¼Œå‘¨æœŸæ€§æ²»ç–—å‘¨å›´ç›Ÿå‹
                        if (!enemy.getData('healCooldown')) {
                            enemy.setData('healCooldown', 0);
                        }

                        // æ¯10ç§’å°è¯•æ²»ç–—é™„è¿‘ç›Ÿå‹
                        if (this.time.now - enemy.getData('healCooldown') > 10000) {
                            const enemies = this.combatSystem ? this.combatSystem.getEnemiesGroup() : null;
                            if (!enemies) return;

                            const nearbyAllies = enemies.getChildren().filter(e => {
                                return e.active && e !== enemy &&
                                    Phaser.Math.Distance.Between(e.x, e.y, enemy.x, enemy.y) < 150;
                            });

                            if (nearbyAllies.length > 0) {
                                // æ²»ç–—é™„è¿‘ç›Ÿå‹ï¼ˆæ¢å¤20% HPï¼‰
                                nearbyAllies.forEach(ally => {
                                    const currentHp = ally.getData('hp');
                                    const maxHp = ally.getData('maxHp');
                                    const healAmount = Math.floor(maxHp * 0.2);
                                    ally.setData('hp', Math.min(maxHp, currentHp + healAmount));
                                });
                                enemy.setData('healCooldown', this.time.now);
                                console.log(`ğŸŒ¿ è¿œå¤æ ‘å¦–æ²»ç–—äº† ${nearbyAllies.length} ä¸ªç›Ÿå‹`);
                            }
                        }

                        // ç§»åŠ¨ç¼“æ…¢
                        velocityX = Math.cos(angle) * speed;
                        velocityY = Math.sin(angle) * speed;

                    } else if (specialAbility === 'split_on_death' && type === 'elite_mutated_slime') {
                        // å˜å¼‚å²è±å§†ï¼šç§»åŠ¨é€Ÿåº¦é€‚ä¸­ï¼Œåœ¨æ­»äº¡æ—¶åˆ†è£‚ï¼ˆåœ¨å‡»æ€é€»è¾‘ä¸­å¤„ç†ï¼‰
                        velocityX = Math.cos(angle) * speed;
                        velocityY = Math.sin(angle) * speed;
                    } else {
                        // é»˜è®¤ç²¾è‹±è¡Œä¸º
                        velocityX = Math.cos(angle) * speed;
                        velocityY = Math.sin(angle) * speed;
                    }

                } else {
                    // é»˜è®¤AIï¼šç®€å•è¿½è¸ª
                    const angle = Phaser.Math.Angle.Between(
                        enemy.x,
                        enemy.y,
                        this.player.x,
                        this.player.y
                    );

                    velocityX = Math.cos(angle) * speed;
                    velocityY = Math.sin(angle) * speed;
                }

                enemy.setVelocity(velocityX, velocityY);

                // æ›´æ–°è¡€æ¡ä½ç½®è·Ÿéšæ•Œäºº
                if (enemy.hpBar && enemy.hpBarBg) {
                    enemy.hpBarBg.setPosition(enemy.x, enemy.y - 25);
                    enemy.hpBar.setPosition(enemy.x, enemy.y - 25);
                }

                // ç¢°æ’æ£€æµ‹ï¼šæ•Œäººç¢°åˆ°ç©å®¶
                // ç©å®¶å’Œæ•Œäººéƒ½æ˜¯32x32åŸºç¡€å°ºå¯¸ï¼Œscaleä¸º3ï¼Œå®é™…å°ºå¯¸ä¸º96x96
                // ç¢°æ’è·ç¦»è®¾ç½®ä¸º60ï¼Œç¡®ä¿ç²¾çµå®é™…æ¥è§¦æ—¶æ‰è§¦å‘ä¼¤å®³
                const collisionDistance = 60;
                const distance = Phaser.Math.Distance.Between(enemy.x, enemy.y, this.player.x, this.player.y);

                if (distance < collisionDistance) {
                    this.playerHitByEnemy(enemy);
                }
            });
        }

        // ============ Bossæ›´æ–° ============
        if (this.sceneManager && this.sceneManager.boss) {
            this.sceneManager.boss.update(this.time.now, this.game.loop.delta, this.player);
        }

        // ============ æ€§èƒ½ä¼˜åŒ–ï¼šæ¯ç§’æ›´æ–°ä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯ ============
        if (window.gameData && window.gameData.progress && window.gameData.progress.sessionStartTime) {
            const now = Date.now();
            // åªåœ¨è·ç¦»ä¸Šæ¬¡æ›´æ–°è¶…è¿‡1000msæ—¶æ›´æ–°ï¼ˆèŠ‚æµï¼‰
            if (now - window.gameData.progress.lastPlaytimeUpdate >= 1000) {
                const elapsedSeconds = Math.floor((now - window.gameData.progress.sessionStartTime) / 1000);
                window.gameData.progress.playtimeSeconds = elapsedSeconds;
                window.gameData.progress.lastPlaytimeUpdate = now;
            }
        }
    }

    playerHitByEnemy(enemy) {
        // åœºæ™¯åˆ‡æ¢æ—¶ä¸å—åˆ°ä¼¤å®³
        if (this.sceneManager?.isTransitioning) return;

        // éªŒè¯æ•Œäººå¯¹è±¡æœ‰æ•ˆ
        if (!enemy || !enemy.active) {
            return;
        }

        // æ£€æŸ¥æ•Œäººæ˜¯å¦åœ¨å†·å´ä¸­ï¼ˆé˜²æ­¢åŒä¸€æ•Œäººè¿ç»­ä¼¤å®³ï¼‰
        const now = this.time.now;
        const lastHitTime = enemy.getData('lastHitTime') || 0;
        const enemyCooldown = 1000; // æ•Œäººæ”»å‡»å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

        if (now - lastHitTime < enemyCooldown) {
            return; // è¯¥æ•Œäººè¿˜åœ¨å†·å´ä¸­
        }

        // æ£€æŸ¥ç©å®¶æ˜¯å¦å¤„äºæ— æ•ŒçŠ¶æ€
        if (this.player.getData('invincible')) {
            return;
        }

        // ============ v1.9.4: é˜²å¾¡åŠ›è®¡ç®— ============
        // è®¡ç®—æ•Œäººæ”»å‡»åŠ›
        const enemyAttack = enemy.getData('attack') || 5;

        // è®¡ç®—æ€»é˜²å¾¡åŠ›ï¼ˆåŸºç¡€é˜²å¾¡ + è£…å¤‡é˜²å¾¡ï¼‰
        const totalDefense = this.player.defense || 0;

        // è®¡ç®—æœ€ç»ˆä¼¤å®³ï¼ˆè‡³å°‘1ç‚¹ä¼¤å®³ï¼‰
        const damage = Math.max(1, enemyAttack - totalDefense);

        const oldHp = this.player.hp;
        this.player.hp = Math.max(0, this.player.hp - damage);

        console.log(`ğŸ›¡ï¸ é˜²å¾¡è®¡ç®—: æ•Œäººæ”»å‡»${enemyAttack} - é˜²å¾¡${totalDefense} = ä¼¤å®³${damage}`);
        console.log(`ğŸ’” Player hit by ${enemy.getData('type')}! HP: ${oldHp} â†’ ${this.player.hp}`);

        // æ›´æ–°è¯¥æ•Œäººçš„æœ€åæ”»å‡»æ—¶é—´
        enemy.setData('lastHitTime', now);

        // æ˜¾ç¤ºä¼¤å®³æ•°å­—
        this.combatSystem.showDamageNumber(this.player.x, this.player.y, damage, '#ff4444');

        // è®¾ç½®ç©å®¶æ— æ•Œæ—¶é—´ï¼ˆè§†è§‰åé¦ˆ + é˜²æ­¢è¿ç»­å—ä¼¤ï¼‰
        this.player.setData('invincible', true);
        this.player.setAlpha(0.5);

        // å±å¹•éœ‡åŠ¨æ•ˆæœ
        this.cameras.main.shake(100, 0.01);

        this.time.delayedCall(1000, () => {
            this.player.setData('invincible', false);
            this.player.setAlpha(1);
        });

        // æ£€æŸ¥ç©å®¶æ˜¯å¦æ­»äº¡
        if (this.player.hp <= 0) {
            this.gameOver();
        }

        this.updateUI();
    }

    /**
     * æ£€æŸ¥æ˜¯å¦å­˜åœ¨å­˜æ¡£æ•°æ®
     */
    checkSaveData() {
        if (this.saveManager.hasSaveData()) {
            const saveInfo = this.saveManager.getSaveInfo();
            console.log('ğŸ“¦ å‘ç°å­˜æ¡£:', saveInfo);

            // æ˜¾ç¤ºåŠ è½½æç¤º
            this.time.delayedCall(1000, () => {
                this.showLoadPrompt(saveInfo);
            });
        }
    }

    /**
     * æ˜¾ç¤ºåŠ è½½æç¤ºå¯¹è¯æ¡†
     */
    showLoadPrompt(saveInfo) {
        const message = `å‘ç°å­˜æ¡£ï¼\nç­‰çº§: ${saveInfo.level}\nåœºæ™¯: ${saveInfo.scene}\næ—¶é—´: ${saveInfo.timestamp}\n\næŒ‰ Y åŠ è½½å­˜æ¡£\næŒ‰ N å¼€å§‹æ–°æ¸¸æˆ`;

        // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
        const dialogBg = this.add.rectangle(400, 300, 600, 400, 0x222222);
        dialogBg.setStrokeStyle(3, 0x68d391);
        dialogBg.setDepth(100);

        // åˆ›å»ºå¯¹è¯æ¡†æ–‡å­—
        const dialogText = this.add.text(400, 300, message, {
            font: '16px Noto Sans SC',
            fill: '#ffffff',
            align: 'center',
            lineSpacing: 10
        }).setOrigin(0.5);
        dialogText.setDepth(101);

        // åˆ›å»ºä¸´æ—¶è¦†ç›–å±‚é˜»æ­¢è¾“å…¥
        const inputBlocker = this.add.rectangle(400, 300, 800, 600, 0x000000, 0);
        inputBlocker.setDepth(99);
        inputBlocker.setInteractive();

        // ç›‘å¬Yå’ŒNé”®
        const handleChoice = (event) => {
            if (event.keyCode === Phaser.Input.Keyboard.KeyCodes.Y) {
                // åŠ è½½å­˜æ¡£
                dialogBg.destroy();
                dialogText.destroy();
                inputBlocker.destroy();
                this.input.keyboard.off('keydown', handleChoice);
                this.loadGameWithDelay();
            } else if (event.keyCode === Phaser.Input.Keyboard.KeyCodes.N) {
                // å¼€å§‹æ–°æ¸¸æˆ
                dialogBg.destroy();
                dialogText.destroy();
                inputBlocker.destroy();
                this.input.keyboard.off('keydown', handleChoice);
                this.showFloatingText(400, 300, 'å¼€å§‹æ–°æ¸¸æˆ!', '#68d391');
            }
        };

        this.input.keyboard.on('keydown', handleChoice);

        // ç‚¹å‡»ä¹Ÿå¯å…³é—­ï¼ˆé€‰æ‹©ä¸åŠ è½½ï¼‰
        inputBlocker.on('pointerdown', () => {
            dialogBg.destroy();
            dialogText.destroy();
            inputBlocker.destroy();
            this.input.keyboard.off('keydown', handleChoice);
        });
    }

    /**
     * å»¶è¿ŸåŠ è½½æ¸¸æˆï¼ˆç­‰å¾…åœºæ™¯åˆå§‹åŒ–å®Œæˆï¼‰
     */
    loadGameWithDelay() {
        this.time.delayedCall(500, () => {
            this.saveManager.loadGame();
        });
    }

    /**
     * å¿«é€Ÿä¿å­˜æ¸¸æˆ
     */
    quickSave() {
        const success = this.saveManager.saveGame();
        if (success) {
            this.showFloatingText(400, 300, 'æ¸¸æˆå·²ä¿å­˜!', '#68d391');
        }
    }

    /**
     * å¿«é€ŸåŠ è½½æ¸¸æˆ
     */
    quickLoad() {
        if (!this.saveManager.hasSaveData()) {
            this.showFloatingText(400, 300, 'æœªæ‰¾åˆ°å­˜æ¡£!', '#ff6b6b');
            return;
        }

        this.saveManager.loadGame();
    }

    /**
     * ============ Milestone 6.3: æ‰“å¼€è®¾ç½®ç•Œé¢ ============
     */
    openSettings() {
        // æš‚åœæ¸¸æˆç‰©ç†ç³»ç»Ÿ
        this.physics.pause();

        // æš‚åœå½“å‰åœºæ™¯
        this.scene.pause();

        // å¯åŠ¨è®¾ç½®åœºæ™¯ï¼ˆä½œä¸ºå åŠ åœºæ™¯ï¼‰
        this.scene.launch('SettingsScene');

        console.log('âš™ï¸ æ‰“å¼€è®¾ç½®ç•Œé¢');
    }

    /**
     * ============ Milestone 6.6: åˆ‡æ¢ç‰©å“æ  ============
     */
    toggleInventory() {
        if (!this.inventoryUI) {
            console.warn('âš ï¸ InventoryUIæœªåˆå§‹åŒ–');
            return;
        }

        this.inventoryUI.toggle();

        console.log('ğŸ’ åˆ‡æ¢ç‰©å“æ ');
    }

    /**
     * ============ Milestone 6.7: åˆ‡æ¢è£…å¤‡ç•Œé¢ ============
     */
    toggleEquipment() {
        if (!this.equipmentUI) {
            console.warn('âš ï¸ EquipmentUIæœªåˆå§‹åŒ–');
            return;
        }

        this.equipmentUI.toggle();

        console.log('ğŸ›¡ï¸ åˆ‡æ¢è£…å¤‡ç•Œé¢');
    }

    /**
     * ============ Milestone 7 Sprint 5: ç»ˆå±€å†…å®¹ ============
     */

    /**
     * å¼€å§‹Boss Rushæ¨¡å¼
     */
    startBossRush() {
        // æ£€æŸ¥æ˜¯å¦å·²ç»å®Œæˆæ¸¸æˆ
        const dragonLordQuest = this.questManager.getQuest('quest_11_dragon_lord');
        const hasBeatenGame = dragonLordQuest && dragonLordQuest.status === 'completed';

        if (!hasBeatenGame) {
            this.showFloatingText(400, 300, 'ğŸ”’ éœ€è¦å…ˆå‡»è´¥é¾™ç‹!', '#ff6b6b', 3000);
            return;
        }

        if (!this.bossRushManager) {
            this.showFloatingText(400, 300, 'âš ï¸ Boss Rushç®¡ç†å™¨æœªåˆå§‹åŒ–!', '#ff0000');
            return;
        }

        // å¯åŠ¨Boss Rush
        const success = this.bossRushManager.startBossRush();

        if (success) {
            // åˆ‡æ¢åˆ°ç‰¹æ®ŠBoss Rushåœºæ™¯ï¼ˆä½¿ç”¨æ´ç©´åœºæ™¯ä½œä¸ºèƒŒæ™¯ï¼‰
            this.sceneManager.switchScene('cave', { x: 400, y: 450 });

            // ç›‘å¬Bosså‡»è´¥äº‹ä»¶
            this.events.on('bossDefeated', (bossType) => {
                if (this.bossRushManager.isActive) {
                    this.bossRushManager.onBossDefeated(bossType);
                }
            });

            // ç›‘å¬ç©å®¶æ­»äº¡äº‹ä»¶
            this.events.once('playerDeath', () => {
                if (this.bossRushManager.isActive) {
                    this.bossRushManager.onPlayerDeath();
                }
            });
        }
    }

    /**
     * å¼€å§‹æ— å°½åœ°ç‰¢æ¨¡å¼
     */
    startInfiniteDungeon() {
        // æ£€æŸ¥æ˜¯å¦å·²ç»å‡»è´¥æ ‘å¦–ç‹ï¼ˆè§£é”æ— å°½åœ°ç‰¢ï¼‰
        const treantKingQuest = this.questManager.getQuest('quest_3_boss');
        const hasBeatenTreant = treantKingQuest && treantKingQuest.status === 'completed';

        if (!hasBeatenTreant) {
            this.showFloatingText(400, 300, 'ğŸ”’ éœ€è¦å…ˆå‡»è´¥æ ‘å¦–ç‹!', '#ff6b6b', 3000);
            return;
        }

        if (!this.infiniteDungeonManager) {
            this.showFloatingText(400, 300, 'âš ï¸ æ— å°½åœ°ç‰¢ç®¡ç†å™¨æœªåˆå§‹åŒ–!', '#ff0000');
            return;
        }

        // å¯åŠ¨æ— å°½åœ°ç‰¢
        const success = this.infiniteDungeonManager.startInfiniteDungeon();

        if (success) {
            // åˆ‡æ¢åˆ°æ´ç©´åœºæ™¯ä½œä¸ºåœ°ç‰¢èƒŒæ™¯
            this.sceneManager.switchScene('cave', { x: 400, y: 450 });

            // ç›‘å¬ç©å®¶æ­»äº¡äº‹ä»¶
            this.events.once('playerDeath', () => {
                if (this.infiniteDungeonManager.isActive) {
                    this.infiniteDungeonManager.onPlayerDeath();
                }
            });
        }
    }

    /**
     * å¼€å§‹ç”Ÿå­˜ç«æŠ€åœº
     */
    startSurvivalArena() {
        if (!this.arenaManager) {
            this.showFloatingText(400, 300, 'âš ï¸ ç«æŠ€åœºç®¡ç†å™¨æœªåˆå§‹åŒ–!', '#ff0000');
            return;
        }

        // å¯åŠ¨ç”Ÿå­˜ç«æŠ€åœº
        const success = this.arenaManager.startSurvivalArena();

        if (success) {
            // åˆ‡æ¢åˆ°æ´ç©´åœºæ™¯ä½œä¸ºç«æŠ€åœºèƒŒæ™¯
            this.sceneManager.switchScene('cave', { x: 400, y: 450 });

            // ç›‘å¬ç©å®¶æ­»äº¡äº‹ä»¶
            this.events.once('playerDeath', () => {
                if (this.arenaManager.isActive) {
                    this.arenaManager.onPlayerDeath();
                }
            });

            // ç›‘å¬æ•Œäººæ­»äº¡äº‹ä»¶
            this.events.on('enemyDeath', () => {
                if (this.arenaManager.isActive) {
                    this.arenaManager.onEnemyDeath();
                }
            });
        }
    }

    /**
     * å¼€å§‹é™æ—¶æŒ‘æˆ˜
     */
    startTimeAttackArena() {
        if (!this.arenaManager) {
            this.showFloatingText(400, 300, 'âš ï¸ ç«æŠ€åœºç®¡ç†å™¨æœªåˆå§‹åŒ–!', '#ff0000');
            return;
        }

        // å¯åŠ¨é™æ—¶æŒ‘æˆ˜
        const success = this.arenaManager.startTimeAttackArena();

        if (success) {
            // åˆ‡æ¢åˆ°æ´ç©´åœºæ™¯ä½œä¸ºç«æŠ€åœºèƒŒæ™¯
            this.sceneManager.switchScene('cave', { x: 400, y: 450 });

            // ç›‘å¬ç©å®¶æ­»äº¡äº‹ä»¶
            this.events.once('playerDeath', () => {
                if (this.arenaManager.isActive) {
                    this.arenaManager.onPlayerDeath();
                }
            });

            // ç›‘å¬æ•Œäººæ­»äº¡äº‹ä»¶
            this.events.on('enemyDeath', () => {
                if (this.arenaManager.isActive) {
                    this.arenaManager.onEnemyDeath();
                }
            });
        }
    }

    /**
     * å¼€å§‹äºŒå‘¨ç›®
     */
    startNewGamePlus() {
        if (!this.newGamePlusManager) {
            this.showFloatingText(400, 300, 'âš ï¸ äºŒå‘¨ç›®ç®¡ç†å™¨æœªåˆå§‹åŒ–!', '#ff0000');
            return;
        }

        // å¯åŠ¨äºŒå‘¨ç›®
        const success = this.newGamePlusManager.startNewGamePlus();

        if (success) {
            // åˆ·æ–°UIæ˜¾ç¤º
            this.updateUI();
        }
    }

    gameOver() {
        console.log('ğŸ’€ ç©å®¶æ­»äº¡ - æ˜¾ç¤ºå¤æ´»é€‰é¡¹');

        // æš‚åœæ¸¸æˆï¼ˆä¸å®Œå…¨æš‚åœï¼Œå…è®¸åŠ¨ç”»æ’­æ”¾ï¼‰
        this.physics.pause();

        // æ ‡è®°ç©å®¶æ­»äº¡çŠ¶æ€
        this.player.isDead = true;

        // åˆ›å»ºåŠé€æ˜é»‘è‰²èƒŒæ™¯
        const overlay = this.add.rectangle(400, 300, 800, 600, 0x000000, 0.85);
        overlay.setDepth(600);

        // æ­»äº¡æ ‡é¢˜
        const deathTitle = this.add.text(400, 180, 'ä½ å·²æ­»äº¡', {
            fontFamily: 'Press Start 2P',
            fontSize: '48px',
            fill: '#ff4444',
            stroke: '#000000',
            strokeThickness: 8
        }).setOrigin(0.5).setDepth(601);

        const deathSubtitle = this.add.text(400, 240, 'YOU DIED', {
            fontFamily: 'Press Start 2P',
            fontSize: '32px',
            fill: '#ff6666',
            stroke: '#000000',
            strokeThickness: 6
        }).setOrigin(0.5).setDepth(601);

        // å¤æ´»é€‰é¡¹
        const reviveOption = this.add.text(400, 320, 'æŒ‰ V é”®æˆ– ç©ºæ ¼é”® å¤æ´»\næ¢å¤ 50% ç”Ÿå‘½å€¼\næ¸…é™¤é™„è¿‘æ•Œäºº\n3ç§’æ— æ•Œæ—¶é—´', {
            fontFamily: 'Noto Sans SC',
            fontSize: '20px',
            fill: '#68d391',
            stroke: '#000000',
            strokeThickness: 4,
            align: 'center',
            lineSpacing: 10
        }).setOrigin(0.5).setDepth(601);

        // åˆ†éš”çº¿
        const divider = this.add.text(400, 420, 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', {
            fontFamily: 'monospace',
            fontSize: '18px',
            fill: '#666666'
        }).setOrigin(0.5).setDepth(601);

        // é‡å¯é€‰é¡¹
        const restartOption = this.add.text(400, 460, 'æŒ‰ R é”®é‡æ–°å¼€å§‹æ¸¸æˆ', {
            fontFamily: 'Noto Sans SC',
            fontSize: '16px',
            fill: '#ffd700',
            stroke: '#000000',
            strokeThickness: 3
        }).setOrigin(0.5).setDepth(601);

        // é—ªçƒæ•ˆæœ - å¤æ´»é€‰é¡¹
        this.tweens.add({
            targets: reviveOption,
            alpha: 0.5,
            duration: 800,
            yoyo: true,
            repeat: -1,
            ease: 'Sine.easeInOut'
        });

        // ä¿å­˜UIå¼•ç”¨ä»¥ä¾¿æ¸…ç†
        this.deathUI = {
            overlay: overlay,
            deathTitle: deathTitle,
            deathSubtitle: deathSubtitle,
            reviveOption: reviveOption,
            divider: divider,
            restartOption: restartOption
        };

        // ç›‘å¬å¤æ´»é”®ï¼ˆVé”®æˆ–ç©ºæ ¼é”®ï¼‰
        this.reviveKey = this.input.keyboard.addKeys({
            v: Phaser.Input.Keyboard.KeyCodes.V,
            space: Phaser.Input.Keyboard.KeyCodes.SPACE
        });

        this.reviveKey.v.on('down', () => {
            this.revivePlayer();
        });

        this.reviveKey.space.on('down', () => {
            this.revivePlayer();
        });

        // ç›‘å¬Ré”®é‡å¯ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
        this.restartKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.R);
        this.restartKey.on('down', () => {
            this.scene.restart();
        });

        // è®°å½•æ¸¸æˆç»“æŸæ—¶çš„ç»Ÿè®¡
        const finalStats = this.getGameStats();
        console.log('ğŸ“Š æœ€ç»ˆç»Ÿè®¡:', finalStats);
    }

    /**
     * å¤æ´»ç©å®¶
     * æ¢å¤50%ç”Ÿå‘½å€¼ï¼Œæ¸…é™¤é™„è¿‘æ•Œäººï¼Œç»™äºˆæ— æ•Œæ—¶é—´
     */
    revivePlayer() {
        console.log('âœ¨ ç©å®¶å¤æ´»');

        // ç§»é™¤å¤æ´»UI
        if (this.deathUI) {
            Object.values(this.deathUI).forEach(element => {
                if (element && element.active) element.destroy();
            });
            this.deathUI = null;
        }

        // æ¸…ç†é”®ç›˜ç›‘å¬
        if (this.reviveKey) {
            this.reviveKey.v.off('down');
            this.reviveKey.space.off('down');
            this.reviveKey = null;
        }

        if (this.restartKey) {
            this.restartKey.off('down');
            this.restartKey = null;
        }

        // æ¢å¤50%ç”Ÿå‘½å€¼
        const reviveHP = Math.floor(this.player.maxHp * 0.5);
        this.player.hp = reviveHP;

        // é‡ç½®æ­»äº¡çŠ¶æ€
        this.player.isDead = false;

        // æ¢å¤ç‰©ç†ç³»ç»Ÿ
        this.physics.resume();

        // æ›´æ–°UI
        this.updateUI();

        // æ˜¾ç¤ºå¤æ´»æç¤º
        this.showFloatingText(this.player.x, this.player.y - 50, `å¤æ´»ï¼HP +${reviveHP}`, '#68d391');

        // æ¸…é™¤é™„è¿‘çš„æ•Œäººï¼ˆ200åƒç´ èŒƒå›´å†…ï¼‰
        const enemies = this.sceneManager?.enemies || this.enemies;
        if (enemies) {
            enemies.getChildren().forEach(enemy => {
                const distance = Phaser.Math.Distance.Between(
                    this.player.x, this.player.y,
                    enemy.x, enemy.y
                );
                if (distance < 200) {
                    // åˆ›å»ºæ•Œäººæ¶ˆå¤±æ•ˆæœ
                    this.combatSystem.showDamageNumber(enemy.x, enemy.y, 'æ¶ˆé™¤', '#888888');
                    enemy.destroy();
                }
            });
        }

        // ç»™äºˆ3ç§’æ— æ•Œæ—¶é—´
        this.player.isInvincible = true;
        this.player.invincibleTimer = this.time.delayedCall(3000, () => {
            this.player.isInvincible = false;
            this.player.invincibleTimer = null;
            this.showFloatingText(this.player.x, this.player.y - 30, 'æ— æ•Œæ—¶é—´ç»“æŸ', '#ff6b6b');
            console.log('â° æ— æ•Œæ—¶é—´ç»“æŸ');
        });

        // é—ªçƒæ•ˆæœè¡¨ç¤ºæ— æ•ŒçŠ¶æ€
        const invincibleBlink = this.tweens.add({
            targets: this.player,
            alpha: 0.3,
            duration: 200,
            yoyo: true,
            repeat: -1
        });

        // æ— æ•Œæ—¶é—´ç»“æŸååœæ­¢é—ªçƒ
        this.time.delayedCall(3000, () => {
            invincibleBlink.stop();
            this.player.setAlpha(1);
        });

        console.log(`âœ… å¤æ´»å®Œæˆ - HP: ${this.player.hp}/${this.player.maxHp}, æ— æ•Œ: 3ç§’`);
    }

    /**
     * è·å–æ¸¸æˆç»Ÿè®¡ä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•å’Œæ˜¾ç¤ºï¼‰
     */
    getGameStats() {
        const enemies = this.combatSystem ? this.combatSystem.getEnemiesGroup() : null;
        return {
            player: {
                level: this.player.level,
                hp: this.player.hp,
                maxHp: this.player.maxHp,
                xp: this.player.xp,
                gold: this.player.gold,
                attack: this.player.attack,
                position: { x: Math.round(this.player.x), y: Math.round(this.player.y) }
            },
            scene: {
                current: this.sceneManager.getCurrentScene(),
                enemies: enemies ? enemies.getChildren().length : 0
            },
            quests: this.questManager ? {
                stats: this.questManager.getStats(),
                active: this.questManager.getActiveQuests().map(q => ({
                    id: q.id,
                    name: q.name,
                    progress: q.getProgress()
                }))
            } : null,
            saveData: this.saveManager.hasSaveData() ? 'exists' : 'none',
            timestamp: new Date().toISOString()
        };
    }

    /**
     * è°ƒè¯•æ–¹æ³•ï¼šå¼€å§‹ä»»åŠ¡
     * @param {string} questId - ä»»åŠ¡ID
     */
    debugStartQuest(questId) {
        if (!this.questManager) {
            console.error('âŒ QuestManageræœªåˆå§‹åŒ–');
            return false;
        }

        const success = this.questManager.startQuest(questId);
        if (success) {
            console.log(`âœ… ä»»åŠ¡å·²å¼€å§‹: ${questId}`);
        } else {
            console.log(`âŒ ä»»åŠ¡å¼€å§‹å¤±è´¥: ${questId}`);
        }
        return success;
    }

    /**
     * è°ƒè¯•æ–¹æ³•ï¼šæ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡çŠ¶æ€
     */
    debugShowQuests() {
        if (!this.questManager) {
            console.error('âŒ QuestManageræœªåˆå§‹åŒ–');
            return;
        }

        console.log('ğŸ“‹ ä»»åŠ¡çŠ¶æ€:');
        console.log('================');

        const stats = this.questManager.getStats();
        console.log(`æ€»è®¡: ${stats.total} | è¿›è¡Œä¸­: ${stats.active} | å·²å®Œæˆ: ${stats.completed} | å¯æ¥å—: ${stats.available}`);
        console.log('');

        const activeQuests = this.questManager.getActiveQuests();
        if (activeQuests.length > 0) {
            console.log('ğŸ”µ æ¿€æ´»çš„ä»»åŠ¡:');
            activeQuests.forEach(quest => {
                const objective = quest.getCurrentObjective();
                console.log(`  - ${quest.name}`);
                if (objective) {
                    console.log(`    ${objective.description}: ${objective.current}/${objective.required}`);
                }
            });
        }

        const completedQuests = this.questManager.getCompletedQuests();
        if (completedQuests.length > 0) {
            console.log('âœ… å·²å®Œæˆçš„ä»»åŠ¡:');
            completedQuests.forEach(quest => {
                console.log(`  - ${quest.name}`);
            });
        }
    }

    /**
     * æ˜¾ç¤ºæ¸¸æˆç»Ÿè®¡ä¿¡æ¯
     * å¯ä»¥åœ¨æµè§ˆå™¨æ§åˆ¶å°è°ƒç”¨: window.game.scene.scenes.find(s => s.scene.key === 'GameScene').showStatistics()
     */
    showStatistics() {
        if (!window.gameData) {
            console.error('âŒ gameDataæœªåˆå§‹åŒ–');
            return;
        }

        console.log('\nğŸ“Š ===== æ¸¸æˆç»Ÿè®¡ =====');
        console.log('====================\n');

        // ç©å®¶ä¿¡æ¯
        console.log('ğŸ‘¤ ç©å®¶ä¿¡æ¯:');
        console.log(`  ç­‰çº§: ${this.player.level}`);
        console.log(`  é‡‘å¸: ${this.player.gold}`);
        console.log(`  ç»éªŒ: ${this.player.xp}/${this.player.xpToNextLevel}`);
        console.log('');

        // æ¸¸æˆæ—¶é—´
        if (window.gameData.progress) {
            const playtimeSeconds = window.gameData.progress.playtimeSeconds || 0;
            const hours = Math.floor(playtimeSeconds / 3600);
            const minutes = Math.floor((playtimeSeconds % 3600) / 60);
            const seconds = playtimeSeconds % 60;

            console.log('â±ï¸ æ¸¸æˆæ—¶é—´:');
            if (hours > 0) {
                console.log(`  ${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ ${seconds}ç§’`);
            } else if (minutes > 0) {
                console.log(`  ${minutes}åˆ†é’Ÿ ${seconds}ç§’`);
            } else {
                console.log(`  ${seconds}ç§’`);
            }
            console.log('');
        }

        // å‡»è´¥ç»Ÿè®¡
        if (window.gameData.progress) {
            console.log('âš”ï¸ æˆ˜æ–—ç»Ÿè®¡:');
            console.log(`  æ€»å‡»è´¥æ•°: ${window.gameData.progress.enemiesDefeated || 0}`);
            console.log(`  æ”¶é›†é‡‘å¸: ${window.gameData.progress.totalCoins || 0}`);
            console.log(`  æ”¶é›†å®çŸ³: ${window.gameData.progress.gemsCollected || 0}`);
            console.log('');
        }

        // æ•Œäººç±»å‹ç»Ÿè®¡
        if (window.gameData.enemiesDefeated) {
            console.log('ğŸ’€ æ•Œäººå‡»è´¥è¯¦æƒ…:');
            const enemies = window.gameData.enemiesDefeated;
            let hasData = false;

            for (const [type, count] of Object.entries(enemies)) {
                if (count > 0) {
                    hasData = true;
                    const displayName = type.startsWith('boss_') ? `ğŸ‘‘ Boss(${type.replace('boss_', '')})` : type;
                    console.log(`  ${displayName}: ${count}`);
                }
            }

            if (!hasData) {
                console.log('  å°šæœªå‡»è´¥ä»»ä½•æ•Œäºº');
            }
            console.log('');
        }

        // ä»»åŠ¡ç»Ÿè®¡
        if (this.questManager) {
            const questStats = this.questManager.getStats();
            console.log('ğŸ“œ ä»»åŠ¡ç»Ÿè®¡:');
            console.log(`  æ€»è®¡: ${questStats.total}`);
            console.log(`  è¿›è¡Œä¸­: ${questStats.active}`);
            console.log(`  å·²å®Œæˆ: ${questStats.completed}`);
            console.log(`  å¯æ¥å—: ${questStats.available}`);
            console.log('');
        }

        // æˆå°±ç»Ÿè®¡
        if (this.achievementManager) {
            const achievements = this.achievementManager.getAchievements();
            const unlockedCount = achievements.filter(a => a.unlocked).length;
            console.log('ğŸ† æˆå°±ç»Ÿè®¡:');
            console.log(`  å·²è§£é”: ${unlockedCount}/${achievements.length}`);
            console.log('');
        }

        console.log('====================');
        console.log('ğŸ“Š ç»Ÿè®¡ç»“æŸ\n');

        // åŒæ—¶åœ¨æ¸¸æˆä¸­æ˜¾ç¤ºç®€è¦ç»Ÿè®¡
        this.showFloatingText(400, 200, 'ğŸ“Š ç»Ÿè®¡å·²æ˜¾ç¤ºåœ¨æ§åˆ¶å°', '#68d391', 3000);
    }

    /**
     * åœºæ™¯é”€æ¯æ—¶æ¸…ç†èµ„æº
     * é˜²æ­¢å†…å­˜æ³„æ¼
     */
    destroy() {
        console.log('ğŸ§¹ æ¸…ç† GameScene èµ„æº');

        // æ¸…ç†å¯¹è±¡æ± 
        if (this.objectPool) {
            this.objectPool.destroy();
            this.objectPool = null;
        }

        // ============ Milestone 6.5: æ¸…ç†è¿å‡»ç³»ç»Ÿ ============
        if (this.comboSystem) {
            this.comboSystem.destroy();
            this.comboSystem = null;
        }

        // ============ Milestone 6.6: æ¸…ç†ç‰©å“æ ç³»ç»Ÿ ============
        if (this.inventoryUI) {
            this.inventoryUI.destroy();
            this.inventoryUI = null;
        }

        if (this.inventory) {
            this.inventory.destroy();
            this.inventory = null;
        }

        // ============ Milestone 6.7: æ¸…ç†è£…å¤‡ç³»ç»Ÿ ============
        if (this.equipmentUI) {
            this.equipmentUI.destroy();
            this.equipmentUI = null;
        }

        // æ¸…ç†ç¼“å­˜çš„DOMå…ƒç´ å¼•ç”¨
        this.cachedDOMElements = null;
        this.lastUIValues = null;

        // æ¸…ç†UIå¼•ç”¨
        if (this.sceneNameText) {
            this.sceneNameText.destroy();
            this.sceneNameText = null;
        }

        // æ¸…ç†äº‹ä»¶ç›‘å¬
        if (this.questManager) {
            this.events.off('questStarted');
            this.events.off('questCompleted');
            this.events.off('questUpdated');
            this.events.off('bossDefeated');
        }

        console.log('âœ… GameScene èµ„æºå·²æ¸…ç†');
    }

    // ============ ğŸ¾ å® ç‰©ç³»ç»Ÿè¾…åŠ©æ–¹æ³• ============

    /**
     * æ˜¾ç¤ºä¸´æ—¶æ¶ˆæ¯
     * @param {string} message - æ¶ˆæ¯å†…å®¹
     */
    showMessage(message) {
        const msgText = this.add.text(
            this.cameras.main.width / 2,
            this.cameras.main.height / 2 - 100,
            message,
            {
                fontSize: '20px',
                color: '#ffff00',
                stroke: '#000',
                strokeThickness: 3,
                fontStyle: 'bold'
            }
        );
        msgText.setOrigin(0.5);
        msgText.setDepth(2000);

        // 2ç§’åæ¶ˆå¤±
        this.time.delayedCall(2000, () => {
            msgText.destroy();
        });
    }

    /**
     * æ”¶é›†ç‰©å“
     * @param {Phaser.GameObjects.Sprite} item - ç‰©å“å¯¹è±¡
     */
    collectItem(item) {
        if (!item || !item.active) return;

        const itemType = item.getData('type');

        switch (itemType) {
            case 'coin':
                const coinValue = item.getData('value') || 1;
                this.player.gold = (this.player.gold || 0) + coinValue;
                break;
            case 'gem':
                const gemValue = item.getData('value') || 1;
                this.player.gems = (this.player.gems || 0) + gemValue;
                break;
            case 'potion':
                const healAmount = item.getData('healAmount') || 20;
                this.player.hp = Math.min(this.player.maxHp, this.player.hp + healAmount);
                break;
        }

        // æ’­æ”¾éŸ³æ•ˆ
        if (this.audioManager) {
            this.audioManager.playCollectCoin();
        }

        // æ˜¾ç¤ºæ”¶é›†æç¤º
        this.combatSystem.showDamageNumber(item.x, item.y, '+1', false, false, '#ffff00');

        // ç§»é™¤ç‰©å“
        item.destroy();
    }

    // ============ ğŸ¾ å® ç‰©ç³»ç»Ÿè¾…åŠ©æ–¹æ³•ç»“æŸ ============

    // ============ ğŸŒ¤ï¸ ç¯å¢ƒç‰¹æ•ˆç³»ç»Ÿæ–¹æ³• ============

    /**
     * è®¾ç½®å¤©æ°”
     * @param {string} weather - å¤©æ°”ç±»å‹ï¼ˆclear/rain/snow/fogï¼‰
     * @param {number} intensity - å¼ºåº¦ï¼ˆ0-1ï¼‰
     */
    setWeather(weather, intensity = 0.5) {
        if (this.weatherParticles) {
            this.weatherParticles.setWeather(weather, intensity);

            // æ ¹æ®å¤©æ°”æ›´æ–°ç¯å¢ƒç²’å­
            if (this.ambientParticles && this.dayNightManager) {
                this.ambientParticles.changeByContext(
                    this.dayNightManager.getCurrentPhase(),
                    weather,
                    'forest'
                );
            }
        }
    }

    /**
     * åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¤©æ°”
     */
    cycleWeather() {
        const weathers = ['clear', 'rain', 'snow', 'fog'];
        const currentWeather = this.weatherParticles ? this.weatherParticles.getCurrentWeather() : 'clear';
        const currentIndex = weathers.indexOf(currentWeather);
        const nextIndex = (currentIndex + 1) % weathers.length;

        this.setWeather(weathers[nextIndex]);

        // æ˜¾ç¤ºæç¤º
        const weatherNames = {
            clear: 'æ™´å¤©',
            rain: 'é›¨å¤©',
            snow: 'é›ªå¤©',
            fog: 'é›¾å¤©'
        };
        this.showMessage(`å¤©æ°”å˜åŒ–: ${weatherNames[weathers[nextIndex]]}`);
    }

    /**
     * è®¾ç½®æ¸¸æˆæ—¶é—´ï¼ˆç”¨äºæµ‹è¯•ï¼‰
     * @param {number} hours - å°æ—¶ï¼ˆ0-24ï¼‰
     * @param {number} minutes - åˆ†é’Ÿï¼ˆ0-60ï¼‰
     */
    setGameTime(hours, minutes = 0) {
        if (this.dayNightManager) {
            this.dayNightManager.setTime(hours, minutes);

            // æ›´æ–°ç¯å¢ƒç²’å­
            if (this.ambientParticles) {
                const phase = this.dayNightManager.getCurrentPhase();
                this.ambientParticles.changeByContext(phase, 'clear', 'forest');
            }
        }
    }

    /**
     * æ—¶é—´å¿«è¿›
     * @param {number} hours - å¿«è¿›å°æ—¶æ•°
     */
    fastForwardTime(hours) {
        if (this.dayNightManager) {
            const currentGameTime = this.dayNightManager.getGameTime();
            const newGameTime = (currentGameTime + hours * 60) % (24 * 60);
            const newHours = Math.floor(newGameTime / 60);
            const newMinutes = newGameTime % 60;

            this.setGameTime(newHours, newMinutes);
            this.showMessage(`æ—¶é—´å¿«è¿› ${hours} å°æ—¶`);
        }
    }

    // ============ ğŸŒ¤ï¸ ç¯å¢ƒç‰¹æ•ˆç³»ç»Ÿæ–¹æ³•ç»“æŸ ============
}
