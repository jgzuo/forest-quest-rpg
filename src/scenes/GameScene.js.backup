/**
 * GameScene - ä¸»æ¸¸æˆåœºæ™¯
 * åŒ…å«æ¸¸æˆçš„æ ¸å¿ƒé€»è¾‘ï¼šç©å®¶æ§åˆ¶ã€åœºæ™¯ç®¡ç†ã€æˆ˜æ–—ç³»ç»Ÿç­‰
 * @version 2.1 - ä¿®å¤åœºæ™¯åˆ‡æ¢é¢‘é—ª + æ·»åŠ æ¸²æŸ“ç¼“å­˜æ›´æ–°
 */
class GameScene extends Phaser.Scene {
    constructor() {
        super({ key: 'GameScene' });
    }

    create() {
        console.log('ğŸ® GameScene åˆå§‹åŒ– v2.2 (æ”¯æŒç²¾çµåŠ¨ç”»)');

        // ============ æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜DOMå…ƒç´  ============
        this.cachedDOMElements = {
            levelText: null,
            goldText: null,
            hpBar: null,
            hpBarFill: null,
            xpBar: null,
            xpBarFill: null
        };

        // ============ åˆå§‹åŒ–ç»Ÿè®¡è¿½è¸ª ============
        // è®°å½•æœ¬æ¬¡ä¼šè¯å¼€å§‹æ—¶é—´
        if (window.gameData && window.gameData.progress) {
            window.gameData.progress.sessionStartTime = Date.now();
            window.gameData.progress.lastPlaytimeUpdate = Date.now(); // ç”¨äºèŠ‚æµ
            console.log('â±ï¸ ç»Ÿè®¡è¿½è¸ªå·²å¯åŠ¨');
        }

        // ============ åˆå§‹åŒ–å­˜æ¡£ç®¡ç†å™¨ ============
        this.saveManager = new SaveManager(this);

        // ============ åˆå§‹åŒ–å•†åº—ç®¡ç†å™¨ ============
        this.shopManager = new ShopManager(this);

        // ============ åˆå§‹åŒ–ä»»åŠ¡ç®¡ç†å™¨ ============
        this.questManager = new QuestManager(this);

        // è®¾ç½®ä»»åŠ¡äº‹ä»¶ç›‘å¬
        this.setupQuestEvents();

        // ============ åˆå§‹åŒ–éŸ³é¢‘ç®¡ç†å™¨ ============
        this.audioManager = new AudioManager(this);

        // ============ åˆå§‹åŒ–æˆå°±ç®¡ç†å™¨ ============
        this.achievementManager = new AchievementManager(this);
        this.achievementManager.loadAchievements();

        // ============ æ£€æŸ¥æ˜¯å¦å­˜åœ¨å­˜æ¡£ ============
        this.checkSaveData();

        // ============ åˆå§‹åŒ–åœºæ™¯ç®¡ç†å™¨ ============
        this.sceneManager = new SceneManager(this);

        // ============ åˆ›å»ºç©å®¶åŠ¨ç”» ============
        this.createPlayerAnimations();

        // ============ åˆ›å»ºç©å®¶ ============
        this.createPlayer();

        // ============ åŠ è½½åˆå§‹åœºæ™¯ï¼ˆå°é•‡ï¼‰============
        this.sceneManager.loadScene('town');

        // ============ è®¾ç½®é”®ç›˜è¾“å…¥ ============
        this.setupControls();

        // ============ åˆå§‹åŒ–UI ============
        this.initUI();

        // ============ æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯ ============
        this.showWelcomeMessage();

        console.log('âœ… GameScene åˆ›å»ºå®Œæˆ v2.2');
    }

    createPlayerAnimations() {
        // å‘å‰èµ°åŠ¨ç”»
        this.anims.create({
            key: 'walk-front',
            frames: this.anims.generateFrameNumbers('hero-walk-front', { start: 0, end: 5 }),
            frameRate: 10,
            repeat: -1
        });

        // å‘åèµ°åŠ¨ç”»
        this.anims.create({
            key: 'walk-back',
            frames: this.anims.generateFrameNumbers('hero-walk-back', { start: 0, end: 5 }),
            frameRate: 10,
            repeat: -1
        });

        // ä¾§é¢èµ°åŠ¨ç”»
        this.anims.create({
            key: 'walk-side',
            frames: this.anims.generateFrameNumbers('hero-walk-side', { start: 0, end: 5 }),
            frameRate: 10,
            repeat: -1
        });

        // å‘å‰æ”»å‡»åŠ¨ç”»
        this.anims.create({
            key: 'attack-front',
            frames: this.anims.generateFrameNumbers('hero-attack-front', { start: 0, end: 2 }),
            frameRate: 15,  // æ”»å‡»åŠ¨ç”»ç¨å¿«
            repeat: 0       // åªæ’­æ”¾ä¸€æ¬¡
        });

        // å‘åæ”»å‡»åŠ¨ç”»
        this.anims.create({
            key: 'attack-back',
            frames: this.anims.generateFrameNumbers('hero-attack-back', { start: 0, end: 2 }),
            frameRate: 15,
            repeat: 0
        });

        // ä¾§é¢æ”»å‡»åŠ¨ç”»
        this.anims.create({
            key: 'attack-side',
            frames: this.anims.generateFrameNumbers('hero-attack-side', { start: 0, end: 2 }),
            frameRate: 15,
            repeat: 0
        });
    }

    createPlayer() {
        // åˆ›å»ºç©å®¶ç²¾çµ
        this.player = this.physics.add.sprite(400, 300, 'hero-idle-front');
        this.player.setScale(3);
        this.player.setCollideWorldBounds(true);

        // ç©å®¶å±æ€§
        this.player.hp = 100;
        this.player.maxHp = 100;
        this.player.xp = 0;
        this.player.level = 1;
        this.player.xpToNextLevel = 100;
        this.player.attack = 20;  // æ”»å‡»åŠ›ç¿»å€ï¼ˆä»10æ”¹ä¸º20ï¼‰
        this.player.speed = 150;
        this.player.gold = 100;  // åˆå§‹é‡‘å¸100

        // ç©å®¶çŠ¶æ€
        this.player.isAttacking = false;
        this.player.facing = 'front';
        this.player.lastDirection = 'down';
        this.player.currentAnimation = null;  // æ”¹ä¸ºè¿½è¸ªåŠ¨ç”»è€Œä¸æ˜¯çº¹ç†

        console.log('ğŸ‘¤ ç©å®¶åˆ›å»ºå®Œæˆ v2.2 (åŠ¨ç”»ç³»ç»Ÿ)');
    }

    setupControls() {
        // åˆ›å»ºå…‰æ ‡é”®
        this.cursors = this.input.keyboard.createCursorKeys();

        // åˆ›å»ºWASDé”®
        this.wasd = this.input.keyboard.addKeys({
            up: Phaser.Input.Keyboard.KeyCodes.W,
            down: Phaser.Input.Keyboard.KeyCodes.S,
            left: Phaser.Input.Keyboard.KeyCodes.A,
            right: Phaser.Input.Keyboard.KeyCodes.D,
            space: Phaser.Input.Keyboard.KeyCodes.SPACE,
            interact: Phaser.Input.Keyboard.KeyCodes.E
        });

        // æ”»å‡»é”®
        this.wasd.space.on('down', () => {
            this.playerAttack();
        });

        // äº¤äº’é”®
        this.wasd.interact.on('down', () => {
            this.handleInteraction();
        });

        // å¿«é€Ÿä¿å­˜é”® (F5)
        this.input.keyboard.on('keydown-F5', () => {
            this.quickSave();
        });

        // å¿«é€ŸåŠ è½½é”® (F9)
        this.input.keyboard.on('keydown-F9', () => {
            this.quickLoad();
        });

        console.log('âŒ¨ï¸ é”®ç›˜æ§åˆ¶è®¾ç½®å®Œæˆ');
    }

    setupQuestEvents() {
        // ç›‘å¬ä»»åŠ¡å¼€å§‹äº‹ä»¶
        this.events.on('questStarted', (quest) => {
            console.log(`ğŸ“œ ä»»åŠ¡å¼€å§‹: ${quest.name}`);
            this.showFloatingText(
                this.player.x,
                this.player.y - 60,
                `æ–°ä»»åŠ¡: ${quest.name}`,
                '#68d391'
            );
            // åˆ·æ–°ä»»åŠ¡UI
            this.refreshQuestUI();
        });

        // ç›‘å¬ä»»åŠ¡æ›´æ–°äº‹ä»¶
        this.events.on('questUpdated', (quest) => {
            const objective = quest.getCurrentObjective();
            if (objective) {
                console.log(`ğŸ“Š ${quest.name}: ${objective.description} (${objective.current}/${objective.required})`);
            }
            // åˆ·æ–°ä»»åŠ¡è¿½è¸ªå™¨
            this.refreshQuestTracker();
        });

        // ç›‘å¬ä»»åŠ¡ç›®æ ‡å®Œæˆäº‹ä»¶
        this.events.on('questObjectiveCompleted', (quest) => {
            console.log(`âœ¨ ä»»åŠ¡ç›®æ ‡å®Œæˆ: ${quest.name}`);
            this.showFloatingText(
                this.player.x,
                this.player.y - 60,
                `ç›®æ ‡å®Œæˆ!`,
                '#ffd700'
            );
            // åˆ·æ–°ä»»åŠ¡UI
            this.refreshQuestUI();
        });

        // ç›‘å¬ä»»åŠ¡å®Œæˆäº‹ä»¶
        this.events.on('questCompleted', (quest) => {
            console.log(`ğŸ‰ ä»»åŠ¡å®Œæˆ: ${quest.name}`);
            this.showFloatingText(
                400,
                300,
                `ä»»åŠ¡å®Œæˆ: ${quest.name}!`,
                '#ffd700',
                3000
            );
            // åˆ·æ–°ä»»åŠ¡UI
            this.refreshQuestUI();

            // å¦‚æœä»»åŠ¡æ—¥å¿—æ‰“å¼€ï¼Œåˆ·æ–°å®ƒ
            if (this.questLogPanel && this.questLogPanel.isOpen) {
                this.questLogPanel.refresh();
            }
        });

        // ç›‘å¬Bosså‡»è´¥äº‹ä»¶
        this.events.on('bossDefeated', (bossType) => {
            console.log(`ğŸ‘‘ Bossè¢«å‡»è´¥: ${bossType}`);

            // æ›´æ–°ä»»åŠ¡ç›®æ ‡
            if (this.questManager && bossType) {
                this.questManager.onBossDefeated(bossType);
            }
        });

        console.log('ğŸ“œ ä»»åŠ¡äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
    }

    refreshQuestUI() {
        // åˆ·æ–°ä»»åŠ¡è¿½è¸ªå™¨
        this.refreshQuestTracker();

        // å¦‚æœä»»åŠ¡æ—¥å¿—æ‰“å¼€ï¼Œåˆ·æ–°å®ƒ
        if (this.questLogPanel && this.questLogPanel.isOpen) {
            this.questLogPanel.refresh();
        }
    }

    refreshQuestTracker() {
        if (this.questTracker && this.questManager) {
            const activeQuests = this.questManager.getActiveQuests();
            this.questTracker.update(activeQuests);
        }
    }

    handleInteraction() {
        const playerX = this.player.x;
        const playerY = this.player.y;

        // æ‰¾åˆ°è·ç¦»ç©å®¶æœ€è¿‘çš„NPC
        let closestNPC = null;
        let closestDistance = Infinity;

        this.children.each((child) => {
            // ç¡®ä¿æ˜¯NPCå¯¹è±¡ä¸”æœ‰nameå±æ€§ï¼ˆæ’é™¤hintã€interactionZoneç­‰ï¼‰
            if (child.getData && child.getData('type') === 'npc' && child.getData('name')) {
                const distance = Phaser.Math.Distance.Between(
                    playerX, playerY,
                    child.x, child.y
                );

                if (distance < 60 && distance < closestDistance) {
                    closestDistance = distance;
                    closestNPC = child;
                }
            }
        });

        // åªä¸æœ€è¿‘çš„NPCå¯¹è¯
        if (closestNPC) {
            this.talkToNPC(closestNPC);
        }

        // æ£€æŸ¥é™„è¿‘çš„å®ç®±ï¼ˆå¦‚æœæœ‰ï¼‰
        this.children.each((child) => {
            if (child.getData && child.getData('type') === 'chest') {
                const distance = Phaser.Math.Distance.Between(
                    playerX, playerY,
                    child.x, child.y
                );

                if (distance < 60 && !child.getData('opened')) {
                    this.openChest(child);
                }
            }
        });
    }

    talkToNPC(npc) {
        const npcName = npc.getData('name');
        const npcId = npc.getData('id');
        const currentScene = this.sceneManager.getCurrentScene();

        let message = '';

        if (npcName === 'æ‘é•¿') {
            if (currentScene === 'town') {
                // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
                const quest1 = this.questManager.getQuest('quest_1_moles');
                const quest2 = this.questManager.getQuest('quest_2_gems');
                const quest4 = this.questManager.getQuest('quest_4_slime_hunter');
                const quest5 = this.questManager.getQuest('quest_5_blade_guardian');

                // æ„å»ºå¯¹è¯æ¶ˆæ¯
                message = 'æ‘é•¿ï¼šæ¬¢è¿æ¥åˆ°å°é•‡ï¼Œå¹´è½»çš„å†’é™©è€…ï¼\n\n';

                // ä»»åŠ¡1ä¿¡æ¯
                if (quest1.status === 'not_started') {
                    message += 'ğŸ“œ [å¯æ¥å–] é¼¹é¼ å¨èƒ\n  æ£®æ—é‡Œçš„é¼¹é¼ å¤ªå¤šäº†ï¼Œè¯·å‡»è´¥10åªé¼¹é¼ ï¼\n\n';
                } else if (quest1.status === 'in_progress') {
                    const obj = quest1.getCurrentObjective();
                    message += 'ğŸ“œ [è¿›è¡Œä¸­] é¼¹é¼ å¨èƒ\n  è¿›åº¦: ' + obj.current + '/' + obj.required + '\n\n';
                } else if (quest1.status === 'completed') {
                    message += 'âœ… [å·²å®Œæˆ] é¼¹é¼ å¨èƒ\n\n';
                }

                // ä»»åŠ¡2ä¿¡æ¯
                if (quest2.status === 'not_started') {
                    message += 'ğŸ’ [å¯æ¥å–] å®çŸ³æ”¶é›†\n  æ”¶é›†3é¢—ç¥ç§˜å®çŸ³ï¼Œå¥–åŠ±ä¸°åšï¼\n\n';
                } else if (quest2.status === 'in_progress') {
                    const obj = quest2.getCurrentObjective();
                    message += 'ğŸ’ [è¿›è¡Œä¸­] å®çŸ³æ”¶é›†\n  è¿›åº¦: ' + obj.current + '/' + obj.required + '\n\n';
                } else if (quest2.status === 'completed') {
                    message += 'âœ… [å·²å®Œæˆ] å®çŸ³æ”¶é›†\n\n';
                }

                // Milestone 6 - æ–°ä»»åŠ¡ä¿¡æ¯

                // ä»»åŠ¡4: å²è±å§†ç‹©çŒ (éœ€è¦å®Œæˆä»»åŠ¡1)
                if (quest4) {
                    const prereqMet = quest1.status === 'completed';
                    if (quest4.status === 'not_started') {
                        if (prereqMet) {
                            message += 'ğŸ¦  [å¯æ¥å–] å²è±å§†ç‹©çŒ\n  æ´ç©´é‡Œçš„å²è±å§†å¤ªå¤šäº†ï¼Œå‡»è´¥5åªå²è±å§†ï¼\n  å¥–åŠ±: 50é‡‘å¸, 30XP\n\n';
                        } else {
                            message += 'ğŸ”’ [é”å®š] å²è±å§†ç‹©çŒ\n  éœ€è¦å®Œæˆ: é¼¹é¼ å¨èƒ\n\n';
                        }
                    } else if (quest4.status === 'in_progress') {
                        const obj = quest4.getCurrentObjective();
                        message += 'ğŸ¦  [è¿›è¡Œä¸­] å²è±å§†ç‹©çŒ\n  è¿›åº¦: ' + obj.current + '/' + obj.required + '\n\n';
                    } else if (quest4.status === 'completed') {
                        message += 'âœ… [å·²å®Œæˆ] å²è±å§†ç‹©çŒ\n\n';
                    }
                }

                // ä»»åŠ¡5: å®ˆæŠ¤è€…ä¹‹åˆƒ (éœ€è¦å®Œæˆä»»åŠ¡1)
                if (quest5) {
                    const prereqMet = quest1.status === 'completed';
                    if (quest5.status === 'not_started') {
                        if (prereqMet) {
                            message += 'âš”ï¸ [å¯æ¥å–] å®ˆæŠ¤è€…ä¹‹åˆƒ\n  å¯»æ‰¾3æŠŠå¤ä»£æ­¦å™¨ç¢ç‰‡ï¼Œé‡æ–°é“¸é€ ä¼ å¥‡ä¹‹å‰‘ï¼\n  å¥–åŠ±: å®ˆæŠ¤è€…ä¹‹å‰‘(ATK+5), 75é‡‘å¸, 100XP\n\n';
                        } else {
                            message += 'ğŸ”’ [é”å®š] å®ˆæŠ¤è€…ä¹‹åˆƒ\n  éœ€è¦å®Œæˆ: é¼¹é¼ å¨èƒ\n\n';
                        }
                    } else if (quest5.status === 'in_progress') {
                        const obj = quest5.getCurrentObjective();
                        message += 'âš”ï¸ [è¿›è¡Œä¸­] å®ˆæŠ¤è€…ä¹‹åˆƒ\n  è¿›åº¦: ' + obj.current + '/' + obj.required + '\n\n';
                    } else if (quest5.status === 'completed') {
                        message += 'âœ… [å·²å®Œæˆ] å®ˆæŠ¤è€…ä¹‹åˆƒ\n\n';
                    }
                }

                message += 'æç¤ºï¼šæŒ‰Qé”®æŸ¥çœ‹ä»»åŠ¡æ—¥å¿—\n\næŒ‰Eé”®ç»§ç»­å¯¹è¯æ¥å–ä»»åŠ¡';

                // æ˜¾ç¤ºå¯¹è¯å¹¶æ·»åŠ é€‰é¡¹
                this.showQuestDialog(npcName, message, npcId);
                return;
            }
        } else if (npcName === 'å•†äºº') {
            // æ‰“å¼€å•†åº—å¹¶æ·»åŠ æ–°ä»»åŠ¡
            const quest6 = this.questManager.getQuest('quest_6_lost_cargo');

            let shopMessage = 'å•†äººï¼šæ¬¢è¿å…‰ä¸´ï¼æƒ³ä¹°ç‚¹ä»€ä¹ˆå—ï¼Ÿ\n\n';

            // Milestone 6 - ä»»åŠ¡6: å¤±è½çš„è´§ç‰©
            if (quest6) {
                if (quest6.status === 'not_started') {
                    shopMessage += 'ğŸ“¦ [å¯æ¥å–] å¤±è½çš„è´§ç‰©\n  æˆ‘çš„é©¬è½¦é‡è¢­äº†ï¼è¯·å¸®æˆ‘æ‰¾å›3ä¸ªè´§ç‰©ç®±å­ã€‚\n  å¥–åŠ±: 200é‡‘å¸, å•†äººä¼˜æƒ åˆ¸, 50XP\n\n';
                } else if (quest6.status === 'in_progress') {
                    const obj = quest6.getCurrentObjective();
                    shopMessage += `ğŸ“¦ [è¿›è¡Œä¸­] å¤±è½çš„è´§ç‰©\n  è¿›åº¦: ${obj.current}/${obj.required}\n\n`;
                } else if (quest6.status === 'completed') {
                    shopMessage += 'âœ… [å·²å®Œæˆ] å¤±è½çš„è´§ç‰©\nè°¢è°¢ä½ çš„å¸®åŠ©ï¼\n\n';
                }
            }

            // æ‰“å¼€å•†åº—
            if (this.shopManager) {
                this.shopManager.openShop('å•†äºº');
            }
            return;
        }

        if (message) {
            this.showDialog(npcName, message);
        }
    }

    showDialog(speaker, message) {
        // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
        const dialogBg = this.add.rectangle(400, 500, 700, 150, 0x222222);
        dialogBg.setStrokeStyle(3, 0x667eea);
        dialogBg.setDepth(100);

        // åˆ›å»ºå¯¹è¯æ¡†æ–‡å­—
        const dialogText = this.add.text(100, 420, message, {
            font: '16px Noto Sans SC',
            fill: '#ffffff',
            wordWrap: { width: 650 }
        });
        dialogText.setDepth(101);

        // åˆ›å»ºè¯´è¯è€…åç§°
        const speakerText = this.add.text(100, 400, speaker, {
            font: 'bold 18px Noto Sans SC',
            fill: '#667eea'
        });
        speakerText.setDepth(101);

        // åˆ›å»ºå…³é—­æç¤º
        const closeHint = this.add.text(700, 530, 'æŒ‰ä»»æ„é”®å…³é—­', {
            font: '14px Arial',
            fill: '#888888'
        }).setOrigin(1, 0);
        closeHint.setDepth(101);

        // åˆ›å»ºä¸´æ—¶è¦†ç›–å±‚é˜»æ­¢è¾“å…¥
        const inputBlocker = this.add.rectangle(400, 300, 800, 600, 0x000000, 0);
        inputBlocker.setDepth(99);
        inputBlocker.setInteractive();

        // ç‚¹å‡»æˆ–æŒ‰é”®å…³é—­å¯¹è¯æ¡†
        const closeDialog = () => {
            dialogBg.destroy();
            dialogText.destroy();
            speakerText.destroy();
            closeHint.destroy();
            inputBlocker.destroy();
            inputBlocker.off('pointerdown', closeDialog);
            this.input.keyboard.off('keydown', closeDialog);
        };

        inputBlocker.on('pointerdown', closeDialog);
        this.input.keyboard.once('keydown', closeDialog);

        console.log(`ğŸ’¬ å¯¹è¯: ${speaker}`);
    }

    showQuestDialog(speaker, message, npcId) {
        // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯ï¼ˆæ›´å¤§ä»¥å®¹çº³é€‰é¡¹ï¼‰
        const dialogBg = this.add.rectangle(400, 500, 700, 200, 0x222222);
        dialogBg.setStrokeStyle(3, 0x68d391);
        dialogBg.setDepth(100);

        // åˆ›å»ºå¯¹è¯æ¡†æ–‡å­—
        const dialogText = this.add.text(100, 420, message, {
            font: '15px Noto Sans SC',
            fill: '#ffffff',
            wordWrap: { width: 620 }
        });
        dialogText.setDepth(101);

        // åˆ›å»ºè¯´è¯è€…åç§°
        const speakerText = this.add.text(100, 400, speaker, {
            font: 'bold 18px Noto Sans SC',
            fill: '#68d391'
        });
        speakerText.setDepth(101);

        // åˆ›å»ºé€‰é¡¹æŒ‰é’®
        const quest1 = this.questManager.getQuest('quest_1_moles');
        const quest2 = this.questManager.getQuest('quest_2_gems');
        const quest4 = this.questManager.getQuest('quest_4_slime_hunter');
        const quest5 = this.questManager.getQuest('quest_5_blade_guardian');

        // æ£€æŸ¥å“ªäº›ä»»åŠ¡å¯ä»¥æ¥å–
        const canAccept1 = quest1.status === 'not_started';
        const canAccept2 = quest2.status === 'not_started';
        const canAccept4 = quest4 && quest4.status === 'not_started' && quest1.status === 'completed';
        const canAccept5 = quest5 && quest5.status === 'not_started' && quest1.status === 'completed';

        // æ„å»ºæç¤ºæ–‡æœ¬
        let buttonText = 'æŒ‰ ';
        let shortcutCount = 0;

        if (canAccept1) {
            buttonText += `1 æ¥å–é¼¹é¼ ä»»åŠ¡`;
            shortcutCount++;
        }
        if (canAccept2) {
            if (shortcutCount > 0) buttonText += ' | ';
            buttonText += `2 æ¥å–å®çŸ³ä»»åŠ¡`;
            shortcutCount++;
        }
        if (canAccept4) {
            if (shortcutCount > 0) buttonText += ' | ';
            buttonText += `3 æ¥å–å²è±å§†ä»»åŠ¡`;
            shortcutCount++;
        }
        if (canAccept5) {
            if (shortcutCount > 0) buttonText += ' | ';
            buttonText += `4 æ¥å–å®ˆæŠ¤è€…ä¹‹åˆƒä»»åŠ¡`;
            shortcutCount++;
        }

        buttonText += shortcutCount > 0 ? ' | ' : '';
        buttonText += 'ESC å…³é—­';

        const hintText = this.add.text(400, 570, buttonText, {
            font: '13px Arial',
            fill: '#ffd700'
        }).setOrigin(0.5);
        hintText.setDepth(101);

        // åˆ›å»ºä¸´æ—¶è¦†ç›–å±‚é˜»æ­¢è¾“å…¥
        const inputBlocker = this.add.rectangle(400, 300, 800, 600, 0x000000, 0);
        inputBlocker.setDepth(99);
        inputBlocker.setInteractive();

        // å…³é—­å¯¹è¯æ¡†å‡½æ•°
        const closeDialog = () => {
            dialogBg.destroy();
            dialogText.destroy();
            speakerText.destroy();
            hintText.destroy();
            inputBlocker.destroy();
            inputBlocker.off('pointerdown', closeDialog);
            this.input.keyboard.off('keydown-ESC', closeDialog);
            this.input.keyboard.off('keydown-ONE', acceptQuest1);
            this.input.keyboard.off('keydown-TWO', acceptQuest2);
            this.input.keyboard.off('keydown-THREE', acceptQuest4);
            this.input.keyboard.off('keydown-FOUR', acceptQuest5);
        };

        // æ¥å–ä»»åŠ¡1
        const acceptQuest1 = () => {
            if (quest1.status === 'not_started') {
                const success = this.questManager.startQuest('quest_1_moles');
                if (success) {
                    this.showFloatingText(400, 300, 'ä»»åŠ¡å·²æ¥å—: é¼¹é¼ å¨èƒ!', '#68d391', 2000);
                }
            }
            closeDialog();
        };

        // æ¥å–ä»»åŠ¡2
        const acceptQuest2 = () => {
            if (quest2.status === 'not_started') {
                const success = this.questManager.startQuest('quest_2_gems');
                if (success) {
                    this.showFloatingText(400, 300, 'ä»»åŠ¡å·²æ¥å—: å®çŸ³æ”¶é›†!', '#68d391', 2000);
                }
            }
            closeDialog();
        };

        // Milestone 6: æ¥å–ä»»åŠ¡4 - å²è±å§†ç‹©çŒ
        const acceptQuest4 = () => {
            if (quest4 && quest4.status === 'not_started') {
                const success = this.questManager.startQuest('quest_4_slime_hunter');
                if (success) {
                    this.showFloatingText(400, 300, 'ä»»åŠ¡å·²æ¥å—: å²è±å§†ç‹©çŒ!', '#68d391', 2000);
                }
            } else if (quest4 && quest4.status !== 'not_started') {
                // ä»»åŠ¡å·²é”å®šæˆ–ä¸æ»¡è¶³æ¡ä»¶
                const prereqDesc = quest4.getPrerequisiteDescription();
                this.showFloatingText(400, 300, `ğŸ”’ ${prereqDesc}`, '#ff6b6b', 2000);
                closeDialog();
            } else {
                closeDialog();
            }
        };

        // Milestone 6: æ¥å–ä»»åŠ¡5 - å®ˆæŠ¤è€…ä¹‹åˆƒ
        const acceptQuest5 = () => {
            if (quest5 && quest5.status === 'not_started') {
                const success = this.questManager.startQuest('quest_5_blade_guardian');
                if (success) {
                    this.showFloatingText(400, 300, 'ä»»åŠ¡å·²æ¥å—: å®ˆæŠ¤è€…ä¹‹åˆƒ!', '#68d391', 2000);
                }
            } else if (quest5 && quest5.status !== 'not_started') {
                // ä»»åŠ¡å·²é”å®šæˆ–ä¸æ»¡è¶³æ¡ä»¶
                const prereqDesc = quest5.getPrerequisiteDescription();
                this.showFloatingText(400, 300, `ğŸ”’ ${prereqDesc}`, '#ff6b6b', 2000);
                closeDialog();
            } else {
                closeDialog();
            }
        };

        inputBlocker.on('pointerdown', closeDialog);
        this.input.keyboard.once('keydown-ESC', closeDialog);

        // åªåœ¨ä»»åŠ¡å¯æ¥å–æ—¶æ·»åŠ æŒ‰é”®ç›‘å¬
        if (canAccept1) {
            this.input.keyboard.once('keydown-ONE', acceptQuest1);
        }
        if (canAccept2) {
            this.input.keyboard.once('keydown-TWO', acceptQuest2);
        }
        if (canAccept4) {
            this.input.keyboard.once('keydown-THREE', acceptQuest4);
        }
        if (canAccept5) {
            this.input.keyboard.once('keydown-FOUR', acceptQuest5);
        }

        console.log(`ğŸ’¬ ä»»åŠ¡å¯¹è¯: ${speaker}`);
    }

    openChest(chest) {
        chest.setData('opened', true);

        // éšæœºæ‰è½ç‰©å“
        const random = Math.random();
        let item;
        let itemName;

        if (random < 0.5) {
            item = 'coin';
            itemName = 'é‡‘å¸';
        } else if (random < 0.8) {
            item = 'gem';
            itemName = 'å®çŸ³';
        } else {
            // æ¢å¤ç”Ÿå‘½å€¼
            this.player.hp = Math.min(this.player.maxHp, this.player.hp + 20);
            itemName = 'ç”Ÿå‘½è¯æ°´';
            this.showFloatingText(chest.x, chest.y, '+20 HP', '#ff6b6b');
            this.updateUI();
        }

        if (item) {
            this.dropItem(chest.x, chest.y, item);
            this.showFloatingText(chest.x, chest.y, `è·å¾— ${itemName}!`, '#ffd700');
        }

        // æ”¹å˜å®ç®±å¤–è§‚ï¼ˆç®€å•å˜æš—ï¼‰
        chest.setAlpha(0.5);

        console.log(`ğŸ æ‰“å¼€å®ç®±: ${itemName}`);
    }

    playerAttack() {
        if (this.player.isAttacking) return;

        this.player.isAttacking = true;

        // æ’­æ”¾æ”»å‡»åŠ¨ç”»ï¼ˆä½¿ç”¨åŠ¨ç”»ç³»ç»Ÿï¼‰
        const attackAnimKey = `attack-${this.player.facing}`;
        this.player.anims.play(attackAnimKey, true);

        // è·å–æ•Œäººç»„ï¼ˆä½¿ç”¨å®‰å…¨æ–¹æ³•ï¼‰
        const enemies = this.getEnemiesGroup();
        if (!enemies || enemies.getChildren().length === 0) {
            console.log('âš ï¸ No enemies to attack');
            this.player.isAttacking = false;
            return;
        }

        // åˆ›å»ºæ”»å‡»åˆ¤å®šåŒºåŸŸ
        const hitbox = this.add.rectangle(
            this.player.x + (this.player.facing === 'side' && this.player.flipX ? -30 : 30),
            this.player.y,
            60,
            60,
            0xff0000,
            0.3
        );

        // æ ‡è®°æ˜¯å¦å·²å‡»ä¸­æ•Œäººï¼ˆé˜²æ­¢å¤šé‡å‘½ä¸­ï¼‰
        let hasHit = false;

        this.physics.add.overlap(hitbox, enemies, (hitboxRect, enemy) => {
            if (!hasHit) {
                this.hitEnemy(enemy);
                hasHit = true;
                hitboxRect.destroy();
            }
        });

        // æ”»å‡»å†·å´ï¼ˆ300msåæ¢å¤ï¼‰
        this.time.delayedCall(300, () => {
            this.player.isAttacking = false;
            this.resetPlayerAnimation();
        });

        // æ¸…é™¤åˆ¤å®šåŒºåŸŸï¼ˆå¢åŠ æ—¶é—´åˆ°200msä»¥ç¡®ä¿overlapæ£€æµ‹å®Œæˆï¼‰
        this.time.delayedCall(200, () => {
            if (hitbox && hitbox.active) {
                hitbox.destroy();
            }
        });
    }

    /**
     * å®‰å…¨è·å–æ•Œäººç»„
     * @returns {Phaser.Physics.Arcade.Group|null} æ•Œäººç»„ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›null
     */
    getEnemiesGroup() {
        if (this.sceneManager && this.sceneManager.enemies) {
            return this.sceneManager.enemies;
        }
        if (this.enemies) {
            return this.enemies;
        }
        console.warn('âš ï¸ No enemies group found in scene');
        return null;
    }

    hitEnemy(enemy) {
        // éªŒè¯æ•Œäººå¯¹è±¡æœ‰æ•ˆ
        if (!enemy || !enemy.active) {
            console.warn('âš ï¸ Attempted to hit invalid enemy');
            return;
        }

        const damage = this.player.attack;
        const currentHp = enemy.getData('hp') - damage;
        const maxHp = enemy.getData('maxHp');
        enemy.setData('hp', currentHp);

        console.log(`âš”ï¸ Hit enemy! Damage: ${damage}, Enemy HP: ${Math.max(0, currentHp)}/${maxHp}`);

        // æ›´æ–°è¡€æ¡å®½åº¦
        if (enemy.hpBar) {
            const hpPercent = Math.max(0, currentHp / maxHp);
            enemy.hpBar.width = 40 * hpPercent;
        }

        // æ˜¾ç¤ºä¼¤å®³æ•°å­—
        this.showDamageNumber(enemy.x, enemy.y, damage);

        // æ£€æŸ¥æ•Œäººæ˜¯å¦æ­»äº¡
        if (currentHp <= 0) {
            this.enemyDeath(enemy);
        }
    }

    enemyDeath(enemy) {
        const xp = enemy.getData('xp');
        const gold = enemy.getData('gold');
        const enemyType = enemy.getData('type');
        const specialAbility = enemy.getData('specialAbility');

        // Milestone 6: ç²¾è‹±å˜å¼‚å²è±å§†åˆ†è£‚èƒ½åŠ›
        if (specialAbility === 'split_on_death' && enemyType === 'elite_mutated_slime') {
            console.log('âœ¨ å˜å¼‚å²è±å§†æ­»äº¡ï¼Œåˆ†è£‚æˆå°å²è±å§†ï¼');

            // åˆ†è£‚æˆ2-3ä¸ªå°å²è±å§†
            const numSmallSlimes = Phaser.Math.Between(2, 3);
            for (let i = 0; i < numSmallSlimes; i++) {
                const offsetX = Phaser.Math.Between(-50, 50);
                const offsetY = Phaser.Math.Between(-50, 50);
                const spawnX = Phaser.Math.Clamp(enemy.x + offsetX, 100, 700);
                const spawnY = Phaser.Math.Clamp(enemy.y + offsetY, 100, 500);

                // ç”Ÿæˆå°å²è±å§†ï¼ˆæ™®é€šå²è±å§†æ•°æ®ï¼‰
                const smallSlime = this.sceneManager.enemies.create(spawnX, spawnY, 'mole-idle-front');
                smallSlime.setScale(2); // æ¯”ç²¾è‹±å°ï¼Œæ¯”æ™®é€šç¨å¤§
                smallSlime.setTint(0x00ff00); // ç»¿è‰²è°ƒ
                smallSlime.setData('type', 'slime');
                smallSlime.setData('hp', 15); // ä½HP
                smallSlime.setData('maxHp', 15);
                smallSlime.setData('attack', 5); // ä½æ”»å‡»
                smallSlime.setData('speed', 70); // å¿«é€Ÿç§»åŠ¨
                smallSlime.setData('xp', 10); // ä½ç»éªŒ
                smallSlime.setData('gold', 5);
                smallSlime.setData('lastHitTime', 0);

                // åˆ›å»ºè¡€æ¡
                const hpBarBg = this.add.rectangle(spawnX, spawnY - 20, 30, 3, 0x000000);
                hpBarBg.setOrigin(0.5);
                hpBarBg.setDepth(100);
                const hpBar = this.add.rectangle(spawnX, spawnY - 20, 30, 3, 0xff0000);
                hpBar.setOrigin(0.5);
                hpBar.setDepth(101);
                smallSlime.hpBar = hpBar;
                smallSlime.hpBarBg = hpBarBg;

                console.log(`  â†’ å°å²è±å§†ç”Ÿæˆ at (${spawnX}, ${spawnY})`);
            }

            // æ˜¾ç¤ºåˆ†è£‚æç¤º
            this.showFloatingText(enemy.x, enemy.y - 40, `âœ¨ åˆ†è£‚æˆ ${numSmallSlimes} ä¸ªå°å²è±å§†!`, '#00ff00', 2000);
        }

        // ç§»é™¤è¡€æ¡
        if (enemy.hpBar) {
            enemy.hpBar.destroy();
        }
        if (enemy.hpBarBg) {
            enemy.hpBarBg.destroy();
        }

        // è·å¾—ç»éªŒå’Œé‡‘å¸
        this.gainXP(xp);
        this.player.gold += gold;

        // ç§»é™¤æ•Œäºº
        enemy.destroy();

        // æ˜¾ç¤ºè·å¾—å¥–åŠ±æç¤º
        this.showFloatingText(enemy.x, enemy.y, `+${xp} XP`, '#4facfe');
        this.showFloatingText(enemy.x, enemy.y - 20, `+${gold} G`, '#ffd700');

        // æ›´æ–°UI
        this.updateUI();

        // æ›´æ–°æ¸¸æˆè¿›åº¦
        if (window.gameData && window.gameData.progress) {
            window.gameData.progress.enemiesDefeated++;

            // æ£€æŸ¥æˆå°±ï¼šç¬¬ä¸€æ¬¡å‡»æ€
            if (window.gameData.progress.enemiesDefeated === 1) {
                this.achievementManager.unlock('first_blood');
            }

            // æ£€æŸ¥æˆå°±ï¼šé¼¹é¼ çŒäºº
            if (window.gameData.progress.enemiesDefeated >= 10) {
                this.achievementManager.unlock('mole_hunter');
            }
        }

        // æ›´æ–°æ•Œäººç±»å‹ç»Ÿè®¡
        if (window.gameData && window.gameData.enemiesDefeated && enemyType) {
            if (!window.gameData.enemiesDefeated[enemyType]) {
                window.gameData.enemiesDefeated[enemyType] = 0;
            }
            window.gameData.enemiesDefeated[enemyType]++;

            // Bossç‰¹æ®Šå¤„ç†
            if (enemy.getData('isBoss')) {
                const bossKey = `boss_${enemyType}`;
                if (!window.gameData.enemiesDefeated[bossKey]) {
                    window.gameData.enemiesDefeated[bossKey] = 0;
                }
                window.gameData.enemiesDefeated[bossKey]++;
            }
        }

        // æ’­æ”¾éŸ³æ•ˆ
        this.audioManager.playEnemyDeath();

        // æ›´æ–°ä»»åŠ¡ç›®æ ‡
        if (this.questManager && enemyType) {
            this.questManager.onEnemyKilled(enemyType);
        }
    }

    gainXP(amount) {
        this.player.xp += amount;

        if (this.player.xp >= this.player.xpToNextLevel) {
            this.levelUp();
        }

        this.updateUI();
    }

    levelUp() {
        this.player.level++;
        this.player.xp -= this.player.xpToNextLevel;
        this.player.xpToNextLevel = Math.floor(this.player.xpToNextLevel * 1.5);

        // å¢åŠ å±æ€§
        this.player.maxHp += 10;
        this.player.hp = this.player.maxHp;
        this.player.attack += 3;

        // æ˜¾ç¤ºå‡çº§æç¤º
        this.showFloatingText(this.player.x, this.player.y - 50, 'LEVEL UP!', '#ffd700');

        // æ’­æ”¾å‡çº§éŸ³æ•ˆ
        this.audioManager.playLevelUp();

        // æ£€æŸ¥æˆå°±ï¼šæ»¡çº§è‹±é›„
        if (this.player.level >= 10) {
            this.achievementManager.unlock('max_level');
        }

        // æ£€æŸ¥æˆå°±ï¼šå¯Œæœ‰ä¹‹äºº
        if (this.player.gold >= 1000) {
            this.achievementManager.unlock('wealthy');
        }

        // è‡ªåŠ¨ä¿å­˜æ¸¸æˆ
        if (this.saveManager) {
            console.log('ğŸ’¾ [Level Up] Triggering auto-save...');
            this.saveManager.autoSave();
        }

        console.log(`â¬†ï¸ å‡çº§ï¼å½“å‰ç­‰çº§ï¼š${this.player.level}`);
    }

    dropItem(x, y, type) {
        let item;
        if (type === 'coin') {
            item = this.add.image(x, y, 'coin').setScale(2);

            // æ›´æ–°é‡‘å¸è®¡æ•°
            if (window.gameData && window.gameData.progress) {
                window.gameData.progress.totalCoins++;
            }
        } else if (type === 'gem') {
            item = this.add.image(x, y, 'gem').setScale(2);

            // æ›´æ–°å®çŸ³è®¡æ•°
            if (window.gameData && window.gameData.progress) {
                window.gameData.progress.gemsCollected++;
            }
        }

        if (item) {
            // ç®€å•çš„æ‹¾å–åŠ¨ç”»
            this.tweens.add({
                targets: item,
                y: y - 20,
                alpha: 0,
                duration: 500,
                onComplete: () => item.destroy()
            });
        }
    }

    showDamageNumber(x, y, damage, color = '#ff0000') {
        const text = this.add.text(x, y, damage.toString(), {
            font: '20px Arial',
            fill: color,
            stroke: '#000000',
            strokeThickness: 4
        }).setOrigin(0.5);

        this.tweens.add({
            targets: text,
            y: y - 50,
            alpha: 0,
            duration: 1000,
            onComplete: () => text.destroy()
        });
    }

    showFloatingText(x, y, message, color = '#ffffff') {
        const text = this.add.text(x, y, message, {
            font: '16px Arial',
            fill: color,
            stroke: '#000000',
            strokeThickness: 3
        }).setOrigin(0.5);

        this.tweens.add({
            targets: text,
            y: y - 40,
            alpha: 0,
            duration: 1500,
            onComplete: () => text.destroy()
        });
    }

    showWelcomeMessage() {
        this.time.delayedCall(500, () => {
            this.showFloatingText(400, 200, 'æ¬¢è¿æ¥åˆ°æ£®æ—æ¢é™©ï¼', '#68d391');
            this.time.delayedCall(2000, () => {
                this.showFloatingText(400, 240, 'ä½¿ç”¨ WASD ç§»åŠ¨ï¼Œç©ºæ ¼é”®æ”»å‡»', '#4facfe');
                this.time.delayedCall(2000, () => {
                    this.showFloatingText(400, 280, 'æŒ‰ E é”®ä¸NPCå¯¹è¯', '#ffd700');
                });
            });
        });
    }

    resetPlayerAnimation() {
        // åœæ­¢å½“å‰åŠ¨ç”»
        this.player.anims.stop();

        // åˆ‡æ¢å›idleçº¹ç†ï¼ˆé™æ€å›¾ç‰‡ï¼‰
        const idleTexture = `hero-idle-${this.player.facing}`;
        this.player.setTexture(idleTexture);
    }

    initUI() {
        // æ˜¾ç¤ºUI
        document.getElementById('hp-bar').style.display = 'block';
        document.getElementById('xp-bar').style.display = 'block';
        document.getElementById('level-display').style.display = 'block';
        document.getElementById('gold-display').style.display = 'block';

        // æ·»åŠ åœºæ™¯åç§°æ˜¾ç¤º
        this.addSceneIndicator();

        // åˆå§‹åŒ–ä»»åŠ¡UI
        this.initQuestUI();

        this.updateUI();
    }

    initQuestUI() {
        // åˆ›å»ºä»»åŠ¡è¿½è¸ªå™¨ï¼ˆHUDï¼‰
        this.questTracker = new QuestTracker(this);
        this.questTracker.create();

        // åˆ›å»ºä»»åŠ¡æ—¥å¿—é¢æ¿
        this.questLogPanel = new QuestLogPanel(this);
        this.questLogPanel.create();

        // æ·»åŠ Qé”®ç›‘å¬å™¨ï¼ˆåˆ‡æ¢ä»»åŠ¡æ—¥å¿—ï¼‰
        this.input.keyboard.on('keydown-Q', () => {
            this.questLogPanel.toggle();
        });

        console.log('âœ… ä»»åŠ¡UIåˆå§‹åŒ–å®Œæˆ');
    }

    addSceneIndicator() {
        // åˆ›å»ºåœºæ™¯åç§°æ˜¾ç¤º
        const indicator = this.add.text(400, 30, 'å°é•‡', {
            font: '18px Press Start 2P',
            fill: '#ffffff',
            stroke: '#000000',
            strokeThickness: 4
        }).setOrigin(0.5).setDepth(90).setScrollFactor(0);

        this.sceneNameText = indicator;
    }

    updateSceneIndicator(sceneName) {
        const sceneNames = {
            'town': 'å°é•‡',
            'forest': 'æ£®æ—',
            'cave': 'æ´ç©´'
        };

        if (this.sceneNameText) {
            this.sceneNameText.setText(sceneNames[sceneName] || sceneName);
        }
    }

    updateUI() {
        // ============ æ€§èƒ½ä¼˜åŒ–ï¼šåªåœ¨å€¼å˜åŒ–æ—¶æ›´æ–°DOM ============

        // ç¼“å­˜DOMå…ƒç´ ï¼ˆé¦–æ¬¡è°ƒç”¨æ—¶ï¼‰
        if (!this.cachedDOMElements.levelText) {
            this.cachedDOMElements.levelText = document.getElementById('level-text');
            this.cachedDOMElements.goldText = document.getElementById('gold-text');
            this.cachedDOMElements.hpText = document.getElementById('hp-text');
            this.cachedDOMElements.hpBarFill = document.querySelector('#hp-bar .bar-fill');
            this.cachedDOMElements.xpText = document.getElementById('xp-text');
            this.cachedDOMElements.xpBarFill = document.querySelector('#xp-bar .bar-fill');
        }

        // å­˜å‚¨ä¸Šæ¬¡å€¼ä»¥æ£€æµ‹å˜åŒ–
        if (!this.lastUIValues) {
            this.lastUIValues = {
                hp: this.player.hp,
                maxHp: this.player.maxHp,
                xp: this.player.xp,
                xpToNextLevel: this.player.xpToNextLevel,
                level: this.player.level,
                gold: this.player.gold
            };
        }

        // åªåœ¨å€¼å˜åŒ–æ—¶æ›´æ–°DOM
        if (this.player.hp !== this.lastUIValues.hp || this.player.maxHp !== this.lastUIValues.maxHp) {
            const hpPercent = (this.player.hp / this.player.maxHp) * 100;
            this.cachedDOMElements.hpText.textContent = `${this.player.hp}/${this.player.maxHp}`;
            this.cachedDOMElements.hpBarFill.style.width = `${hpPercent}%`;
            this.lastUIValues.hp = this.player.hp;
            this.lastUIValues.maxHp = this.player.maxHp;
        }

        if (this.player.xp !== this.lastUIValues.xp || this.player.xpToNextLevel !== this.lastUIValues.xpToNextLevel) {
            const xpPercent = (this.player.xp / this.player.xpToNextLevel) * 100;
            this.cachedDOMElements.xpText.textContent = `${this.player.xp}/${this.player.xpToNextLevel}`;
            this.cachedDOMElements.xpBarFill.style.width = `${xpPercent}%`;
            this.lastUIValues.xp = this.player.xp;
            this.lastUIValues.xpToNextLevel = this.player.xpToNextLevel;
        }

        if (this.player.level !== this.lastUIValues.level) {
            this.cachedDOMElements.levelText.textContent = this.player.level;
            this.lastUIValues.level = this.player.level;
        }

        if (this.player.gold !== this.lastUIValues.gold) {
            this.cachedDOMElements.goldText.textContent = this.player.gold;
            this.lastUIValues.gold = this.player.gold;
        }
    }

    update() {
        // æ£€æŸ¥ç©å®¶æ˜¯å¦ç¦»å¼€ä¼ é€åŒºåŸŸï¼ˆé˜²æ­¢åˆšä¼ é€å°±è§¦å‘è¿”å›ï¼‰
        if (this.sceneManager) {
            this.sceneManager.checkTeleportExit();
        }

        // ============ ç©å®¶ç§»åŠ¨ ============
        if (!this.player.isAttacking) {
            let velocityX = 0;
            let velocityY = 0;
            let newAnimation = null;

            if (this.cursors.left.isDown || this.wasd.left.isDown) {
                velocityX = -this.player.speed;
                this.player.facing = 'side';
                this.player.lastDirection = 'left';
                newAnimation = 'walk-side';
                // å‘å·¦ç§»åŠ¨æ—¶flipX
                if (!this.player.flipX) {
                    this.player.flipX = true;
                }
            } else if (this.cursors.right.isDown || this.wasd.right.isDown) {
                velocityX = this.player.speed;
                this.player.facing = 'side';
                this.player.lastDirection = 'right';
                newAnimation = 'walk-side';
                // å‘å³ç§»åŠ¨æ—¶ä¸flipX
                if (this.player.flipX) {
                    this.player.flipX = false;
                }
            } else if (this.cursors.up.isDown || this.wasd.up.isDown) {
                velocityY = -this.player.speed;
                this.player.facing = 'back';
                this.player.lastDirection = 'up';
                newAnimation = 'walk-back';
                // ä¸Šä¸‹ç§»åŠ¨ä¿æŒä¹‹å‰çš„å·¦å³æœå‘
            } else if (this.cursors.down.isDown || this.wasd.down.isDown) {
                velocityY = this.player.speed;
                this.player.facing = 'front';
                this.player.lastDirection = 'down';
                newAnimation = 'walk-front';
            }

            // æ’­æ”¾æˆ–åœæ­¢åŠ¨ç”»
            if (newAnimation && newAnimation !== this.player.currentAnimation) {
                this.player.anims.play(newAnimation, true);
                this.player.currentAnimation = newAnimation;
            } else if (!newAnimation && this.player.currentAnimation) {
                // åœæ­¢ç§»åŠ¨æ—¶åœæ­¢åŠ¨ç”»ï¼Œæ˜¾ç¤ºidleå¸§
                this.player.anims.stop();
                this.player.currentAnimation = null;

                // è®¾ç½®ä¸ºå¯¹åº”çš„idleçº¹ç†
                const idleTexture = `hero-idle-${this.player.facing}`;
                this.player.setTexture(idleTexture);
            }

            this.player.setVelocity(velocityX, velocityY);
        }

        // ============ æ•ŒäººAI ============
        const enemies = this.getEnemiesGroup();
        if (enemies && enemies.getChildren().length > 0) {
            enemies.getChildren().forEach(enemy => {
                // éªŒè¯æ•Œäººæ˜¯æ´»è·ƒçš„
                if (!enemy.active) return;

                const behavior = enemy.getData('behavior');
                const type = enemy.getData('type');
                let speed = enemy.getData('speed');
                let velocityX = 0;
                let velocityY = 0;

                // æ ¹æ®æ•Œäººç±»å‹åº”ç”¨ä¸åŒAIè¡Œä¸º
                if (behavior === 'flying' && type === 'bat') {
                    // è™è ï¼šé£è¡Œæ•Œäººï¼Œç§»åŠ¨é€Ÿåº¦æ›´å¿«ä¸”éš¾ä»¥é¢„æµ‹
                    const angle = Phaser.Math.Angle.Between(
                        enemy.x,
                        enemy.y,
                        this.player.x,
                        this.player.y
                    );

                    // è™è ä¼šé—´æ­‡æ€§åœ°æ”¹å˜æ–¹å‘ï¼ˆéš¾ä»¥å‘½ä¸­ï¼‰
                    if (!enemy.getData('lastDirectionChange') ||
                        this.time.now - enemy.getData('lastDirectionChange') > 1500) {
                        const randomOffset = (Math.random() - 0.5) * 1.5; // Â±75åº¦éšæœºåç§»
                        enemy.setData('directionOffset', randomOffset);
                        enemy.setData('lastDirectionChange', this.time.now);
                    }

                    const directionOffset = enemy.getData('directionOffset') || 0;
                    velocityX = Math.cos(angle + directionOffset) * speed;
                    velocityY = Math.sin(angle + directionOffset) * speed;

                    // è™è æœ‰æ—¶ä¼šå‘ä¸Šé£è¡Œï¼ˆåˆ©ç”¨å‚ç›´ç©ºé—´ï¼‰
                    if (enemy.getData('verticalMovement') && Math.random() < 0.02) {
                        velocityY -= speed * 0.5; // å‘ä¸Šå†²åˆº
                    }

                } else if (behavior === 'undead' && type === 'skeleton') {
                    // éª·é«…ï¼šç¼“æ…¢ä½†ç¨³å®šï¼Œä¼šç›´å†²å‘ç©å®¶
                    const angle = Phaser.Math.Angle.Between(
                        enemy.x,
                        enemy.y,
                        this.player.x,
                        this.player.y
                    );

                    // éª·é«…ç§»åŠ¨è¾ƒæ…¢ä½†ä¸ä¼šæ”¹å˜æ–¹å‘
                    velocityX = Math.cos(angle) * speed;
                    velocityY = Math.sin(angle) * speed;

                } else if (behavior === 'elite' && enemy.getData('isElite')) {
                    // ç²¾è‹±æ•Œäººï¼šæ ¹æ®ç‰¹æ®Šèƒ½åŠ›æœ‰ä¸åŒçš„è¡Œä¸º
                    const specialAbility = enemy.getData('specialAbility');
                    const angle = Phaser.Math.Angle.Between(
                        enemy.x,
                        enemy.y,
                        this.player.x,
                        this.player.y
                    );

                    if (specialAbility === 'burrow_ambush' && type === 'elite_mole_king') {
                        // å·¨å‹é¼¹é¼ ç‹ï¼šé—´æ­‡æ€§åŠ é€Ÿå†²é”‹
                        if (!enemy.getData('burrowState')) {
                            enemy.setData('burrowState', 'normal');
                            enemy.setData('lastBurrowTime', 0);
                        }

                        const timeSinceLastBurrow = this.time.now - enemy.getData('lastBurrowTime');
                        if (timeSinceLastBurrow > 8000 && enemy.getData('burrowState') === 'normal') {
                            // æ¯8ç§’å°è¯•é’»åœ°å†²é”‹
                            if (Math.random() < 0.3) {
                                enemy.setData('burrowState', 'burrowing');
                                enemy.setData('burrowStartTime', this.time.now);
                                enemy.setData('lastBurrowTime', this.time.now);
                            }
                        }

                        if (enemy.getData('burrowState') === 'burrowing') {
                            // é’»åœ°çŠ¶æ€ï¼šé€Ÿåº¦æå‡50%ï¼ŒæŒç»­2ç§’
                            const burrowDuration = this.time.now - enemy.getData('burrowStartTime');
                            if (burrowDuration < 2000) {
                                const boostSpeed = speed * 1.5;
                                velocityX = Math.cos(angle) * boostSpeed;
                                velocityY = Math.sin(angle) * boostSpeed;
                            } else {
                                enemy.setData('burrowState', 'normal');
                            }
                        } else {
                            // æ­£å¸¸è¿½è¸ª
                            velocityX = Math.cos(angle) * speed;
                            velocityY = Math.sin(angle) * speed;
                        }

                    } else if (specialAbility === 'root_bind_heal' && type === 'elite_ancient_treant') {
                        // è¿œå¤æ ‘å¦–ï¼šç¼“æ…¢ç§»åŠ¨ï¼Œå‘¨æœŸæ€§æ²»ç–—å‘¨å›´ç›Ÿå‹
                        if (!enemy.getData('healCooldown')) {
                            enemy.setData('healCooldown', 0);
                        }

                        // æ¯10ç§’å°è¯•æ²»ç–—é™„è¿‘ç›Ÿå‹
                        if (this.time.now - enemy.getData('healCooldown') > 10000) {
                            const nearbyAllies = this.getEnemiesGroup().getChildren().filter(e => {
                                return e.active && e !== enemy &&
                                    Phaser.Math.Distance.Between(e.x, e.y, enemy.x, enemy.y) < 150;
                            });

                            if (nearbyAllies.length > 0) {
                                // æ²»ç–—é™„è¿‘ç›Ÿå‹ï¼ˆæ¢å¤20% HPï¼‰
                                nearbyAllies.forEach(ally => {
                                    const currentHp = ally.getData('hp');
                                    const maxHp = ally.getData('maxHp');
                                    const healAmount = Math.floor(maxHp * 0.2);
                                    ally.setData('hp', Math.min(maxHp, currentHp + healAmount));
                                });
                                enemy.setData('healCooldown', this.time.now);
                                console.log(`ğŸŒ¿ è¿œå¤æ ‘å¦–æ²»ç–—äº† ${nearbyAllies.length} ä¸ªç›Ÿå‹`);
                            }
                        }

                        // ç§»åŠ¨ç¼“æ…¢
                        velocityX = Math.cos(angle) * speed;
                        velocityY = Math.sin(angle) * speed;

                    } else if (specialAbility === 'split_on_death' && type === 'elite_mutated_slime') {
                        // å˜å¼‚å²è±å§†ï¼šç§»åŠ¨é€Ÿåº¦é€‚ä¸­ï¼Œåœ¨æ­»äº¡æ—¶åˆ†è£‚ï¼ˆåœ¨å‡»æ€é€»è¾‘ä¸­å¤„ç†ï¼‰
                        velocityX = Math.cos(angle) * speed;
                        velocityY = Math.sin(angle) * speed;
                    } else {
                        // é»˜è®¤ç²¾è‹±è¡Œä¸º
                        velocityX = Math.cos(angle) * speed;
                        velocityY = Math.sin(angle) * speed;
                    }

                } else {
                    // é»˜è®¤AIï¼šç®€å•è¿½è¸ª
                    const angle = Phaser.Math.Angle.Between(
                        enemy.x,
                        enemy.y,
                        this.player.x,
                        this.player.y
                    );

                    velocityX = Math.cos(angle) * speed;
                    velocityY = Math.sin(angle) * speed;
                }

                enemy.setVelocity(velocityX, velocityY);

                // æ›´æ–°è¡€æ¡ä½ç½®è·Ÿéšæ•Œäºº
                if (enemy.hpBar && enemy.hpBarBg) {
                    enemy.hpBarBg.setPosition(enemy.x, enemy.y - 25);
                    enemy.hpBar.setPosition(enemy.x, enemy.y - 25);
                }

                // ç¢°æ’æ£€æµ‹ï¼šæ•Œäººç¢°åˆ°ç©å®¶
                // ç©å®¶å’Œæ•Œäººéƒ½æ˜¯32x32åŸºç¡€å°ºå¯¸ï¼Œscaleä¸º3ï¼Œå®é™…å°ºå¯¸ä¸º96x96
                // ç¢°æ’è·ç¦»è®¾ç½®ä¸º60ï¼Œç¡®ä¿ç²¾çµå®é™…æ¥è§¦æ—¶æ‰è§¦å‘ä¼¤å®³
                const collisionDistance = 60;
                const distance = Phaser.Math.Distance.Between(enemy.x, enemy.y, this.player.x, this.player.y);

                if (distance < collisionDistance) {
                    this.playerHitByEnemy(enemy);
                }
            });
        }

        // ============ Bossæ›´æ–° ============
        if (this.sceneManager && this.sceneManager.boss) {
            this.sceneManager.boss.update(this.time.now, this.game.loop.delta, this.player);
        }
    }

    playerHitByEnemy(enemy) {
        // åœºæ™¯åˆ‡æ¢æ—¶ä¸å—åˆ°ä¼¤å®³
        if (this.sceneManager?.isTransitioning) return;

        // éªŒè¯æ•Œäººå¯¹è±¡æœ‰æ•ˆ
        if (!enemy || !enemy.active) {
            return;
        }

        // æ£€æŸ¥æ•Œäººæ˜¯å¦åœ¨å†·å´ä¸­ï¼ˆé˜²æ­¢åŒä¸€æ•Œäººè¿ç»­ä¼¤å®³ï¼‰
        const now = this.time.now;
        const lastHitTime = enemy.getData('lastHitTime') || 0;
        const enemyCooldown = 1000; // æ•Œäººæ”»å‡»å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

        if (now - lastHitTime < enemyCooldown) {
            return; // è¯¥æ•Œäººè¿˜åœ¨å†·å´ä¸­
        }

        // æ£€æŸ¥ç©å®¶æ˜¯å¦å¤„äºæ— æ•ŒçŠ¶æ€
        if (this.player.getData('invincible')) {
            return;
        }

        // è®¡ç®—ä¼¤å®³
        const damage = enemy.getData('attack') || 5;
        const oldHp = this.player.hp;
        this.player.hp = Math.max(0, this.player.hp - damage);

        console.log(`ğŸ’” Player hit by ${enemy.getData('type')}! Damage: ${damage}, HP: ${oldHp} â†’ ${this.player.hp}`);

        // æ›´æ–°è¯¥æ•Œäººçš„æœ€åæ”»å‡»æ—¶é—´
        enemy.setData('lastHitTime', now);

        // æ˜¾ç¤ºä¼¤å®³æ•°å­—
        this.showDamageNumber(this.player.x, this.player.y, damage, '#ff4444');

        // è®¾ç½®ç©å®¶æ— æ•Œæ—¶é—´ï¼ˆè§†è§‰åé¦ˆ + é˜²æ­¢è¿ç»­å—ä¼¤ï¼‰
        this.player.setData('invincible', true);
        this.player.setAlpha(0.5);

        // å±å¹•éœ‡åŠ¨æ•ˆæœ
        this.cameras.main.shake(100, 0.01);

        this.time.delayedCall(1000, () => {
            this.player.setData('invincible', false);
            this.player.setAlpha(1);
        });

        // æ£€æŸ¥ç©å®¶æ˜¯å¦æ­»äº¡
        if (this.player.hp <= 0) {
            this.gameOver();
        }

        this.updateUI();
    }

    /**
     * æ£€æŸ¥æ˜¯å¦å­˜åœ¨å­˜æ¡£æ•°æ®
     */
    checkSaveData() {
        if (this.saveManager.hasSaveData()) {
            const saveInfo = this.saveManager.getSaveInfo();
            console.log('ğŸ“¦ å‘ç°å­˜æ¡£:', saveInfo);

            // æ˜¾ç¤ºåŠ è½½æç¤º
            this.time.delayedCall(1000, () => {
                this.showLoadPrompt(saveInfo);
            });
        }
    }

    /**
     * æ˜¾ç¤ºåŠ è½½æç¤ºå¯¹è¯æ¡†
     */
    showLoadPrompt(saveInfo) {
        const message = `å‘ç°å­˜æ¡£ï¼\nç­‰çº§: ${saveInfo.level}\nåœºæ™¯: ${saveInfo.scene}\næ—¶é—´: ${saveInfo.timestamp}\n\næŒ‰ Y åŠ è½½å­˜æ¡£\næŒ‰ N å¼€å§‹æ–°æ¸¸æˆ`;

        // åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
        const dialogBg = this.add.rectangle(400, 300, 600, 400, 0x222222);
        dialogBg.setStrokeStyle(3, 0x68d391);
        dialogBg.setDepth(100);

        // åˆ›å»ºå¯¹è¯æ¡†æ–‡å­—
        const dialogText = this.add.text(400, 300, message, {
            font: '16px Noto Sans SC',
            fill: '#ffffff',
            align: 'center',
            lineSpacing: 10
        }).setOrigin(0.5);
        dialogText.setDepth(101);

        // åˆ›å»ºä¸´æ—¶è¦†ç›–å±‚é˜»æ­¢è¾“å…¥
        const inputBlocker = this.add.rectangle(400, 300, 800, 600, 0x000000, 0);
        inputBlocker.setDepth(99);
        inputBlocker.setInteractive();

        // ç›‘å¬Yå’ŒNé”®
        const handleChoice = (event) => {
            if (event.keyCode === Phaser.Input.Keyboard.KeyCodes.Y) {
                // åŠ è½½å­˜æ¡£
                dialogBg.destroy();
                dialogText.destroy();
                inputBlocker.destroy();
                this.input.keyboard.off('keydown', handleChoice);
                this.loadGameWithDelay();
            } else if (event.keyCode === Phaser.Input.Keyboard.KeyCodes.N) {
                // å¼€å§‹æ–°æ¸¸æˆ
                dialogBg.destroy();
                dialogText.destroy();
                inputBlocker.destroy();
                this.input.keyboard.off('keydown', handleChoice);
                this.showFloatingText(400, 300, 'å¼€å§‹æ–°æ¸¸æˆ!', '#68d391');
            }
        };

        this.input.keyboard.on('keydown', handleChoice);

        // ç‚¹å‡»ä¹Ÿå¯å…³é—­ï¼ˆé€‰æ‹©ä¸åŠ è½½ï¼‰
        inputBlocker.on('pointerdown', () => {
            dialogBg.destroy();
            dialogText.destroy();
            inputBlocker.destroy();
            this.input.keyboard.off('keydown', handleChoice);
        });
    }

    /**
     * å»¶è¿ŸåŠ è½½æ¸¸æˆï¼ˆç­‰å¾…åœºæ™¯åˆå§‹åŒ–å®Œæˆï¼‰
     */
    loadGameWithDelay() {
        this.time.delayedCall(500, () => {
            this.saveManager.loadGame();
        });
    }

    /**
     * å¿«é€Ÿä¿å­˜æ¸¸æˆ
     */
    quickSave() {
        const success = this.saveManager.saveGame();
        if (success) {
            this.showFloatingText(400, 300, 'æ¸¸æˆå·²ä¿å­˜!', '#68d391');
        }
    }

    /**
     * å¿«é€ŸåŠ è½½æ¸¸æˆ
     */
    quickLoad() {
        if (!this.saveManager.hasSaveData()) {
            this.showFloatingText(400, 300, 'æœªæ‰¾åˆ°å­˜æ¡£!', '#ff6b6b');
            return;
        }

        this.saveManager.loadGame();
    }

    gameOver() {
        this.physics.pause();

        const gameOverText = this.add.text(400, 300, 'æ¸¸æˆç»“æŸ\nGAME OVER\n\næŒ‰Ré”®é‡æ–°å¼€å§‹', {
            fontFamily: 'Press Start 2P',
            fontSize: '28px',
            color: '#ff0000',
            stroke: '#000000',
            strokeThickness: 6,
            align: 'center'
        }).setOrigin(0.5);

        // é—ªçƒé‡å¯æç¤º
        this.tweens.add({
            targets: gameOverText,
            alpha: 0.5,
            duration: 500,
            yoyo: true,
            repeat: -1
        });

        // ç›‘å¬Ré”®é‡å¯
        this.restartKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.R);
        this.restartKey.on('down', () => {
            this.scene.restart();
        });

        console.log('ğŸ’€ æ¸¸æˆç»“æŸ');

        // è®°å½•æ¸¸æˆç»“æŸæ—¶çš„ç»Ÿè®¡
        const finalStats = this.getGameStats();
        console.log('ğŸ“Š æœ€ç»ˆç»Ÿè®¡:', finalStats);
    }

    /**
     * è·å–æ¸¸æˆç»Ÿè®¡ä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•å’Œæ˜¾ç¤ºï¼‰
     */
    getGameStats() {
        const enemies = this.getEnemiesGroup();
        return {
            player: {
                level: this.player.level,
                hp: this.player.hp,
                maxHp: this.player.maxHp,
                xp: this.player.xp,
                gold: this.player.gold,
                attack: this.player.attack,
                position: { x: Math.round(this.player.x), y: Math.round(this.player.y) }
            },
            scene: {
                current: this.sceneManager.getCurrentScene(),
                enemies: enemies ? enemies.getChildren().length : 0
            },
            quests: this.questManager ? {
                stats: this.questManager.getStats(),
                active: this.questManager.getActiveQuests().map(q => ({
                    id: q.id,
                    name: q.name,
                    progress: q.getProgress()
                }))
            } : null,
            saveData: this.saveManager.hasSaveData() ? 'exists' : 'none',
            timestamp: new Date().toISOString()
        };
    }

    /**
     * è°ƒè¯•æ–¹æ³•ï¼šå¼€å§‹ä»»åŠ¡
     * @param {string} questId - ä»»åŠ¡ID
     */
    debugStartQuest(questId) {
        if (!this.questManager) {
            console.error('âŒ QuestManageræœªåˆå§‹åŒ–');
            return false;
        }

        const success = this.questManager.startQuest(questId);
        if (success) {
            console.log(`âœ… ä»»åŠ¡å·²å¼€å§‹: ${questId}`);
        } else {
            console.log(`âŒ ä»»åŠ¡å¼€å§‹å¤±è´¥: ${questId}`);
        }
        return success;
    }

    /**
     * è°ƒè¯•æ–¹æ³•ï¼šæ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡çŠ¶æ€
     */
    debugShowQuests() {
        if (!this.questManager) {
            console.error('âŒ QuestManageræœªåˆå§‹åŒ–');
            return;
        }

        console.log('ğŸ“‹ ä»»åŠ¡çŠ¶æ€:');
        console.log('================');

        const stats = this.questManager.getStats();
        console.log(`æ€»è®¡: ${stats.total} | è¿›è¡Œä¸­: ${stats.active} | å·²å®Œæˆ: ${stats.completed} | å¯æ¥å—: ${stats.available}`);
        console.log('');

        const activeQuests = this.questManager.getActiveQuests();
        if (activeQuests.length > 0) {
            console.log('ğŸ”µ æ¿€æ´»çš„ä»»åŠ¡:');
            activeQuests.forEach(quest => {
                const objective = quest.getCurrentObjective();
                console.log(`  - ${quest.name}`);
                if (objective) {
                    console.log(`    ${objective.description}: ${objective.current}/${objective.required}`);
                }
            });
        }

        const completedQuests = this.questManager.getCompletedQuests();
        if (completedQuests.length > 0) {
            console.log('âœ… å·²å®Œæˆçš„ä»»åŠ¡:');
            completedQuests.forEach(quest => {
                console.log(`  - ${quest.name}`);
            });
        }
    }

    /**
     * æ˜¾ç¤ºæ¸¸æˆç»Ÿè®¡ä¿¡æ¯
     * å¯ä»¥åœ¨æµè§ˆå™¨æ§åˆ¶å°è°ƒç”¨: window.game.scene.scenes.find(s => s.scene.key === 'GameScene').showStatistics()
     */
    showStatistics() {
        if (!window.gameData) {
            console.error('âŒ gameDataæœªåˆå§‹åŒ–');
            return;
        }

        console.log('\nğŸ“Š ===== æ¸¸æˆç»Ÿè®¡ =====');
        console.log('====================\n');

        // ç©å®¶ä¿¡æ¯
        console.log('ğŸ‘¤ ç©å®¶ä¿¡æ¯:');
        console.log(`  ç­‰çº§: ${this.player.level}`);
        console.log(`  é‡‘å¸: ${this.player.gold}`);
        console.log(`  ç»éªŒ: ${this.player.xp}/${this.player.xpToNextLevel}`);
        console.log('');

        // æ¸¸æˆæ—¶é—´
        if (window.gameData.progress) {
            const playtimeSeconds = window.gameData.progress.playtimeSeconds || 0;
            const hours = Math.floor(playtimeSeconds / 3600);
            const minutes = Math.floor((playtimeSeconds % 3600) / 60);
            const seconds = playtimeSeconds % 60;

            console.log('â±ï¸ æ¸¸æˆæ—¶é—´:');
            if (hours > 0) {
                console.log(`  ${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ ${seconds}ç§’`);
            } else if (minutes > 0) {
                console.log(`  ${minutes}åˆ†é’Ÿ ${seconds}ç§’`);
            } else {
                console.log(`  ${seconds}ç§’`);
            }
            console.log('');
        }

        // å‡»è´¥ç»Ÿè®¡
        if (window.gameData.progress) {
            console.log('âš”ï¸ æˆ˜æ–—ç»Ÿè®¡:');
            console.log(`  æ€»å‡»è´¥æ•°: ${window.gameData.progress.enemiesDefeated || 0}`);
            console.log(`  æ”¶é›†é‡‘å¸: ${window.gameData.progress.totalCoins || 0}`);
            console.log(`  æ”¶é›†å®çŸ³: ${window.gameData.progress.gemsCollected || 0}`);
            console.log('');
        }

        // æ•Œäººç±»å‹ç»Ÿè®¡
        if (window.gameData.enemiesDefeated) {
            console.log('ğŸ’€ æ•Œäººå‡»è´¥è¯¦æƒ…:');
            const enemies = window.gameData.enemiesDefeated;
            let hasData = false;

            for (const [type, count] of Object.entries(enemies)) {
                if (count > 0) {
                    hasData = true;
                    const displayName = type.startsWith('boss_') ? `ğŸ‘‘ Boss(${type.replace('boss_', '')})` : type;
                    console.log(`  ${displayName}: ${count}`);
                }
            }

            if (!hasData) {
                console.log('  å°šæœªå‡»è´¥ä»»ä½•æ•Œäºº');
            }
            console.log('');
        }

        // ä»»åŠ¡ç»Ÿè®¡
        if (this.questManager) {
            const questStats = this.questManager.getStats();
            console.log('ğŸ“œ ä»»åŠ¡ç»Ÿè®¡:');
            console.log(`  æ€»è®¡: ${questStats.total}`);
            console.log(`  è¿›è¡Œä¸­: ${questStats.active}`);
            console.log(`  å·²å®Œæˆ: ${questStats.completed}`);
            console.log(`  å¯æ¥å—: ${questStats.available}`);
            console.log('');
        }

        // æˆå°±ç»Ÿè®¡
        if (this.achievementManager) {
            const achievements = this.achievementManager.getAchievements();
            const unlockedCount = achievements.filter(a => a.unlocked).length;
            console.log('ğŸ† æˆå°±ç»Ÿè®¡:');
            console.log(`  å·²è§£é”: ${unlockedCount}/${achievements.length}`);
            console.log('');
        }

        console.log('====================');
        console.log('ğŸ“Š ç»Ÿè®¡ç»“æŸ\n');

        // åŒæ—¶åœ¨æ¸¸æˆä¸­æ˜¾ç¤ºç®€è¦ç»Ÿè®¡
        this.showFloatingText(400, 200, 'ğŸ“Š ç»Ÿè®¡å·²æ˜¾ç¤ºåœ¨æ§åˆ¶å°', '#68d391', 3000);
    }

    /**
     * æ›´æ–°å¾ªç¯ï¼ˆæ¯å¸§è°ƒç”¨ï¼‰
     * @param {number} time - å½“å‰æ—¶é—´
     * @param {number} delta - è·ç¦»ä¸Šä¸€å¸§çš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     */
    update(time, delta) {
        // ============ æ€§èƒ½ä¼˜åŒ–ï¼šæ¯ç§’æ›´æ–°ä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯ ============
        if (window.gameData && window.gameData.progress && window.gameData.progress.sessionStartTime) {
            const now = Date.now();
            // åªåœ¨è·ç¦»ä¸Šæ¬¡æ›´æ–°è¶…è¿‡1000msæ—¶æ›´æ–°ï¼ˆèŠ‚æµï¼‰
            if (now - window.gameData.progress.lastPlaytimeUpdate >= 1000) {
                const elapsedSeconds = Math.floor((now - window.gameData.progress.sessionStartTime) / 1000);
                window.gameData.progress.playtimeSeconds = elapsedSeconds;
                window.gameData.progress.lastPlaytimeUpdate = now;
            }
        }
    }

    /**
     * åœºæ™¯é”€æ¯æ—¶æ¸…ç†èµ„æº
     * é˜²æ­¢å†…å­˜æ³„æ¼
     */
    destroy() {
        console.log('ğŸ§¹ æ¸…ç† GameScene èµ„æº');

        // æ¸…ç†ç¼“å­˜çš„DOMå…ƒç´ å¼•ç”¨
        this.cachedDOMElements = null;
        this.lastUIValues = null;

        // æ¸…ç†UIå¼•ç”¨
        if (this.sceneNameText) {
            this.sceneNameText.destroy();
            this.sceneNameText = null;
        }

        // æ¸…ç†äº‹ä»¶ç›‘å¬
        if (this.questManager) {
            this.events.off('questStarted');
            this.events.off('questCompleted');
            this.events.off('questUpdated');
            this.events.off('bossDefeated');
        }

        console.log('âœ… GameScene èµ„æºå·²æ¸…ç†');
    }
