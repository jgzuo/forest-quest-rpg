<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Quest RPG - è‡ªåŠ¨åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            margin: 0;
        }
        #test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #68d391;
            border-bottom: 2px solid #68d391;
            padding-bottom: 10px;
        }
        .test-group {
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border-left: 4px solid #4facfe;
        }
        .test-group h2 {
            margin-top: 0;
            color: #4facfe;
            font-size: 18px;
        }
        .test-item {
            padding: 8px 15px;
            margin: 5px 0;
            background: #0f3460;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }
        .test-item.pass {
            border-left: 4px solid #68d391;
        }
        .test-item.fail {
            border-left: 4px solid #ff6b6b;
        }
        .status-icon {
            font-size: 20px;
            margin-right: 10px;
        }
        .test-name {
            flex: 1;
        }
        .test-details {
            color: #aaa;
            font-size: 14px;
        }
        #summary {
            background: #1e5128;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        #bug-report {
            background: #7f1d1d;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        #bug-report.show {
            display: block;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #0f3460;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #68d391, #4facfe);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        button {
            background: #4facfe;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #3a9bd9;
        }
        #game-frame {
            border: 2px solid #4facfe;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div id="test-container">
        <h1>ğŸ® Forest Quest RPG - è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶</h1>

        <div id="controls">
            <button onclick="startTest()">â–¶ï¸ å¼€å§‹æµ‹è¯•</button>
            <button onclick="loadGame()">ğŸ“¦ åŠ è½½æ¸¸æˆ</button>
            <button onclick="runMovementTest()">ğŸƒ ç§»åŠ¨æµ‹è¯•</button>
            <button onclick="checkPlayerCount()">ğŸ” æ£€æŸ¥ç©å®¶æ•°é‡</button>
            <button onclick="exportResults()">ğŸ“„ å¯¼å‡ºç»“æœ</button>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress" style="width: 0%">0%</div>
        </div>

        <div id="summary" style="display: none;">
            <h2>æµ‹è¯•æ€»ç»“</h2>
            <div id="summary-content"></div>
        </div>

        <div id="bug-report">
            <h2>ğŸ› å‘ç°ä¸¥é‡Bugï¼</h2>
            <div id="bug-details"></div>
        </div>

        <div id="test-results"></div>

        <iframe id="game-frame" width="800" height="650" style="display: none;"></iframe>
    </div>

    <script>
        const testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            tests: [],
            startTime: null,
            endTime: null
        };

        let gameWindow = null;
        let gameDoc = null;

        function log(message, isSubMessage = false) {
            const consoleDiv = document.createElement('div');
            consoleDiv.style.padding = isSubMessage ? '5px 0 5px 20px' : '10px 0';
            consoleDiv.style.borderLeft = isSubMessage ? '2px solid #666' : '3px solid #4facfe';
            consoleDiv.style.paddingLeft = '15px';
            consoleDiv.style.margin = '5px 0';
            consoleDiv.style.color = '#ccc';
            consoleDiv.textContent = message;
            document.getElementById('test-results').appendChild(consoleDiv);
        }

        function addTest(groupName, testName, passed, details = '') {
            const group = document.getElementById(`group-${groupName}`) || createTestGroup(groupName);
            const item = document.createElement('div');
            item.className = `test-item ${passed ? 'pass' : 'fail'}`;
            item.innerHTML = `
                <span class="status-icon">${passed ? 'âœ…' : 'âŒ'}</span>
                <span class="test-name">${testName}</span>
                ${details ? `<span class="test-details">${details}</span>` : ''}
            `;
            group.appendChild(item);

            testResults.total++;
            if (passed) testResults.passed++;
            else testResults.failed++;

            testResults.tests.push({ group: groupName, name: testName, passed, details });
            updateProgress();
        }

        function createTestGroup(groupName) {
            const group = document.createElement('div');
            group.className = 'test-group';
            group.id = `group-${groupName}`;
            group.innerHTML = `<h2>${groupName}</h2>`;
            document.getElementById('test-results').appendChild(group);
            return group;
        }

        function updateProgress() {
            const total = testResults.total;
            const passed = testResults.passed;
            const percentage = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            document.getElementById('progress').style.width = `${percentage}%`;
            document.getElementById('progress').textContent = `${percentage}%`;

            document.getElementById('summary').style.display = 'block';
            document.getElementById('summary-content').innerHTML = `
                <p><strong>æ€»æµ‹è¯•:</strong> ${total}</p>
                <p><strong>âœ… é€šè¿‡:</strong> ${passed}</p>
                <p><strong>âŒ å¤±è´¥:</strong> ${testResults.failed}</p>
                <p><strong>ğŸ“ˆ é€šè¿‡ç‡:</strong> ${percentage}%</p>
            `;
        }

        async function loadGame() {
            log('æ­£åœ¨åŠ è½½æ¸¸æˆ...');
            const iframe = document.getElementById('game-frame');
            iframe.style.display = 'block';
            iframe.src = 'http://127.0.0.1:55573/index.html';

            return new Promise((resolve) => {
                iframe.onload = () => {
                    try {
                        gameWindow = iframe.contentWindow;
                        gameDoc = iframe.contentDocument;
                        log('âœ… æ¸¸æˆåŠ è½½æˆåŠŸ');

                        // ç­‰å¾…Phaseråˆå§‹åŒ–
                        setTimeout(() => {
                            if (gameWindow.game) {
                                log('âœ… Phaserå¼•æ“å·²åˆå§‹åŒ–');
                                resolve(true);
                            } else {
                                log('âŒ Phaserå¼•æ“æœªåˆå§‹åŒ–');
                                resolve(false);
                            }
                        }, 2000);
                    } catch (e) {
                        log(`âŒ åŠ è½½å¤±è´¥: ${e.message}`);
                        resolve(false);
                    }
                };
            });
        }

        function checkPlayerCount() {
            if (!gameWindow || !gameWindow.game) {
                log('âŒ è¯·å…ˆåŠ è½½æ¸¸æˆ');
                return;
            }

            log('ğŸ” æ£€æŸ¥ç©å®¶å¯¹è±¡æ•°é‡...');

            try {
                const scene = gameWindow.game.scene.scenes[0];
                if (!scene || !scene.player) {
                    log('âŒ ç©å®¶å¯¹è±¡ä¸å­˜åœ¨');
                    addTest('ç©å®¶æ£€æŸ¥', 'ç©å®¶å¯¹è±¡å­˜åœ¨', false);
                    return;
                }

                // è®¡ç®—ç©å®¶å¼•ç”¨
                let playerCount = 0;
                let playerPosition = null;
                scene.children.each((child) => {
                    if (child === scene.player) {
                        playerCount++;
                        if (!playerPosition) {
                            playerPosition = { x: child.x, y: child.y };
                        }
                    }
                });

                log(`ğŸ“Š å‘ç° ${playerCount} ä¸ªç©å®¶å¯¹è±¡å¼•ç”¨`);
                addTest('ç©å®¶æ£€æŸ¥', 'ç©å®¶å¯¹è±¡å”¯ä¸€', playerCount === 1,
                    `å‘ç° ${playerCount} ä¸ªå¼•ç”¨`);

                if (playerCount > 1) {
                    showBugReport(playerCount);
                } else {
                    document.getElementById('bug-report').classList.remove('show');
                }

                // æ£€æŸ¥ç©å®¶å±æ€§
                if (scene.player) {
                    addTest('ç©å®¶æ£€æŸ¥', 'ç©å®¶æœ‰HPå±æ€§',
                        typeof scene.player.hp === 'number',
                        `HP: ${scene.player.hp}`);
                    addTest('ç©å®¶æ£€æŸ¥', 'ç©å®¶æœ‰é€Ÿåº¦å±æ€§',
                        typeof scene.player.speed === 'number',
                        `é€Ÿåº¦: ${scene.player.speed}`);
                }

            } catch (e) {
                log(`âŒ æ£€æŸ¥å¤±è´¥: ${e.message}`);
                addTest('ç©å®¶æ£€æŸ¥', 'ç©å®¶æ•°é‡æ£€æŸ¥', false, e.message);
            }
        }

        function showBugReport(count) {
            const report = document.getElementById('bug-report');
            report.classList.add('show');
            document.getElementById('bug-details').innerHTML = `
                <p><strong>å‘ç° ${count} ä¸ªç©å®¶å¯¹è±¡å¼•ç”¨ï¼</strong></p>
                <p>è¿™ä¼šå¯¼è‡´ç§»åŠ¨æ—¶å‡ºç°å¤šä¸ªä¸»è§’çš„é—®é¢˜ã€‚</p>
                <h3>å¯èƒ½çš„åŸå› :</h3>
                <ul>
                    <li>GameScene.create() é‡å¤è°ƒç”¨ createPlayer()</li>
                    <li>SceneManager åˆ‡æ¢åœºæ™¯æ—¶æœªæ­£ç¡®æ¸…ç†æ—§ç©å®¶</li>
                    <li>åŠ¨ç”»åˆ‡æ¢æ—¶é”™è¯¯åˆ›å»ºäº†æ–°ç²¾çµ</li>
                    <li>update() å‡½æ•°ä¸­é‡å¤åˆ›å»ºå¯¹è±¡</li>
                </ul>
                <h3>å»ºè®®ä¿®å¤:</h3>
                <ol>
                    <li>ç¡®ä¿ createPlayer() åªè¢«è°ƒç”¨ä¸€æ¬¡</li>
                    <li>æ£€æŸ¥ cleanupScene() æ˜¯å¦æ­£ç¡®ä¿ç•™ç©å®¶å¼•ç”¨</li>
                    <li>ä½¿ç”¨ setTexture() è€Œä¸æ˜¯åˆ›å»ºæ–°ç²¾çµ</li>
                    <li>åœ¨ update() ä¸­åªä¿®æ”¹å±æ€§ï¼Œä¸åˆ›å»ºæ–°å¯¹è±¡</li>
                </ol>
            `;
        }

        async function runMovementTest() {
            if (!gameWindow || !gameWindow.game) {
                log('âŒ è¯·å…ˆåŠ è½½æ¸¸æˆ');
                return;
            }

            log('ğŸƒ å¼€å§‹ç§»åŠ¨æµ‹è¯•...');

            try {
                const scene = gameWindow.game.scene.scenes[0];
                if (!scene.player) {
                    log('âŒ ç©å®¶ä¸å­˜åœ¨');
                    return;
                }

                // è®°å½•åˆå§‹ä½ç½®
                const initialX = scene.player.x;
                const initialY = scene.player.y;
                log(`ğŸ“ åˆå§‹ä½ç½®: (${initialX}, ${initialY})`);

                // æ¨¡æ‹Ÿé”®ç›˜äº‹ä»¶
                const keyDownEvent = new KeyboardEvent('keydown', { key: 'w', keyCode: 87 });
                const keyUpEvent = new KeyboardEvent('keyup', { key: 'w', keyCode: 87 });

                gameWindow.dispatchEvent(keyDownEvent);

                // ç­‰å¾…ç§»åŠ¨
                await new Promise(r => setTimeout(r, 500));

                gameWindow.dispatchEvent(keyUpEvent);

                // å†ç­‰å¾…ç‰©ç†æ›´æ–°
                await new Promise(r => setTimeout(r, 200));

                const newX = scene.player.x;
                const newY = scene.player.y;
                log(`ğŸ“ ç§»åŠ¨åä½ç½®: (${newX}, ${newY})`);

                const moved = newY !== initialY;
                addTest('ç§»åŠ¨æµ‹è¯•', 'ç©å®¶å¯ä»¥ç§»åŠ¨', moved,
                    `ä» ${initialY} åˆ° ${newY}`);

                // ç§»åŠ¨åå†æ¬¡æ£€æŸ¥ç©å®¶æ•°é‡
                checkPlayerCount();

            } catch (e) {
                log(`âŒ ç§»åŠ¨æµ‹è¯•å¤±è´¥: ${e.message}`);
                addTest('ç§»åŠ¨æµ‹è¯•', 'ç§»åŠ¨åŠŸèƒ½', false, e.message);
            }
        }

        async function startTest() {
            testResults.total = 0;
            testResults.passed = 0;
            testResults.failed = 0;
            testResults.tests = [];
            testResults.startTime = new Date();
            document.getElementById('test-results').innerHTML = '';

            log('ğŸ® å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶...');
            log('='.repeat(60));

            // 1. åŠ è½½æ¸¸æˆ
            log('\nğŸ“‹ æµ‹è¯•ç»„1: æ¸¸æˆåŠ è½½');
            const loaded = await loadGame();
            addTest('æ¸¸æˆåŠ è½½', 'æ¸¸æˆæˆåŠŸåŠ è½½', loaded);

            await new Promise(r => setTimeout(r, 3000));

            // 2. æ£€æŸ¥Phaser
            log('\nğŸ“‹ æµ‹è¯•ç»„2: å¼•æ“åˆå§‹åŒ–');
            if (gameWindow && gameWindow.game) {
                addTest('å¼•æ“æ£€æŸ¥', 'Phaserå®ä¾‹å­˜åœ¨', true);
                addTest('å¼•æ“æ£€æŸ¥', 'åœºæ™¯å·²åˆ›å»º',
                    gameWindow.game.scene.scenes.length > 0,
                    `${gameWindow.game.scene.scenes.length} ä¸ªåœºæ™¯`);

                // 3. æ£€æŸ¥çº¹ç†
                log('\nğŸ“‹ æµ‹è¯•ç»„3: èµ„æºåŠ è½½');
                const textures = [];
                gameWindow.game.textures.each((tex, key) => textures.push(key));

                const requiredTextures = [
                    'hero-idle-front',
                    'mole-idle-front',
                    'treant-idle-front',
                    'gem',
                    'coin'
                ];

                requiredTextures.forEach(tex => {
                    const exists = textures.includes(tex);
                    addTest('èµ„æºæ£€æŸ¥', `çº¹ç† ${tex}`, exists);
                });

                // 4. æ£€æŸ¥ç©å®¶
                log('\nğŸ“‹ æµ‹è¯•ç»„4: ç©å®¶å¯¹è±¡');
                checkPlayerCount();

                // 5. æ£€æŸ¥åœºæ™¯å¯¹è±¡
                log('\nğŸ“‹ æµ‹è¯•ç»„5: åœºæ™¯å¯¹è±¡');
                const scene = gameWindow.game.scene.scenes[0];
                let npcCount = 0;
                let chestCount = 0;
                let enemyCount = 0;

                scene.children.each((child) => {
                    const type = child.getData && child.getData('type');
                    if (type === 'npc') npcCount++;
                    if (type === 'chest') chestCount++;
                    if (child.texture && child.texture.key.includes('mole')) enemyCount++;
                    if (child.texture && child.texture.key.includes('treant')) enemyCount++;
                });

                addTest('åœºæ™¯å¯¹è±¡', 'NPCå­˜åœ¨', npcCount > 0, `${npcCount} ä¸ªNPC`);
                addTest('åœºæ™¯å¯¹è±¡', 'å®ç®±å­˜åœ¨', chestCount > 0, `${chestCount} ä¸ªå®ç®±`);
                addTest('åœºæ™¯å¯¹è±¡', 'æ•Œäººå­˜åœ¨', enemyCount > 0, `${enemyCount} ä¸ªæ•Œäºº`);

                // 6. æ£€æŸ¥ç®¡ç†å™¨
                log('\nğŸ“‹ æµ‹è¯•ç»„6: ç³»ç»Ÿç»„ä»¶');
                addTest('ç»„ä»¶æ£€æŸ¥', 'SaveManagerå­˜åœ¨', !!scene.saveManager);
                addTest('ç»„ä»¶æ£€æŸ¥', 'SceneManagerå­˜åœ¨', !!scene.sceneManager);
                addTest('ç»„ä»¶æ£€æŸ¥', 'ShopManagerå­˜åœ¨', !!scene.shopManager);
                addTest('ç»„ä»¶æ£€æŸ¥', 'æ•Œäººç»„å­˜åœ¨', !!scene.enemies);

                // 7. ç§»åŠ¨æµ‹è¯•
                log('\nğŸ“‹ æµ‹è¯•ç»„7: ç©å®¶ç§»åŠ¨');
                await runMovementTest();

            } else {
                addTest('å¼•æ“æ£€æŸ¥', 'Phaserå®ä¾‹å­˜åœ¨', false);
            }

            testResults.endTime = new Date();
            const duration = ((testResults.endTime - testResults.startTime) / 1000).toFixed(2);
            log(`\nâœ… æµ‹è¯•å®Œæˆï¼è€—æ—¶: ${duration}ç§’`);
            log('='.repeat(60));
        }

        function exportResults() {
            const dataStr = JSON.stringify(testResults, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = `test_results_${new Date().getTime()}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // é¡µé¢åŠ è½½å®Œæˆåæç¤º
        window.onload = () => {
            log('ğŸ® æµ‹è¯•å¥—ä»¶å·²å°±ç»ª');
            log('ğŸ’¡ ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•');
            log('ğŸ’¡ æˆ–è€…åˆ†æ­¥éª¤æ‰§è¡Œ: åŠ è½½æ¸¸æˆ â†’ æ£€æŸ¥ç©å®¶ â†’ ç§»åŠ¨æµ‹è¯•');
        };
    </script>
</body>
</html>
